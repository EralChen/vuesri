import{u as _}from"./chunk-OMr8FG4E.js";import{u as x}from"./chunk-KdgvZLtn.js";import{V as k}from"./chunk-llSqPPQp.js";import{c as d}from"./chunk-3E9jM2aR.js";import{c as h}from"./chunk-TReN2ucZ.js";import{V as F}from"./chunk-PqXAlAeV.js";import{gs as U,o1 as C,gE as E,kX as G,gt as f,pR as L,l4 as y,nK as M,l6 as $,gF as v,gv as p,gw as V,gz as b,gG as B,gL as R,nM as T,l9 as H,gC as K}from"./chunk-ERvgPDZ8.js";import{i as S}from"./chunk-1lYY77mG.js";const P={query:{type:Object,default:{}},visible:{type:Boolean,default:void 0},maxScale:{type:Number,default:0},minScale:{type:Number,default:0},queryExtent:{type:Boolean,default:!1}},j={"update:visible":e=>typeof e=="boolean",load:e=>e,change:e=>e},q=Symbol("key"),N=U({name:"VaFeaturePopupLayer",components:{VaGeoViewUi:k,VaViewUi:F},inheritAttrs:!1,props:P,emits:j,setup(e,{emit:u}){const o=_(),n=x(),c=h(o[d]),s=C({default:S(o.scale,{maxScale:e.maxScale,minScale:e.minScale}),key:"visible"},e,u),l=E([]),a=G({}),r=async()=>{if(s.value)return await o.when(),n.queryFeatures({returnGeometry:!0,outFields:["*"],where:"1=1",geometry:a.current,outSpatialReference:o.spatialReference,...e.query}).then(t=>(l.value=t.features.map(i=>(i[q]=i.attributes[n.objectIdField],i)),a.queried=a.current,t))};r().then(t=>{u("load",{featureSet:t,view:o,layer:n})}),f(()=>s.value,t=>{t&&(a.current=a.view,r())}),f(()=>({geometry:a.current,...e.query}),async()=>{await r().then(t=>{u("change",{featureSet:t,view:o,layer:n})})}),L(()=>a.view,async t=>{if(t&&s.value){if(!a.queried){a.current=t;return}a.queried.contains(t)||(a.current=a.queried.union(t).clone())}},{throttle:1e3});const g=new c("watch:scale",([t])=>{s.value=S(t,{maxScale:e.maxScale,minScale:e.minScale})});g.add(),y(()=>{g.remove()});const m=new c("watch:extent",([t])=>{a.view=t});if(f(()=>e.queryExtent,()=>{e.queryExtent?m.add():m.remove()},{immediate:!0}),y(()=>{m.remove()}),n[d]){const t=h(n[d]),i=new t("change",async()=>{l.value=[],await M(),await r()});i.add(),y(()=>{i.remove()})}return{visible:s,features:l,layer:n,sKey:q}}});function z(e,u,o,n,c,s){const l=v("VaGeoViewUi"),a=v("VaViewUi");return p(),V(a,{class:"feature-popup-layer"},{default:b(()=>[(p(!0),B(R,null,T(e.features,r=>(p(),V(l,H(e.$attrs,{key:r[e.sKey],class:"feature-popup-layer__item",visible:e.visible,geometry:r.geometry,orphan:!0}),{default:b(()=>[K(e.$slots,"default",{attributes:r?.attributes??{},geometry:r.geometry})]),_:2},1040,["visible","geometry"]))),128))]),_:3})}const w=$(N,[["render",z]]);w.install=e=>{e.component(w.name,w)};export{w as V};
