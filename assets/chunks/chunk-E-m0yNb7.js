import{f1 as Y,eZ as D,nl as q,nm as j,nn as K,no as W,np as P,nq as Z,nr as J,G as X,aH as g,mv as C,hw as z,hi as R,ns as _,aM as I,nt as ee,eU as te,cO as se,P as ie,nu as u,ah as re,lh as ae,ad as w,b2 as le,ai as U,L as F,eX as V,J as ne,nv as oe,_ as N,$ as he,a1 as de}from"./chunk-217NDGZJ.js";import{i as ce,e as ue,l as _e,t as ye,u as pe}from"./chunk-ZE_bH_9k.js";import{i as fe}from"./chunk-Qt_3gzbL.js";import{l as O}from"./chunk-7dwZSQU4.js";import"./chunk-oVLQlo07.js";import"./chunk-pT1ASav_.js";import"./chunk-l7Jh2xoW.js";import"./chunk-CEMOhUyj.js";const $=512,me=1e-6,ge=(i,e)=>i+1/(1<<2*e);class Te{constructor(e,t){this._tiles=new Map,this._tileCache=new Y(40,s=>s.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=t}destroy(){for(const[e,t]of this._tiles)t.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const t=this.tileInfoView,s=t.getTileCoverage(e.state,0,!0,"smallest");if(!s)return!0;const{spans:r,lodInfo:a}=s,{level:n}=a,l=this._tiles,d=new Set,o=new Set;for(const{row:h,colFrom:c,colTo:b}of r)for(let f=c;f<=b;f++){const m=D.getId(n,h,a.normalizeCol(f),a.getWorldForColumn(f)),y=this._getOrAcquireTile(m);d.add(m),y.processed()?this._addToContainer(y):o.add(new D(m))}for(const[h,c]of l)c.isCoverage=d.has(h);for(const h of o)this._findPlaceholdersForMissingTiles(h,d);let S=!1;for(const[h,c]of l)c.neededForCoverage=d.has(h),c.neededForCoverage||c.isHoldingForFade&&t.intersects(s,c.key)&&d.add(h),c.isFading&&(S=!0);for(const[h,c]of this._tiles)d.has(h)||this._releaseTile(h);return q.pool.release(s),!S}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(e,t){const s=[];for(const[a,n]of this._tiles)this._addPlaceholderChild(s,n,e,t);const r=s.reduce(ge,0);Math.abs(1-r)<me||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,s,r){t.key.level<=s.level||!t.hasData()||Ce(s,t.key)&&(this._addToContainer(t),r.add(t.id),e.push(t.key.level-s.level))}_addPlaceholderParent(e,t){const s=this._tiles;let r=e;for(;;){if(r=ve(r),!r||t.has(r))return;const a=s.get(r);if(a&&a.hasData())return this._addToContainer(a),void t.add(a.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||(t=this._tileCache.pop(e),t||(t=this.acquireTile(new D(e))),this._tiles.set(e,t),t)}_releaseTile(e){const t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t;const s=[],r=this._container;if(r.contains(e))return;const a=this._visibleTiles;for(const[n,l]of a)this._canConnectDirectly(e,l)&&s.push(l),t==null&&this._canConnectDirectly(l,e)&&(t=l);if(t!=null){for(const n of s)t.childrenTiles.delete(n),e.childrenTiles.add(n),n.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(const n of s)e.childrenTiles.add(n),n.parentTile=e;a.set(e.id,e),r.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),e.parentTile!=null){e.parentTile.childrenTiles.delete(e);for(const t of e.childrenTiles)e.parentTile!=null&&e.parentTile.childrenTiles.add(t)}for(const t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){const s=e.key;let{level:r,row:a,col:n,world:l}=t.key;const d=this._visibleTiles;for(;r>0;){if(r--,a>>=1,n>>=1,s.level===r&&s.row===a&&s.col===n&&s.world===l)return!0;if(d.has(`${r}/${a}/${n}/${l}`))return!1}return!1}_updateCacheSize(e){const t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;const s=Math.ceil(t[0]/$)+1,r=Math.ceil(t[1]/$)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*s*r}}function ve(i){const[e,t,s,r]=i.split("/"),a=parseInt(e,10);return a===0?null:`${a-1}/${parseInt(t,10)>>1}/${parseInt(s,10)>>1}/${parseInt(r,10)}`}function Ce(i,e){const t=e.level-i.level;return i.row===e.row>>t&&i.col===e.col>>t&&i.world===e.world}const be=.5,B=1e-6;class we{constructor(e,t){this.styleRepository=e,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._fading=j(!1),this._symbolRepository=new ce(4096,t,()=>new K),this._symbolDeclutterer=new ue(t,this._symbolRepository,(s,r,a)=>new _e(s,r,a,this.styleRepository,this._zoom,this._viewState.rotation),(s,r)=>{s.allSymbolsFadingOut=!0,s.lastOpacityUpdate=r,W(s,r,!0),s.decluttered=!0,s.requestRender()},(s,r)=>this.styleRepository.getStyleLayerByUID(s.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(r.styleLayerUID).z,s=>{const r=this.styleRepository.getStyleLayerByUID(s);if(this._zoom+B<r.minzoom||this._zoom-B>=r.maxzoom)return!1;const a=r.getLayoutProperty("visibility");return!a||a.getValue()!==P.NONE})}get fading(){return this._fading.value}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.add(e),this.restartDeclutter()})),this._symbolRepository.add(e),this.restartDeclutter()}removeTile(e){const t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(Z),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){this._stableNotificationHandle!=null&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},(1+be)*J)}_notifyUnstable(){this._stableNotificationHandle!=null&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}}const E=1e-6;function Q(i,e){if(i){const t=i.getLayoutProperty("visibility");if(!t||t.getValue()!==P.NONE&&(i.minzoom===void 0||i.minzoom<e+E)&&(i.maxzoom===void 0||i.maxzoom>=e-E))return!0}return!1}class Se extends fe{constructor(e){super(e),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,this._symbolFader!=null&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}get fading(){return this._symbolFader?.fading??!1}setStyleResources(e,t,s){this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=s,this._symbolFader==null&&(this._symbolFader=new we(this._styleRepository,this.children)),this._symbolFader.styleRepository=s}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){this._symbolFader!=null&&this._symbolFader.deleteStyleLayers(e)}async hitTest(e){const t=X();return this._pointToCallbacks.set(e,t),this.requestRender(),t.promise}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==g.MAP&&e.drawPhase!==g.DEBUG||this._spriteMosaic===void 0||super.doRender(e)}addChild(e){return super.addChild(e),this._symbolFader!=null?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return this._symbolFader!=null&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;if(t!==g.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=g.HITTEST;const s=e.painter.effects.hittestVTL;s.bind(e),this._doRender(e),s.draw(e,this._pointToCallbacks),s.unbind(e),e.drawPhase=t}}else super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];this._symbolFader!=null&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(e=>e.neededForCoverage&&e.hasData())}restartDeclutter(){this._symbolFader!=null&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t}=e,s=this._styleRepository;if(!s)return;const r=s.layers;let a=!0;e.drawPhase===g.HITTEST&&(a=!1),s.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,s.backgroundBucketIds)),super.renderChildren(e),e.drawPhase===g.MAP&&this._fade(e.displayLevel,e.state);const n=this.children.filter(l=>l.visible&&l.hasData());if(!n||n.length===0)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const l of n)l.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(C.KEEP,C.KEEP,C.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(z.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let l=r.length-1;l>=0;l--)this._renderStyleLayer(r[l],e,n);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(a),t.setBlendFunctionSeparate(R.ONE,R.ONE_MINUS_SRC_ALPHA,R.ONE,R.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let l=0;l<r.length;l++)this._renderStyleLayer(r[l],e,n);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0)}_fade(e,t){this._symbolFader!=null&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,s){const{painter:r,renderPass:a}=t;if(e===void 0)return;const n=e.getLayoutProperty("visibility");if(n&&n.getValue()===P.NONE)return;let l;switch(e.type){case _.BACKGROUND:return;case _.FILL:if(a!=="opaque"&&t.renderPass!=="translucent")return;l="vtlFill";break;case _.LINE:if(a!=="translucent")return;l="vtlLine";break;case _.CIRCLE:if(a!=="translucent")return;l="vtlCircle";break;case _.SYMBOL:if(a!=="translucent")return;l="vtlSymbol"}if(s=e.type===_.SYMBOL?s.filter(o=>o.decluttered):s.filter(o=>o.neededForCoverage),l!=="vtlSymbol"){const o=t.displayLevel;if(s.length===0||e.minzoom!==void 0&&e.minzoom>=o+E||e.maxzoom!==void 0&&e.maxzoom<o-E)return}const d=e.uid;t.styleLayerUID=d,t.styleLayer=e;for(const o of s)if(o.layerData.has(d)){r.renderObjects(t,s,l);break}}_renderBackgroundLayers(e,t){const{context:s,displayLevel:r,painter:a,state:n}=e,l=this._styleRepository;let d=!1;for(const p of t)if(l.getLayerById(p).type===_.BACKGROUND&&Q(l.getLayerById(p),r)){d=!0;break}if(!d)return;const o=this._tileInfoView.getTileCoverage(e.state,0,!0,"smallest"),{spans:S,lodInfo:h}=o,{level:c}=h,b=I(),f=[];if(this._renderPasses){const p=this._renderPasses[0];this._clippingInfos!=null&&(p.brushes[0].prepareState(e),p.brushes[0].drawMany(e,this._clippingInfos))}const m=this._backgroundTiles;let y,H=0;for(const{row:p,colFrom:T,colTo:x}of S)for(let v=T;v<=x;v++){if(H<m.length)y=m[H],y.key.set(c,p,h.normalizeCol(v),h.getWorldForColumn(v)),this._tileInfoView.getTileBounds(b,y.key,!1),y.x=b[0],y.y=b[3],y.resolution=this._tileInfoView.getTileResolution(c);else{const M=new D(c,p,h.normalizeCol(v),h.getWorldForColumn(v)),k=this._tileInfoView.getTileBounds(I(),M),G=this._tileInfoView.getTileResolution(c);y=new ee(M,G,k[0],k[3],512,512,4096,4096),m.push(y)}y.setTransform(n),f.push(y),H++}s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(C.KEEP,C.KEEP,C.REPLACE),s.setStencilFunction(z.EQUAL,0,255);let A=!0;e.drawPhase===g.HITTEST&&(A=!1),s.setStencilTestEnabled(A);for(const p of t){const T=l.getLayerById(p);T.type===_.BACKGROUND&&Q(T,r)&&(e.styleLayerUID=T.uid,e.styleLayer=T,a.renderObjects(e,f,"vtlBackground"))}q.pool.release(o)}}let L=class extends te(se){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1}get fading(){return this._vectorTileContainer?.fading??!1}async hitTest(i,e){if(!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const t=await this._vectorTileContainer.hitTest(e);if(!t||t.length===0)return null;const s=t[0]-1,r=this._styleRepository,a=r.getStyleLayerByUID(s);if(!a)return null;const n=r.getStyleLayerIndex(a.id);return[{type:"graphic",mapPoint:i,layer:this.layer,graphic:new ie({attributes:{layerId:n,layerName:a.id,layerUID:s},layer:this.layer,sourceLayer:this.layer})}]}update(i){if(this._tileHandlerPromise&&this._isTileHandlerReady)return i.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=i.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=i.state,this._parseQueue.state=i.state,this._tileManager.update(i)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:i}=this.layer.currentStyleInfo;this._styleRepository=new O(i),this._tileInfoView=new ye(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Se(this._tileInfoView),this._tileHandler=new pe(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",e=>{if(e.isDataDriven)this._styleChanges.push({type:u.PAINTER_CHANGED,data:e}),this.requestUpdate();else{const t=this._styleRepository,s=t.getLayerById(e.layer);if(!s)return;const r=s.type===_.SYMBOL;t.setPaintProperties(e.layer,e.paint),r&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender()}}),this.layer.on("layout-change",e=>{const t=this._styleRepository,s=t.getLayerById(e.layer);if(!s)return;const r=re(s.layout,e.layout);if(r!=null){if(ae(r,"visibility")&&Re(r)===1)return t.setLayoutProperties(e.layer,e.layout),s.type===_.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:u.LAYOUT_CHANGED,data:e}),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",e=>{const t=this._styleRepository,s=t.getLayerById(e.layer);s&&(t.setStyleLayerVisibility(e.layer,e.visibility),s.type===_.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender())}),this.layer.on("style-layer-change",e=>{this._styleChanges.push({type:u.LAYER_CHANGED,data:e}),this.requestUpdate()}),this.layer.on("delete-style-layer",e=>{this._styleChanges.push({type:u.LAYER_REMOVED,data:e}),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",e=>{this._styleChanges.push({type:u.SPRITES_CHANGED,data:e});const t=this._styleRepository.layers;for(const s of t)switch(s.type){case _.SYMBOL:s.getLayoutProperty("icon-image")&&this._styleChanges.push({type:u.LAYOUT_CHANGED,data:{layer:s.id,layout:s.layout}});break;case _.LINE:s.getPaintProperty("line-pattern")&&this._styleChanges.push({type:u.PAINTER_CHANGED,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}});break;case _.FILL:s.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:u.PAINTER_CHANGED,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=w(this._vectorTileContainer),this._tileHandler=w(this._tileHandler)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(i){return le(this.layer.tileInfo?.spatialReference,i)}canResume(){let i=super.canResume();const{currentStyleInfo:e}=this.layer;if(i&&e?.layerDefinition){const t=this.view.scale,{minScale:s,maxScale:r}=e.layerDefinition;e?.layerDefinition&&(s&&s<t&&(i=!1),r&&r>t&&(i=!1))}return i}isUpdating(){return this.fading}acquireTile(i){const e=this._createVectorTile(i);return this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>this._parseQueue.push({key:e.key,data:t})).then(t=>{e.once("attach",()=>this.requestUpdate()),e.setData(t),this.requestUpdate()}).catch(t=>{U(t)||F.getLogger(this).error(t)})),e}releaseTile(i){const e=i.key.id;this._fetchQueue.abort(e),this._parseQueue.abort(e),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new Te({acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const i=new AbortController,e=this._tileHandler.start({signal:i.signal}).then(()=>{this._fetchQueue=new V({tileInfoView:this._tileInfoView,process:(t,s)=>this._getTileData(t,s),concurrency:15}),this._parseQueue=new V({tileInfoView:this._tileInfoView,process:(t,s)=>this._parseTileData(t,s),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(t=>{this._vectorTileContainer.setStyleResources(t,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()}),this._tileHandlerAbortController=i,this._tileHandlerPromise=e}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const i=this._tileHandlerAbortController;i&&i.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=w(this._fetchQueue),this._parseQueue=w(this._parseQueue),this._tileManager=w(this._tileManager),this._vectorTileContainer.removeAllChildren()}async _getTileData(i,e){return this._tileHandler.fetchTileData(i,e)}async _parseTileData(i,e){return this._tileHandler.parseTileData(i,e)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const i=this._styleChanges;try{await this._tileHandler.updateStyle(i)}catch(a){F.getLogger(this).error("error applying vector-tiles style update",a.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0}const e=this._styleRepository,t=new Set;i.forEach(a=>{if(a.type!==u.LAYER_REMOVED)return;const n=a.data,l=e.getLayerById(n.layer);l&&t.add(l.uid)});const s=new Set;i.forEach(a=>{let n;switch(a.type){case u.PAINTER_CHANGED:e.setPaintProperties(a.data.layer,a.data.paint),n=a.data.layer;break;case u.LAYOUT_CHANGED:e.setLayoutProperties(a.data.layer,a.data.layout),n=a.data.layer;break;case u.LAYER_REMOVED:return void e.deleteStyleLayer(a.data.layer);case u.LAYER_CHANGED:e.setStyleLayer(a.data.layer,a.data.index),n=a.data.layer.id;break;case u.SPRITES_CHANGED:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(a.data.spriteSource))}if(n){const l=e.getLayerById(n);l&&s.add(l.uid)}});const r=this._vectorTileContainer.children;if(t.size>0){const a=Array.from(t);this._vectorTileContainer.deleteStyleLayers(a);for(const n of r)n.deleteLayerData(a)}if(this._fetchQueue.resume(),this._parseQueue.resume(),s.size>0){const a=Array.from(s),n=[];for(const l of r){const d=this._updatingHandles.addPromise(this._fetchQueue.push(l.key).then(o=>this._parseQueue.push({key:l.key,data:o,styleLayerUIDs:a})).then(o=>l.setData(o)));n.push(d)}await Promise.all(n)}this._styleChanges=[],this._isTileHandlerReady=!0,this.requestUpdate()}async _loadStyle(){const{style:i}=this.layer.currentStyleInfo,e=ne(i);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._styleRepository=new O(e),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:t}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,e),await this._tileHandlerPromise}catch(r){if(!U(r))throw r}if(t.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,void this.requestUpdate();const s=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(s,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.requestUpdate()}_createVectorTile(i){const e=this._tileInfoView.getTileBounds(I(),i),t=this._tileInfoView.getTileResolution(i.level);return new oe(i,t,e[0],e[3],512,512,this._styleRepository)}};function Re(i){if(i==null)return 0;switch(i.type){case"partial":return Object.keys(i.diff).length;case"complete":return Math.max(Object.keys(i.oldValue).length,Object.keys(i.newValue).length);case"collection":return Object.keys(i.added).length+Object.keys(i.changed).length+Object.keys(i.removed).length}}N([he()],L.prototype,"_isTileHandlerReady",void 0),L=N([de("esri.views.2d.layers.VectorTileLayerView2D")],L);const ke=L;export{ke as default};
