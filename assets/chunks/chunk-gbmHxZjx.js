import{u as _}from"./chunk-08eVzt-u.js";import{u as x}from"./chunk-fZ-fS00Y.js";import{V as k}from"./chunk-xLEcY3VV.js";import{c as d}from"./chunk-3E9jM2aR.js";import{c as h}from"./chunk-MyaGGhw0.js";import{V as F}from"./chunk-Lh9f0rxK.js";import{gp as U,nX as B,gB as C,kY as E,gq as y,pL as G,l0 as f,nE as L,l2 as $,gC as v,gs as p,gt as V,gw as b,gI as M,l5 as T,gz as P,nG as H,gD as j}from"./chunk-217NDGZJ.js";import{i as q}from"./chunk-PUZgjcoo.js";const I={query:{type:Object,default:{}},visible:{type:Boolean,default:void 0},maxScale:{type:Number,default:0},minScale:{type:Number,default:0},queryExtent:{type:Boolean,default:!1}},K={"update:visible":e=>typeof e=="boolean",load:e=>e,change:e=>e},S=Symbol("key"),N=U({name:"VaFeaturePopupLayer",components:{VaGeoViewUi:k,VaViewUi:F},inheritAttrs:!1,props:I,emits:K,setup(e,{emit:u}){const i=_(),n=x(),c=h(i[d]),o=B({default:q(i.scale,{maxScale:e.maxScale,minScale:e.minScale}),key:"visible"},e,u),l=C([]),a=E({}),r=()=>o.value?n.queryFeatures({returnGeometry:!0,outFields:["*"],where:"1=1",geometry:a.current,...e.query}).then(t=>(l.value=t.features.map(s=>(s[S]=s.attributes[n.objectIdField],s)),a.queried=a.current,t)):Promise.resolve();r().then(t=>{u("load",{featureSet:t,view:i,layer:n})}),y(()=>o.value,t=>{t&&(a.current=a.view,r())}),y(()=>({geometry:a.current,...e.query}),async()=>{await r().then(t=>{u("change",{featureSet:t,view:i,layer:n})})}),G(()=>a.view,async t=>{if(t&&o.value){if(!a.queried){a.current=t;return}a.queried.contains(t)||(a.current=a.queried.union(t).clone())}},{throttle:1e3});const w=new c("watch:scale",([t])=>{o.value=q(t,{maxScale:e.maxScale,minScale:e.minScale})});w.add(),f(()=>{w.remove()});const m=new c("watch:extent",([t])=>{a.view=t});if(y(()=>e.queryExtent,()=>{e.queryExtent?m.add():m.remove()},{immediate:!0}),f(()=>{m.remove()}),n[d]){const t=h(n[d]),s=new t("change",async()=>{l.value=[],await L(),await r()});s.add(),f(()=>{s.remove()})}return{visible:o,features:l,layer:n,sKey:S}}});function R(e,u,i,n,c,o){const l=v("VaGeoViewUi"),a=v("VaViewUi");return p(),V(a,{class:"feature-popup-layer"},{default:b(()=>[(p(!0),j(M,null,H(e.features,r=>(p(),V(l,T(e.$attrs,{key:r[e.sKey],class:"feature-popup-layer__item",visible:e.visible,geometry:r.geometry,orphan:!0}),{default:b(()=>[P(e.$slots,"default",{attributes:r?.attributes??{},geometry:r.geometry})]),_:2},1040,["visible","geometry"]))),128))]),_:3})}const g=$(N,[["render",R]]);g.install=e=>{e.component(g.name,g)};export{g as V};
