import{aF as ge,AB as de,$ as c,AC as I,rK as U,lY as X,m4 as wt,m5 as St,wB as Ai,m6 as Pi,AD as Ut,kU as ke,b7 as Je,eh as et,Aq as Fi,Am as Nt,An as Ht,kV as Wt,lX as Ii,b6 as Gt,kZ as qt,AE as Ti,AF as tt,AG as P,AH as D,AI as T,AJ as L,AK as Vt,AL as Ci,AM as it,AN as Ri,AO as W,AP as He,lV as zt,z as Kt,ng as Oi,ni as Ke,AQ as $t,v4 as Di,nc as Ei,aM as _t,mm as Mt,eH as ht,s as Li,hw as xe,AR as Bi,i8 as ki,zc as Ui,gU as Ni,z$ as Hi,q as Wi,AS as Ce,A6 as Gi}from"./chunk-gZYsZ36N.js";import{c as g,_ as S,e as Zt,P as pe,j as jt,t as K,G as $,g as Q,B as we,h as n,i as H,H as V,m as Xt,o as Yt,p as C,C as y,S as N,F as ft,q as qi,u as Ae,U as j,x as Se,v as We,w as Ge,y as Ue,z as st,A as At,D as Qt,E as Jt,a as B,I as Ki,J as Zi,K as ji,L as Xi,M as Yi,R as Qi,N as Ji,O as ce,Q as Pt,T as ei,V as rt,W as Ft,X as It,Y as Tt,Z as E,$ as ti,a0 as ii,a1 as at,a2 as es,a3 as le,a4 as Ct,a5 as ot,a6 as si,a7 as ts,a8 as is,a9 as Ze,aa as ss,ab as rs,ac as as,ad as os,ae as ns,af as ri,ag as ai,ah as oi,ai as ni,aj as li,ak as ui,al as mt,am as ci,an as ls,ao as Rt,ap as nt,aq as pi,ar as lt,as as je,at as us,au as cs,av as ps,aw as ds,ax as hs,ay as fs,az as ms,aA as ys,aB as vs,aC as bs,aD as gs,aE as xs,aF as ws,aG as re,aH as he,aI as ae,aJ as ze,aK as Ss,d as Vs}from"./chunk-O81L3uYa.js";import{n as zs}from"./chunk-rTJVl5ZJ.js";import{o as $s}from"./chunk-gJZ7CV2L.js";let k=class{constructor(e){this.registryName=e,this.postProcessingEnabled=!1,this.overrideStencilRef=null,this.drawPhase=ge.MAP|ge.HITTEST|ge.HIGHLIGHT|ge.DEBUG,this.symbologyPlane=de.FILL}startup(){}shutdown(e){}postProcess(e,t){}},di=class extends Zt{};c([g(0,y)],di.prototype,"pos",void 0);let _s=class extends Ae{},hi=class extends pe{};c([S(n)],hi.prototype,"dotSize",void 0);let Oe=class extends pe{};c([S(N)],Oe.prototype,"locations",void 0),c([S(n)],Oe.prototype,"pixelRatio",void 0),c([S(n)],Oe.prototype,"tileZoomFactor",void 0);const Ms=1e-6;class me extends jt{vertex(e){const t=new K(1,0,0,0,-1,0,0,1,1).multiply(new $(e.pos.xy.divide(U),1)),i=Q(this.draw.locations,t.xy),r=we(this.instance.dotSize.divide(2),new n(1));let a=new n(0);a=a.add(H(i.a,new n(Ms)).multiply(2));let o=r.add(this.instance.dotSize);const l=this.view.displayViewScreenMat3.multiply(new $(e.pos.add(.5),1)),u=new V(l.xy,a,1),p=this.instance.dotSize.divide(o),d=new n(-1).divide(r.divide(o));return o=o.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:o,color:i,ratio:p,invEdgeRatio:d}}fragment(e){const t=Xt(e.glPointCoord.subtract(.5)).multiply(2),i=Yt(new n(0),new n(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),r=new ft;return r.glFragColor=e.color.multiply(i),r}}c([S(hi)],me.prototype,"instance",void 0),c([S(Oe)],me.prototype,"draw",void 0),c([S(qi)],me.prototype,"view",void 0),c([I(0,C(di))],me.prototype,"vertex",null),c([I(0,C(_s))],me.prototype,"fragment",null);class fi extends We{}c([g(3,n)],fi.prototype,"inverseArea",void 0);let De=class extends pe{};c([S(j.ofType(V,2))],De.prototype,"isActive",void 0),c([S(j.ofType(V,8))],De.prototype,"colors",void 0),c([S(n)],De.prototype,"dotValue",void 0);let ye=class extends pe{};c([S(N)],ye.prototype,"dotTexture0",void 0),c([S(N)],ye.prototype,"dotTexture1",void 0),c([S(n)],ye.prototype,"tileZoomFactor",void 0),c([S(n)],ye.prototype,"pixelRatio",void 0),c([S(n)],ye.prototype,"tileDotsOverArea",void 0);let ve=class extends Ge{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new K(2/U,0,0,0,-2/U,0,-1,1,1).multiply(new $(e.pos,1)),i=this.clip(e.id),r=new V(t.xy,i,1),a=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),l=this.draw.tileZoomFactor.multiply(U).divide(this.draw.pixelRatio),u=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),p=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),d=e.pos.add(.5).divide(l);return{glPosition:r,color:new V(0,0,0,0),textureCoords:d,thresholds0:u,thresholds1:p}}fragment(e){const t=new ft,i=Q(this.draw.dotTexture0,e.textureCoords),r=Q(this.draw.dotTexture1,e.textureCoords),a=e.thresholds0.subtract(i),o=e.thresholds1.subtract(r);let l;const u=Ue.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),p=Ue.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const d=H(new n(0),a),h=H(new n(0),o),f=st(d,a).add(st(h,o)),m=H(f,new n(0)),x=new n(1).subtract(m),v=f.add(m),b=a.multiply(d).divide(v),w=o.multiply(h).divide(v),z=u.multiply(b).add(p.multiply(w));l=x.multiply(z)}else{const d=we(At(a),At(o)),h=H(d,new n(0)),f=new n(1).subtract(h),m=H(d,a),x=H(d,o),v=u.multiply(m).add(p.multiply(x));l=f.multiply(v)}return t.glFragColor=l,t}hittest(e){return Qt(this.hittestRequest)}};c([Se],ve.prototype,"blending",void 0),c([S(De)],ve.prototype,"instance",void 0),c([S(ye)],ve.prototype,"draw",void 0),c([I(0,C(fi))],ve.prototype,"vertex",null),c([I(0,C(Ae))],ve.prototype,"fragment",null);const ut={[X.BYTE]:1,[X.UNSIGNED_BYTE]:1,[X.SHORT]:2,[X.UNSIGNED_SHORT]:2,[X.INT]:4,[X.UNSIGNED_INT]:4,[X.FLOAT]:4};let As=class{constructor(e,t){this._boundPart=null;const i=[];for(const a of t.vertex){const o=wt.createVertex(e,St.STATIC_DRAW,a);i.push(o)}const r=[];for(const a of t.index||[]){const o=wt.createIndex(e,St.STATIC_DRAW,a);r.push(o)}this.groups=[];for(const a of t.groups){let o;if(a.index!=null){if(!t.index)throw new Error("No index data.");const{BYTES_PER_ELEMENT:f}=t.index[a.index];f===2?o=X.UNSIGNED_SHORT:f===4&&(o=X.UNSIGNED_INT)}const l=a.index!=null?r[a.index]:null,u=new Map,p={},d={};for(const f of a.attributes){const{name:m,count:x,type:v,offset:b,normalized:w,divisor:z,stride:A,vertex:F,location:R}=f,_=`vertex-buffer-${F}`;let Z=p[_];Z||(Z=p[_]=[]);const ue=new Ai(m,x,v,b,A,w,z);Z.push(ue),u.set(m,R),d[_]=i[F]}const h=new Pi(e,u,p,d,l);this.groups.push({...a,vertexArray:h,locations:u,layout:p,indexing:o})}this.parts=t.parts}bind(e,t){this._boundPart=t;const{group:i}=this.parts[this._boundPart],{vertexArray:r}=this.groups[i];e.bindVAO(r)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:r}=this.parts[this._boundPart],{indexing:a,primitive:o}=this.groups[r];a?e.drawElements(o,i,a,t*ut[a]):e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArray:e}of this.groups)e.dispose()}},Ps=class mi extends As{static create(e,t){const i=[];let{stride:r,hash:a}=t.layout;if(r==null){r=0;for(const{count:f,type:m,offset:x}of t.layout.attributes){if(x!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=f*ut[m]}}let o=0,l=0;for(const{count:f,name:m,offset:x,type:v,normalized:b}of t.layout.attributes){x!=null&&(l=x);const w={name:m,location:o,vertex:0,count:f,type:v,offset:l,stride:r,divisor:0,normalized:b!=null&&b};i.push(w),o++,l+=f*ut[v]}const u={attributes:i,primitive:t.primitive};t.index!=null&&(u.index=0);let{count:p}=t;if(p==null&&(p=t.index?t.index.length:t.vertex.byteLength/r,Math.floor(p)!==p))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);const d={start:0,count:p,group:0,primitive:t.primitive},h={vertex:[t.vertex],parts:[d],groups:[u]};return t.index!=null&&(h.index=[t.index]),a==null&&(a=Ut(i)),new mi(e,h,{hash:a,attributes:i,stride:r})}constructor(e,t,i){super(e,t),this.layout=i}bind(e,t=0){super.bind(e,t)}},Fs=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){const t=U,i=U,r=new ke(t,i);r.samplingMode=Je.NEAREST,r.wrapMode=et.CLAMP_TO_EDGE;const a=new Fi(e,new Nt(Ht.DEPTH_STENCIL,t,i));this._dotFBO=new Wt(e,r,a)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){const t=U,i=t*t,r=2,a=new Int16Array(i*r);for(let u=0;u<t;u++)for(let p=0;p<t;p++)a[r*(p+u*t)]=p,a[r*(p+u*t)+1]=u;const o=[{count:2,type:X.UNSIGNED_SHORT,name:"a_position",offset:0}],l={hash:Ut(o),attributes:o,stride:4};this._dotMesh=Ps.create(e,{primitive:Ii.POINTS,vertex:a,count:i,layout:l})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){const r=new Ti(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const r=new Float32Array(t*t*4);for(let o=0;o<r.length;o++)r[o]=i.getFloat();const a=new ke;return a.dataType=Gt.FLOAT,a.samplingMode=Je.NEAREST,a.width=t,a.height=t,new qt(e,a,r)}},Is=class extends k{constructor(){super(...arguments),this.shaders={polygon:new ve,point:new me,fill:new Jt},this.meshWriter=B.DotDensityMeshWriter,this._resources=new Map}render(e,t){tt(e)||P(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.fill,uniforms:{...D(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...T(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}_renderDotDensity(e,t){const{context:i,painter:r,requiredLevel:a}=e,o=t.instance.getInput(),l=this._getOrCreateResourcesRecord(i),u=l.getDotDensityTextures(i,U,o.seed),p=1/2**(a-t.target.key.level),d=U,h=d*window.devicePixelRatio*d*window.devicePixelRatio,f=1/p*(1/p),m=o.dotScale?e.state.scale/o.dotScale:1,x=o.dotValue*m*f;r.setShader({shader:this.shaders.polygon,uniforms:{...D(e,t.target),instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,x)},draw:{dotTexture0:{unit:Vt,texture:u[0]},dotTexture1:{unit:Ci,texture:u[1]},tileZoomFactor:p,pixelRatio:window.devicePixelRatio,tileDotsOverArea:h/(U*window.devicePixelRatio*U*window.devicePixelRatio)}},defines:{...T(e),blending:o.blending},optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState(L(e));const v=i.getViewport();i.setViewport(0,0,U,U);const b=i.getBoundFramebufferObject(),w=l.getFBO(i);i.bindFramebuffer(w),i.setClearColor(0,0,0,0),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.updatePipelineState(i),i.clear(it.COLOR_BUFFER_BIT),r.submitDraw(i,t),i.bindFramebuffer(b),i.setViewport(v.x,v.y,v.width,v.height);const z=l.getFBO(i).colorTexture;r.setShader({shader:this.shaders.point,uniforms:{view:Ri(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:Vt,texture:z},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...T(e)},optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.submitDrawMesh(i,l.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Fs,this._resources.set(e,t)),t}},Ts=class extends k{constructor(){super(...arguments),this.meshWriter=B.ComplexFillMeshWriter,this.shaders={geometry:new Ki}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:He(t.target)},defines:{...T(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};function Pe(s){const e=1/s;return{antialiasing:e,blur:0+e}}let Cs=class extends k{constructor(){super(...arguments),this.meshWriter=B.ComplexOutlineFillMeshWriter,this.shaders={geometry:new Zi}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Pe(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:He(t.target)},defines:{...T(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Rs=class extends k{constructor(){super(...arguments),this.meshWriter=B.FillMeshWriter,this.shaders={geometry:new Jt}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target)},defines:T(e),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Os=class extends k{constructor(){super(...arguments),this.meshWriter=B.OutlineFillMeshWriter,this.shaders={geometry:new ji}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Pe(a)},defines:{...T(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Ds=class extends k{constructor(){super(...arguments),this.meshWriter=B.PatternFillMeshWriter,this.shaders={geometry:new Xi}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:He(t.target)},defines:{...T(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Es=class extends k{constructor(){super(...arguments),this.meshWriter=B.PatternOutlineFillMeshWriter,this.shaders={geometry:new Yi}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Pe(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:He(t.target)},defines:{...T(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};const Ls=()=>Kt.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources");let Bs=class{destroy(){this._accumulateFramebuffer=zt(this._accumulateFramebuffer),this._resolveGradientTexture=zt(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){const t=zs(e,Ls());this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==Gt.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){const{dataType:r,samplingMode:a,pixelFormat:o,internalFormat:l}=this.loadQualityProfile(e),u=new ke(t,i);u.pixelFormat=o,u.internalFormat=l,u.dataType=r,u.samplingMode=a,u.wrapMode=et.CLAMP_TO_EDGE;const p=new Nt(Ht.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new Wt(e,u,p)}else{const{width:r,height:a}=this._accumulateFramebuffer;r===t&&a===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){const r=new ke;r.wrapMode=et.CLAMP_TO_EDGE,this._resolveGradientTexture=new qt(e,r)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t);return this._resolveGradientTexture}};function yi(s){return s?.25:1}let vi=class extends We{};c([g(5,y)],vi.prototype,"offset",void 0);let ks=class extends Ae{},ct=class extends pe{};c([S(n)],ct.prototype,"radius",void 0),c([S(n)],ct.prototype,"isFieldActive",void 0);let _e=class extends Ge{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,r=e.offset,a=i.multiply(this.storage.getVVData(e.id).x).add(new n(1).subtract(i)),o=this.view.displayViewScreenMat3.multiply(new $(e.pos,1)).add(this.view.displayViewMat3.multiply(new $(r,0)).multiply(t)),l=this.clip(e.id);return{glPosition:new V(o.xy,l,1),offset:r,fieldValue:a,color:new V(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,r=Xt(t),a=H(r,new n(1)),o=new n(1).subtract(r.multiply(r)),l=o.multiply(o),u=a.multiply(l).multiply(i).multiply(new n(yi(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new V(u),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view,r=t.multiply(i).multiply(new $(e.pos,1));return Qi(r.xy,this.kernelControls.radius,this.hittestRequest.position)}};c([Se],_e.prototype,"usesHalfFloatPrecision",void 0),c([S(ct)],_e.prototype,"kernelControls",void 0),c([I(0,C(vi))],_e.prototype,"vertex",null),c([I(0,C(ks))],_e.prototype,"fragment",null);let bi=class extends Zt{};c([g(0,y)],bi.prototype,"pos",void 0);let Us=class extends Ji{},Ee=class extends pe{};c([S(N)],Ee.prototype,"texture",void 0),c([S(y)],Ee.prototype,"minAndInvRange",void 0),c([S(n)],Ee.prototype,"normalization",void 0);let gi=class extends pe{};c([S(N)],gi.prototype,"texture",void 0);let be=class extends jt{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new V(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let r=Q(t.texture,e.uv).r.multiply(new n(yi(this.usesHalfFloatPrecision)));r=r.multiply(t.normalization),r=r.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const a=Q(i.texture,new y(r,.5)),o=new ft;return o.glFragColor=new V(a.rgb.multiply(a.a),a.a),o}};c([Se],be.prototype,"usesHalfFloatPrecision",void 0),c([S(Ee)],be.prototype,"accumulatedDensity",void 0),c([S(gi)],be.prototype,"gradient",void 0),c([I(0,C(bi))],be.prototype,"vertex",null),c([I(0,C(Us))],be.prototype,"fragment",null);let Ns=class extends k{constructor(){super(...arguments),this.meshWriter=B.HeatmapMeshWriter,this.shaders={accumulate:new _e,resolve:new be},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=xi}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:r,state:a}=e,o=t.instance.getInput(),{isFieldActive:l}=o,u=this._getOrCreateResourcesRecord(i),p=u.loadQualityProfile(i);if(tt(e))return;P(e)||this._bind(e,u,o),r.setShader({shader:this.shaders.accumulate,uniforms:{...D(e,t.target),kernelControls:{radius:Ot(o,a),isFieldActive:l?1:0}},defines:{...T(e),...p.defines},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)});const d=P(e)?Ws:wi;r.setPipelineState(d),r.submitDraw(i,t)}postProcess(e,t){if(P(e)||tt(e))return;const{context:i,painter:r}=e,a=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!a?.initialized)return;const{defines:o}=a.loadQualityProfile(i),{minDensity:l,maxDensity:u,radius:p}=t.getInput(),d=8,h=9,f=a.accumulateFramebuffer,m=a.resolveGradientTexture;r.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:d,texture:f.colorTexture},minAndInvRange:[l,1/(u-l)],normalization:3/(p*p*Math.PI)},gradient:{texture:{unit:h,texture:m}}},defines:o,optionalAttributes:{},useComputeBuffer:!1}),i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(f.colorTexture,d),i.bindTexture(m,h),r.setPipelineState(Gs),r.submitDrawQuad(i),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Bs,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:r,state:a,pixelRatio:o}=e,l=r.getBoundFramebufferObject(),u=r.getViewport();this._prevFBO=l,this._prevViewport=u;const{gradient:p,gradientHash:d}=i;t.ensureResolveGradientTexture(r,d,p);const{width:h,height:f}=u,m=Hs(Ot(i,a),o),x=h*m,v=f*m,b=t.ensureAccumulateFBO(r,x,v);r.blitFramebuffer(l,b,0,0,l.width,l.height,0,0,b.width,b.height,it.STENCIL_BUFFER_BIT,Je.NEAREST),r.bindFramebuffer(b),r.setViewport(0,0,b.width,b.height),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(it.COLOR_BUFFER_BIT),this._isBound=!0}};function Hs(s,e){const t=e>1.5?.25:.5;return s<1/(2*t)?1:t}function xi(s){return s.key.level+1}const wi={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:xi,compare:Oi.GEQUAL,mask:255,op:{fail:Ke.KEEP,zFail:Ke.KEEP,zPass:Ke.REPLACE}}}},Ws={...wi,stencil:!1},Gs={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function Ot(s,e){const{referenceScale:t,radius:i}=s;return i*(t!==0?t/e.scale:1)}let yt=class extends pe{getVVRotationMat4(e){return ce(Pt(e),Ue.identity(),()=>{const t=this._getNormalizedAngle(e).multiply(Ft),i=It(t),r=Tt(t);return new Ue(r,i,0,0,i.multiply(new n(-1)),r,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return ce(Pt(e),K.identity(),()=>{const t=this._getNormalizedAngle(e).multiply(Ft),i=It(t),r=Tt(t);return new K(r,i,0,i.multiply(new n(-1)),r,0,0,0,1)})}_getNormalizedAngle(e){const t=ei(this.rotationType,new n(rt.Arithmatic));return ce(t,new n(90).subtract(e),e)}};c([S(n)],yt.prototype,"rotationType",void 0);const qs=360/254;class G extends We{}c([g(3,V)],G.prototype,"color",void 0),c([g(4,y)],G.prototype,"offset",void 0),c([g(5,y)],G.prototype,"textureUV",void 0),c([g(6,n)],G.prototype,"fontSize",void 0),c([g(7,n)],G.prototype,"referenceSize",void 0),c([g(8,n)],G.prototype,"haloFontSize",void 0),c([g(9,V)],G.prototype,"haloColor",void 0),c([g(10,y)],G.prototype,"zoomRange",void 0),c([g(11,n)],G.prototype,"clipAngle",void 0),c([g(12,V)],G.prototype,"referenceSymbol",void 0);let pt=class extends ti{};c([g(13,y)],pt.prototype,"offsetNextVertex1",void 0),c([g(14,y)],pt.prototype,"offsetNextVertex2",void 0);class Ks extends Ae{}class O extends Ge{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){const r=t.multiply(qs),a=ii(this.view.rotation.subtract(r)),o=at(new n(360).subtract(a),a);let l=new n(0);const u=es(this.view.currentZoom.multiply($t)).divide($t),p=e.x,d=e.y,h=new n(1).subtract(H(p,u)).multiply(2),f=H(new n(90),o).multiply(2),m=new n(2).multiply(new n(1).subtract(H(u,d)));return l=l.add(i.multiply(h)),l=l.add(i.multiply(f)),l=l.add(m),l}vertex(e,t){const i=le(e.bitset,os),r=new n(1).subtract(i);let a=e.fontSize,o=a.divide(Ct);const l=this.isHaloPass?e.haloColor:this._getVertexColor(e),u=this.isLabel?l.multiply(this.storage.getAnimationValue(e.id)):l,p=this.view.displayViewScreenMat3.multiply(new $(e.pos,1));let d=e.offset,h=new n(1),f=K.identity();if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const A=e.referenceSymbol,F=A.xy,R=A.z,_=this._unpackDirection(A.w),Z=ot(this,e.id,R).divide(2),ue=_.multiply(Z.add(Di));d=d.add(F).add(ue)}else h=ot(this,e.id,e.referenceSize).divide(e.referenceSize),a=a.multiply(h),o=o.multiply(h),d=d.multiply(h),f=si(this,e.id),d=f.multiply(new $(d,0)).xy;const m=le(e.bitset,ns),x=this._getViewRotationMatrix(m).multiply(new $(d,0));let v=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,m):this.clip(e.id,e.zoomRange);v=this.isBackgroundPass?v.add(r.multiply(2)):v.add(i.multiply(2));const b=new V(p.xy.add(x.xy),v,1),w=e.textureUV.divide(this.mosaicInfo.size);let z=new n(0);return this.isHaloPass&&(z=e.haloFontSize.divide(o).divide(ts)),{glPosition:b,color:u,size:o,textureUV:w,antialiasingWidth:new n(.105*Ct).divide(a).divide(this.view.pixelRatio),haloDistanceOffset:z,...this.maybeRunHittest(e,t,{vvSizeAdjustment:h,vvRotation:f})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}fragment(e){const t=new n(.25),i=new n(1).subtract(t),r=Q(this.mosaicInfo.texture,e.textureUV).a;let a=i.subtract(e.haloDistanceOffset);this.highlight&&(a=a.divide(2));const o=e.antialiasingWidth,l=Yt(a.subtract(o),a.add(o),r);return this.getFragmentOutput(e.color.multiply(l),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:r}){const a=r.multiply(new $(e.offset.multiply(i),0)),o=r.multiply(new $(t.offsetNextVertex1.multiply(i),0)),l=r.multiply(new $(t.offsetNextVertex2.multiply(i),0)),{viewMat3:u,tileMat3:p}=this.view,d=u.multiply(p).multiply(new $(e.pos,1)),h=d.add(p.multiply(a)).xy,f=d.add(p.multiply(o)).xy,m=d.add(p.multiply(l)).xy;return is(this.hittestRequest.position,h.xy,f.xy,m.xy)}_unpackDirection(e){const t=new Ze(e),i=ss(t,new Ze(2)),r=rs(t,new Ze(3));return new y(new n(i).subtract(1),new n(r).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new as(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),r=this.visualVariableOpacity.getOpacity(i);t=t.multiply(r)}return t}}c([E(ri)],O.prototype,"visualVariableColor",void 0),c([E(ai)],O.prototype,"visualVariableOpacity",void 0),c([E(yt)],O.prototype,"visualVariableRotation",void 0),c([E(oi)],O.prototype,"visualVariableSizeMinMaxValue",void 0),c([E(ni)],O.prototype,"visualVariableSizeScaleStops",void 0),c([E(li)],O.prototype,"visualVariableSizeStops",void 0),c([E(ui)],O.prototype,"visualVariableSizeUnitValue",void 0),c([S(mt)],O.prototype,"mosaicInfo",void 0),c([Se],O.prototype,"isHaloPass",void 0),c([Se],O.prototype,"isBackgroundPass",void 0),c([Se],O.prototype,"isLabel",void 0),c([I(0,C(G)),I(1,C(pt))],O.prototype,"vertex",null),c([I(0,C(Ks))],O.prototype,"fragment",null);let Zs=class extends k{constructor(){super(...arguments),this.meshWriter=B.LabelMeshWriter,this.shaders={geometry:new O},this.drawPhase=ge.LABEL|ge.LABEL_ALPHA,this.symbologyPlane=de.TEXT}render(e,t){const{context:i,painter:r}=e,a=T(e),o={...L(e)},l={shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!0},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:!1};r.setShader(l),r.setPipelineState(o),r.submitDraw(i,t),r.setShader({...l,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!0}}),r.setPipelineState(o),r.submitDraw(i,t),r.setShader({...l,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!0}}),r.setPipelineState(o),r.submitDraw(i,t)}},js=class extends k{constructor(){super(...arguments),this.meshWriter=B.LineMeshWriter,this.shaders={geometry:new ci},this.symbologyPlane=de.LINE}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Pe(a)},defines:{...T(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class Le extends ls{}c([g(9,n)],Le.prototype,"accumulatedDistance",void 0),c([g(10,y)],Le.prototype,"segmentDirection",void 0),c([g(11,V)],Le.prototype,"tlbr",void 0);class dt extends ci{_getLineWidthRatio(e,t){const i=new n($s),r=le(e.bitset,ps);return r.multiply(we(t,new n(.25))).add(new n(1).subtract(r)).divide(i)}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:r,patternSize:a,accumulatedDistance:o,lineWidthRatio:l}=e,u=a.x.multiply(new n(2)).multiply(l),p=Rt(o.divide(u)),d=new n(.25).multiply(i.y).add(new n(.5)),h=nt(r.xy,r.zw,new y(p,d)),f=pi(Q(this.mosaicInfo.texture,h)).subtract(new n(.5)).multiply(t),m=lt(new n(.5).subtract(f),new n(0),new n(1));return new V(m)}_getPatternColor(e){const{halfWidth:t,normal:i,color:r,accumulatedDistance:a,patternSize:o,sampleAlphaOnly:l,tlbr:u}=e,p=o.y.multiply(new n(2).multiply(t).divide(o.x)),d=Rt(a.divide(p)),h=new n(.5).multiply(i.y).add(new n(.5)),f=nt(u.xy,u.zw,new y(h,d));let m=Q(this.mosaicInfo.texture,f);return this.visualVariableColor!=null&&(m=ce(je(l,new n(.5)),new V(r.a),r)),m}vertex(e,t){const{segmentDirection:i,tlbr:r,bitset:a}=e,o=us(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(st(i,o.scaledOffset)),u=new y(r.z.subtract(r.x),r.w.subtract(r.y)),p=r.divide(this.mosaicInfo.size.xyxy),d=le(a,ds),h=le(a,hs),f=ce(je(d,new n(.5)),this._getLineWidthRatio(e,o.scaledHalfWidth),new n(1));return{...o,tlbr:p,patternSize:u,accumulatedDistance:l,isSDF:d,sampleAlphaOnly:h,lineWidthRatio:f,...this.maybeRunHittest(e,t,o.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:r}=e,a=cs(e,this.antialiasingControls.blur),o=ce(je(r,new n(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),l=t.multiply(i).multiply(a).multiply(o);return this.getFragmentOutput(l,e)}}c([S(mt)],dt.prototype,"mosaicInfo",void 0),c([I(0,C(Le)),I(1,C(fs))],dt.prototype,"vertex",null);let Xs=class extends k{constructor(){super(...arguments),this.meshWriter=B.TexturedLineMeshWriter,this.shaders={geometry:new dt},this.symbologyPlane=de.LINE}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Pe(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...T(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class ne extends We{}c([g(3,V)],ne.prototype,"color",void 0),c([g(4,V)],ne.prototype,"outlineColor",void 0),c([g(5,y)],ne.prototype,"offset",void 0),c([g(6,y)],ne.prototype,"textureUV",void 0),c([g(7,V)],ne.prototype,"sizing",void 0),c([g(8,n)],ne.prototype,"placementAngle",void 0),c([g(9,n)],ne.prototype,"sizeRatio",void 0),c([g(10,y)],ne.prototype,"zoomRange",void 0);class Me extends ti{}c([g(12,y)],Me.prototype,"offsetNextVertex1",void 0),c([g(13,y)],Me.prototype,"offsetNextVertex2",void 0),c([g(14,y)],Me.prototype,"textureUVNextVertex1",void 0),c([g(15,y)],Me.prototype,"textureUVNextVertex2",void 0);class Ys extends Ae{}function oe(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}function Xe(s){return s.multiply(s).divide(128)}class q extends Ge{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=Xe(e.sizing.x),r=Xe(e.sizing.y),a=Xe(e.sizing.z),o=e.placementAngle,l=le(e.bitset,ze.bitset.isSDF),u=le(e.bitset,ze.bitset.isMapAligned),p=le(e.bitset,ze.bitset.scaleSymbolsProportionally),d=ms(e.bitset,ze.bitset.colorLocked),h=ys(this,e.id),f=vs(this,e.id,e.color,d).multiply(h),m=this.view.displayViewScreenMat3.multiply(new $(e.pos.xy,1)),x=ot(this,e.id,a).divide(a),v=i.multiply(x),b=e.offset.xy.multiply(x);let w=r.multiply(p.multiply(x.subtract(1)).add(1));w=at(w,we(v.subtract(.99),new n(0)));const z=we(w,new n(1)),A=at(w,new n(1)),F=K.fromRotation(o.multiply(bs)),R=si(this,e.id),_=this._getViewRotationMatrix(u).multiply(R).multiply(F).multiply(new $(b.xy,0)),Z=this.clip(e.id,e.zoomRange),ue=new V(m.xy.add(_.xy),Z,1),Fe=e.textureUV.divide(this.mosaicInfo.size),Ie=e.outlineColor.multiply(A),Te=le(e.bitset,ze.bitset.overrideOutlineColor),Ve=e.sizeRatio.multiply(v).multiply(.5);return{glPosition:ue,color:f,textureUV:Fe,outlineColor:Ie,outlineSize:z,distanceToPx:Ve,isSDF:l,overrideOutlineColor:Te,...this.maybeRunHittest(e,t,{pos:e.pos,size:v,sizeCorrection:x,isMapAligned:u,outlineSize:z,distanceToPx:Ve,isSDF:l})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return ce(gs(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getColor(e,t){return ce(ei(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return Q(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=Q(this.mosaicInfo.texture,e),r=new n(.5).subtract(pi(i)).multiply(t.distanceToPx).multiply(xs),a=lt(new n(.5).subtract(r),new n(0),new n(1)),o=t.color.multiply(a);let l=t.outlineSize;this.highlight&&(l=we(l,t.overrideOutlineColor.multiply(4)));const u=l.multiply(.5),p=ii(r).subtract(u),d=lt(new n(.5).subtract(p),new n(0),new n(1)),h=nt(t.outlineColor,t.color,t.overrideOutlineColor).multiply(d);return new n(1).subtract(h.a).multiply(o).add(h)}_hittestSmallMarker(e,t,i){const{position:r,distance:a,smallSymbolDistance:o}=this.hittestRequest,l=a.subtract(o),{viewMat3:u,tileMat3:p}=this.view,d=u.multiply(p).multiply(new $(i.pos,1)).xy,h=i.size.multiply(.5);return ws(d,r).subtract(h).add(l)}_hittestMarker(e,t,i){const{pos:r,size:a,sizeCorrection:o,isMapAligned:l,outlineSize:u,isSDF:p,distanceToPx:d}=i,h=new $(e.offset.multiply(o),0),f=new $(t.offsetNextVertex1.multiply(o),0),m=new $(t.offsetNextVertex2.multiply(o),0),{viewMat3:x,tileMat3:v}=this.view,b=x.multiply(v).multiply(new $(r,1)),w=this._getViewScreenMatrix(l),z=b.add(w.multiply(h)).xy,A=b.add(w.multiply(f)).xy,F=b.add(w.multiply(m)).xy,R=this.hittestRequest.position,_=this.hittestRequest.distance,Z=re(R.add(new y(he(_),he(_))),z,A,F),ue=re(R.add(new y(0,he(_))),z,A,F),Fe=re(R.add(new y(_,he(_))),z,A,F),Ie=re(R.add(new y(he(_),0)),z,A,F),Te=re(R,z,A,F),Ve=re(R.add(new y(_,0)),z,A,F),bt=re(R.add(new y(he(_),_)),z,A,F),gt=re(R.add(new y(0,_)),z,A,F),xt=re(R.add(new y(_,_)),z,A,F),ee=e.textureUV.divide(this.mosaicInfo.size),te=t.textureUVNextVertex1.divide(this.mosaicInfo.size),ie=t.textureUVNextVertex2.divide(this.mosaicInfo.size),se={color:new V(1),outlineColor:new V(1),overrideOutlineColor:new n(1),outlineSize:u,distanceToPx:d,isSDF:p};let M=new n(0);return M=M.add(ae(Z).multiply(this._getColor(oe(Z,ee,te,ie),se).a)),M=M.add(ae(ue).multiply(this._getColor(oe(ue,ee,te,ie),se).a)),M=M.add(ae(Fe).multiply(this._getColor(oe(Fe,ee,te,ie),se).a)),M=M.add(ae(Ie).multiply(this._getColor(oe(Ie,ee,te,ie),se).a)),M=M.add(ae(Te).multiply(this._getColor(oe(Te,ee,te,ie),se).a)),M=M.add(ae(Ve).multiply(this._getColor(oe(Ve,ee,te,ie),se).a)),M=M.add(ae(bt).multiply(this._getColor(oe(bt,ee,te,ie),se).a)),M=M.add(ae(gt).multiply(this._getColor(oe(gt,ee,te,ie),se).a)),M=M.add(ae(xt).multiply(this._getColor(oe(xt,ee,te,ie),se).a)),H(M,new n(.05)).multiply(Qt(this.hittestRequest))}}c([E(ri)],q.prototype,"visualVariableColor",void 0),c([E(ai)],q.prototype,"visualVariableOpacity",void 0),c([E(yt)],q.prototype,"visualVariableRotation",void 0),c([E(oi)],q.prototype,"visualVariableSizeMinMaxValue",void 0),c([E(ni)],q.prototype,"visualVariableSizeScaleStops",void 0),c([E(li)],q.prototype,"visualVariableSizeStops",void 0),c([E(ui)],q.prototype,"visualVariableSizeUnitValue",void 0),c([S(mt)],q.prototype,"mosaicInfo",void 0),c([I(0,C(ne)),I(1,C(Me))],q.prototype,"vertex",null),c([I(0,C(Ys))],q.prototype,"fragment",null);let Qs=class extends k{constructor(){super(...arguments),this.meshWriter=B.MarkerMeshWriter,this.shaders={geometry:new q},this.symbologyPlane=de.MARKER}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...T(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class Js{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map(([r,a])=>`${r}.${a}`).join("."),i=Ei(t);this._locationInfo={hash:i,locations:e}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){const r=Object.keys(i).filter(o=>i[o]).map(o=>`${o}_${i[o].toString()}`).join("."),a=Object.keys(t).filter(o=>this.optionPropertyKeys.has(o)).join(".");return`${e.hash}.${r}.${a}`}getProgram(e,t,i,r){let a="",o="";for(const l in i)if(i[l]){const u=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;a+=u,o+=u}return a+=this.vertexShader,o+=this.fragmentShader,new Ss(a,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const i in this.required){const r=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:r.type,uniformArrayElementType:Dt(r),uniformArrayLength:Et(r)})}for(const i in e){const r=this.options[i];if(e[i])for(const a in r){const o=r[a];t.push({uniformHydrated:null,shaderModulePath:`${i}.${a}`,uniformName:a,uniformType:o.type,uniformArrayElementType:Dt(o),uniformArrayLength:Et(o)})}}return t}}const Dt=s=>s.type==="array"?s.elementType?.type:void 0,Et=s=>s.type==="array"?s.size:void 0,er={hittestDist:n,hittestPos:y},tr={filterFlags:N,animation:N,visualVariableData:N,dataDriven0:N,dataDriven1:N,dataDriven2:N,gpgpu:N,size:n},ir={displayViewScreenMat3:K,displayViewMat3:K,displayMat3:K,viewMat3:K,tileMat3:K,displayZoomFactor:n,requiredZoomFactor:n,tileOffset:y,currentScale:n,currentZoom:n,metersPerSRUnit:n};let sr=class extends Js{constructor(){super(...arguments),this.vertexShader=_t("materials/pie/pie.vert"),this.fragmentShader=_t("materials/pie/pie.frag"),this.required={...tr,...ir,outlineWidth:n,colors:j,defaultColor:V,othersColor:V,outlineColor:V,donutRatio:n,sectorThreshold:n},this.options={hittestUniforms:er,visualVariableSizeMinMaxValue:{minMaxValueAndSize:V},visualVariableSizeScaleStops:{sizes:{...j.ofType(n,8),type:"array",elementType:n,size:8},values:{...j.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeStops:{sizes:{...j.ofType(n,8),type:"array",elementType:n,size:8},values:{...j.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:n},visualVariableOpacity:{opacities:{...j.ofType(n,8),type:"array",elementType:n,size:8},opacityValues:{...j.ofType(n,8),type:"array",elementType:n,size:8}}},this.locations={pos:{index:0,type:y},id:{index:1,type:$},bitset:{index:2,type:n},offset:{index:3,type:y},texCoords:{index:4,type:y},size:{index:5,type:y},referenceSize:{index:6,type:n},zoomRange:{index:7,type:y}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...j.ofType(V,e),type:"array",elementType:V,size:e}}},rr=class extends k{constructor(){super(...arguments),this.meshWriter=B.PieChartMeshWriter,this.shaders={geometry:new sr},this.symbologyPlane=de.MARKER}render(e,t){const{context:i,painter:r}=e,{instance:a,target:o}=t,l=this.shaders.geometry,u=a.getInput(),p=u.numberOfFields,d=P(e),h=D(e,o),f=T(e);l.setNumberOfFields(p),r.setShader({shader:l,uniforms:{...W(e,t.target,u.geometry),...h.storage,...h.view,hittestUniforms:h.hittestRequest?{hittestDist:h.hittestRequest?.distance,hittestPos:h.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!u.geometry.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!u.geometry.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!u.geometry.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!u.geometry.visualVariableSizeUnitValue,VV_OPACITY:!!u.geometry.visualVariableOpacity,HITTEST:d,highlight:h.highlight?1:0,...f,numberOfFields:p},optionalAttributes:{},useComputeBuffer:d}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},ar=class extends k{constructor(){super(...arguments),this.meshWriter=B.TextMeshWriter,this.shaders={geometry:new O},this.symbologyPlane=de.TEXT}render(e,t){const{context:i,painter:r}=e,a=T(e),o={shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!1},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:P(e)};r.setShader(o),r.setPipelineState(L(e)),r.submitDraw(i,t),r.setShader({...o,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!1}}),r.submitDraw(i,t),r.setShader({...o,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!1}}),r.submitDraw(i,t)}};const J={fill:new Rs("fill"),patternFill:new Ds("patternFill"),complexFill:new Ts("complexFill"),outlineFill:new Os("outlineFill"),patternOutlineFill:new Es("patternOutlineFill"),complexOutlineFill:new Cs("complexOutlineFill"),marker:new Qs("marker"),pieChart:new rr("pieChart"),line:new js("line"),texturedLine:new Xs("texturedLine"),text:new ar("text"),label:new Zs("label"),heatmap:new Ns("heatmap"),dotDensity:new Is("dotDensity")};function Fa(){for(const s in J)J[s].startup()}function Ia(s){for(const e in J)J[e].shutdown(s)}function Ne(s,e){const t=s.slice(0,e),i=e-t.length;for(let r=0;r<i;r++){const a=t[t.length-1];t.push(a)}return t}function or(s){if(!s)return[0,0,0,0];const{r:e,g:t,b:i,a:r}=s;return[e*(r/255),t*(r/255),i*(r/255),r]}const Be=8,Si=Be-2,Vi=()=>Kt.getLogger("esri.views.2d.layers.features.support.rendererUtils");function zi(s){return s.map(e=>nr(e)?lr(e.clone()):e)}function nr(s){return(s.type==="size"||s.type==="color"||s.type==="opacity")&&s.stops!=null}function lr(s){return s.stops=pr(s.type,s.stops??[]),s}function fe(s,e,t){return(1-t)*s+t*e}function ur(s,e){const[t,...i]=e,r=i.pop(),a=i[0].value,o=i[i.length-1].value,l=(o-a)/Si,u=[];for(let p=a;p<o;p+=l){let d=0;for(;p>=i[d].value;)d++;const h=i[d],f=e[d-1],m=p-f.value,x=h.value===f.value?1:m/(h.value-f.value);if(s==="color"){const v=i[d],b=e[d-1],w=v.color.clone();w.r=fe(b.color.r,w.r,x),w.g=fe(b.color.g,w.g,x),w.b=fe(b.color.b,w.b,x),w.a=fe(b.color.a,w.a,x),u.push({value:p,color:w,label:v.label})}else if(s==="size"){const v=i[d],b=e[d-1],w=Mt(v.size),z=fe(Mt(b.size),w,x);u.push({value:p,size:z,label:v.label})}else{const v=i[d],b=fe(e[d-1].opacity,v.opacity,x);u.push({value:p,opacity:b,label:v.label})}}return[t,...u,r]}function cr(s){const[e,...t]=s,i=t.pop();for(;t.length>Si;){let r=0,a=0;for(let o=1;o<t.length;o++){const l=t[o-1],u=t[o],p=Math.abs(u.value-l.value);p>a&&(a=p,r=o)}t.splice(r,1)}return[e,...t,i]}function pr(s,e){return e.length<=Be?e:(Vi().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${Be}. Displayed stops will be simplified.`),e.length>2*Be?ur(s,e):cr(e))}function dr(){const{supportsColorBufferFloat:s,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=ht();return s&&e||t}function Ta(s){if(!s)return!0;switch(s.type){case"dot-density":break;case"heatmap":if(!dr()){const e=ht(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return Vi().errorOnce(new Li("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}const hr=1.25,Re=128,fr=128;function mr(s){if(!s.stops?.length)return null;const e=s.stops.sort((a,o)=>a.value-o.value),t=Ne(e,8),i=t.map(({value:a})=>a),r=t.map(({color:a})=>or(a));return{values:i,colors:r}}function yr(s){if(!s.stops?.length)return null;const e=s.stops.sort((i,r)=>i.value-r.value),t=Ne(e,8);return{opacityValues:t.map(({value:i})=>i),opacities:t.map(({opacity:i})=>i)}}function vr(s){return{rotationType:s.rotationType==="geographic"?rt.Geographic:rt.Arithmatic}}function Ye(s){if(!s.stops?.length)return null;if(s.stops.some(i=>i.useMaxValue||i.useMinValue))return(i,r)=>{const a=i.statisticsByLevel.get(r.key.level),o=s.stops.map(u=>({value:u.useMaxValue?a?.get(s.field)?.maxValue??0:u.useMinValue?a?.get(s.field)?.minValue??0:u.value,size:u.size?xe(u.size):Bi})).sort((u,p)=>u.value-p.value),l=Ne(o,8);return{values:l.map(({value:u})=>u),sizes:l.map(({size:u})=>u)}};const e=s.stops.sort((i,r)=>i.value-r.value),t=Ne(e,8);return{values:t.map(({value:i})=>i),sizes:t.map(({size:i})=>xe(i))}}function br(s){return e=>{const{state:t}=e;return{unitValueToPixelsRatio:ki(t.spatialReference)/Ui[s.valueUnit]/t.resolution}}}function Lt(s,e){const t=e.length;if(s<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(s<e[i].value){const r=(s-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+r*(e[i].size-e[i-1].size)}return e[t-1].size}function gr(s){const{minDataValue:e,maxDataValue:t,minSize:i,maxSize:r}=s;if(typeof i=="object"&&typeof r=="object")return(a,o)=>{const l=a.state.scale,u=xe(Lt(l,i.stops)),p=xe(Lt(l,r.stops));return{minMaxValueAndSize:[e,t,u,p]}};if(typeof i=="object"||typeof r=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,xe(i),xe(r)]}}const vt={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function $i(s,e=fr,t=hr){if(s.visualVariableSizeMinMaxValue)return s.visualVariableSizeMinMaxValue instanceof Function?Re:Math.max(s.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(s.visualVariableSizeScaleStops){if(s.visualVariableSizeScaleStops instanceof Function)return Re;const i=s.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(s.visualVariableSizeStops){if(s.visualVariableSizeStops instanceof Function)return Re;const i=s.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return s.visualVariableSizeUnitValue?2*Re:0}function Ca(s){const e={...vt};if(!s||!("visualVariables"in s)||!s.visualVariables)return e;for(const t of zi(s.visualVariables))switch(t.type){case"color":e.visualVariableColor=mr(t);break;case"opacity":e.visualVariableOpacity=yr(t);break;case"rotation":e.visualVariableRotation=vr(t);break;case"size":switch(xr(t)){case"field-stops":e.visualVariableSizeStops=Ye(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=Ye(t):e.visualVariableSizeScaleStops=Ye(t);break;case"min-max":e.visualVariableSizeMinMaxValue=gr(t);break;case"unit-value":e.visualVariableSizeUnitValue=br(t)}break;default:console.error("Unable to handle VV type")}return e}function xr(s){if(typeof s.minDataValue=="number"&&typeof s.maxDataValue=="number"&&s.minSize!=null&&s.maxSize!=null)return"min-max";if((s.expression&&s.expression==="view.scale"||s.valueExpression&&s.valueExpression==="$view.scale")&&Array.isArray(s.stops))return"scale-stops";if((s.field!=null||s.expression&&s.expression!=="view.scale"||s.valueExpression&&s.valueExpression!=="$view.scale")&&(Array.isArray(s.stops)||"levels"in s&&s.levels))return"field-stops";if((s.field!=null||s.expression&&s.expression!=="view.scale"||s.valueExpression&&s.valueExpression!=="$view.scale")&&s.valueUnit!=null)return"unit-value";throw new Error("InternalError: Found unknown sizeVV type")}function wr(s){return!!(s.visualVariableSizeMinMaxValue||s.visualVariableSizeScaleStops||s.visualVariableSizeStops||s.visualVariableSizeUnitValue||s.visualVariableSizeOutlineScaleStops)}function Ra(s){return!!s.visualVariableRotation}function Sr(s){return s.minScale||s.maxScale?{minScale:s.minScale??0,maxScale:s.maxScale??0}:null}function Y(s){if(s==null)return null;if(Array.isArray(s)){const[e,t,i,r]=s;return[e,t,i,255*r]}return typeof s=="string"?s:{...s,defaultValue:Y(s?.defaultValue)}}async function Oa(s,e){const{cimResourceManager:t,cimAnalyzer:i,scaleExpression:r}=e.schemaOptions;await Promise.all(Ni.fetchResources(s.symbol,t,[]));const a=i.analyzeSymbolReference(s,!1),o={scaleInfo:Sr(s),scaleExpression:r},l=[];for(const u of a)switch(u.type){case"marker":l.push(...Vr(u,e,o));break;case"fill":l.push(...Mr(u,e,o));break;case"line":l.push(...Pr(u,e,o));break;case"text":l.push(...Tr(u,e,o))}return l}function Vr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?{...vt,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return zr(a.ensureInstance(J.marker,{geometry:o},{zoomRange:!!t.scaleInfo}),s,i,t)}function zr(s,e,t,{scaleInfo:i,scaleExpression:r}){const a=wr(t);return[s.createMeshInfo({params:{size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:Y(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:Y(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||Hi.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:r??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:a,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:$i(t)}})]}function $r(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return _r(a.ensureInstance(J.fill,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!t.scaleInfo}),s,t)}function _r(s,e,{scaleInfo:t}){return[s.createMeshInfo({params:{color:Y(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}})]}function Mr(s,e,t){if(!s.spriteRasterizationParam)return $r(s,e,t);const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Ar(a.ensureInstance(J.complexFill,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!t.scaleInfo}),s,i.visualVariableColor!=null,t)}function Ar(s,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const r=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),a=e.sampleAlphaOnly&&!r,o=e.spriteRasterizationParam;return[s.createMeshInfo({params:{color:Y(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:o.resource.type==="CIMHatchFill",sprite:o,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}})]}function Pr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?{...vt,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},l={geometry:o},u=!!(o.visualVariableSizeMinMaxValue||o.visualVariableSizeScaleStops||o.visualVariableSizeStops||o.visualVariableSizeUnitValue);return s.spriteRasterizationParam?Ir(a.ensureInstance(J.texturedLine,l,{zoomRange:!!t.scaleInfo}),s,u,t):Fr(a.ensureInstance(J.line,l,{zoomRange:!!t.scaleInfo}),s,u,t)}function _i(s,e,{scaleInfo:t}){return{params:{color:Y(s.color)??[0,0,0,0],width:s.width,referenceWidth:s.referenceWidth,capType:s.cap,joinType:s.join,miterLimit:s.miterLimit,scaleInfo:t,hasSizeVV:e,effects:s.effects?{type:"cim-effect-infos",effectInfos:s.effects}:null}}}function Fr(s,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");return[s.createMeshInfo({params:_i(e,t,i).params})]}function Ir(s,e,t,i){const{spriteRasterizationParam:r,scaleDash:a,sampleAlphaOnly:o}=e;if(!r)throw new Error("InternalError: Sprite should be defined");return[s.createMeshInfo({params:{..._i(e,t,i).params,shouldScaleDash:a??!1,shouldSampleAlphaOnly:o,isSDF:r.resource.type!=="CIMPictureStroke",sprite:r}})]}function Tr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Cr(a.ensureInstance(J.text,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue}},{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}),s,i,t)}function Cr(s,e,t,{scaleInfo:i,scaleExpression:r}){return[s.createMeshInfo({params:{boxBackgroundColor:Y(e.backgroundColor),boxBorderLineColor:Y(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:Y(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:Y(e.outlineColor)??[0,0,0,0],haloFontSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:r??1,minPixelBuffer:$i(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}function Da(s,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:ht().maxTextureSize},bindings:Rr(s)}}function qe(s){switch(s){case"opacity":return Ce.OPACITY;case"color":return Ce.COLOR;case"rotation":return Ce.ROTATION;case"size":return Ce.SIZE;default:return null}}function Rr(s){if(!s)return[];switch(s.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return Mi(s);case"dot-density":return Or(s);case"pie-chart":return Dr(s);case"heatmap":return Er(s)}}function Or(s){const e=[];for(const t of s.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function Dr(s){const e=Mi(s);let t=4;for(const i of s.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function Er({valueExpression:s,field:e}){return s||e?[{binding:0,expression:s,field:e}]:[]}function Mi(s){return!("visualVariables"in s)||!s.visualVariables?.length?[]:zi(s.visualVariables).map(e=>Nr(e)).filter(Wi)}function Lr(s){return s.valueExpression==="$view.scale"?null:{binding:qe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression,valueRepresentation:s.valueRepresentation}}function Br(s){return{binding:qe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function kr(s){return{binding:qe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Ur(s){return{binding:qe(s.type),expression:s.valueExpression,field:s.field}}function Nr(s){switch(s.type){case"size":return Lr(s);case"color":return Br(s);case"opacity":return kr(s);case"rotation":return Ur(s)}}function Qe(s){return s.some(e=>e.globalId)}function $e(s){return s.filter(e=>!e.error).map(e=>e.objectId??e.globalId).filter(e=>e!=null)}function Bt(s,e){const t=new Set(s);for(const i of e.values())t.add(i);return t}function kt(s,e){const t=new Set(s);for(const i of e.values())t.delete(i);return t}class Ea{constructor(e){this.updateTracking=new Vs({debugName:"FeatureCommandQueue"}),this._hasGlobalIds=!1,this._queueProcessor=new Gi({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return this.updateTracking.addPromise(this._doPush(e))}async _doPush(e){const t=this._queueProcessor,i=t.last(),r=[];switch(e.type){case"update":if(i?.type===e.type)return;r.push(t.push(e));break;case"edit":{const a=i?.type==="processed-edit"?i:null;a&&t.popLast();const o=this._mergeEdits(a,e);for(const l of o)l&&r.push(t.push(l));break}}await Promise.all(r)}_mergeEdits(e,t){const{addedFeatures:i,deletedFeatures:r,updatedFeatures:a}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||Qe(i)||Qe(a)||Qe(r),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...i,...a],removed:r}}];const o=new Set($e(e?.edits.addOrModified??[])),l=new Set($e(e?.edits.removed??[])),u=new Set([...$e(i),...$e(a)]),p=new Set($e(r));return[{type:"processed-edit",edits:{addOrModified:Array.from(Bt(kt(o,p),u)).map(d=>({objectId:d})),removed:Array.from(Bt(kt(l,u),p)).map(d=>({objectId:d}))}}]}}export{Fa as F,Ar as S,Ia as T,Fr as a,Ea as b,Ca as c,or as d,$i as e,wr as f,Mi as g,J as h,Ra as i,Ta as m,Oa as n,_r as p,Sr as s,Da as t,zr as u,vt as x,Cr as y,Ir as z};
