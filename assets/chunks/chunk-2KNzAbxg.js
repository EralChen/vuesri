import{$ as p,a0 as c,a2 as k,a3 as Pt,e2 as an,wz as nn,bm as sn,ak as f,dM as on,at as F,a5 as tt,wa as ie,uh as wa,AU as rn,kH as ln,kC as hn,w9 as pn,iL as Gt,mP as xa,mN as Oa,tU as cn,mM as un,mV as x,ul as dn,AV as gn,na as Ea,k2 as be,fb as ge,AW as _n,sp as mn,kF as Ye,AX as fn,cU as $,as as ae,AY as Ta,fW as Aa,fh as _i,I as vn,kf as V,AZ as yn,A_ as Ia,A$ as C,pO as Mn,B0 as bn,k5 as Se,b$ as ft,wu as Li,uI as Re,ku as oi,kv as ki,wv as Sn,ew as st,cI as Ot,mW as Ut,ke as Hi,B1 as wn,ed as xn,kk as Vi,eb as On,jH as En,cL as Tn,xh as An,B2 as In,k9 as je,j7 as Ga,iI as Gn,i8 as Ce,f0 as H,uz as Dn,B3 as $n,e7 as X,u8 as Rn,B4 as Cn,B5 as Pn,wn as ve,B6 as Bi,B7 as bi,vG as Si,dZ as ne,al as se,_ as D,ae as R,tV as zn,B8 as Ln,uE as ot,B9 as wi,e8 as Rt,Ba as Da,dG as Pe,bP as kn,uL as Hn,es as Ui,er as Vn,Bb as Bn,kE as Un,Bc as $a,Bd as Fn,Be as Xn,mL as We,pz as ut,Bf as _e,Bg as xi,Bh as Nn,Bi as le,Bj as ze,Bk as Ra,kg as Fi,pJ as Z,uG as w,wc as O,Bl as Zn,pM as $e,pI as Ca,cG as j,pL as Le,Bm as Oi,kx as Ei,hE as qe,Bn as Yn,ue as Pa,Bo as jn,uF as xt,e$ as vt,Bp as za,Bq as Wn,Br as qn,uy as Jn,cH as P,ev as mi,pB as ke,eu as Ct,Bs as Kn,oo as Qn,Bt as La,uR as ka,di as fi,b1 as ts,Bu as es,Bv as Qt,sa as Je,V as is,fd as zt,Z as Ti,Bw as as,Bx as Ha,By as Va,Bz as ns,BA as ss,fc as nt,BB as He,fi as Ve,fg as Ke,ws as Be,uK as os,BC as Xi,BD as rs,eS as we,wh as Ba,pF as Ai,BE as Ua,BF as ls,mT as Ni,eR as hs,BG as ce,BH as ps,ub as Et,BI as Zi,ty as Yi,uS as cs,jU as oe,BJ as us,BK as ds,ky as Ee,gR as gs,mU as Ht,BL as Fa,uJ as ji,BM as _s,kr as ms,km as Ue,bU as fs,uH as wt,f2 as vs,BN as ys,BO as Ms,BP as bs,lm as Ss,s6 as ri,BQ as Wi,uD as ws,lk as me,pA as Ii,pH as Xa,BR as xs,bZ as ye,BS as Os,uo as Es,BT as qi,BU as Ji,BV as Ts,BW as As,bq as Is,BX as Gs,q as Ds,BY as $s,py as Na,pG as Za,cK as vi,uf as Ya,px as Me,pr as fe,hL as Rs,sw as Cs,eO as Bt}from"./chunk-xdbuWCSg.js";import{q as Ps}from"./chunk-zP4CxfFE.js";import{x as zs}from"./chunk-7j9k7D1U.js";import{u as ja,y as Fe,m as $t,R as Ls,c as ks,g as Hs}from"./chunk-hbj-5HCQ.js";import{d as Ki}from"./chunk-F0_7Ovf0.js";import{J as Vs,W as Bs,v as Us,d as Qe,F as Fs,E as Qi}from"./chunk-AB5KgQct.js";import{n as Ft}from"./chunk-iK0_O3eG.js";import{S as Xs}from"./chunk-UNe91zLl.js";import{u as xe,r as ti}from"./chunk-_nFoj7Ih.js";import{a as ei,l as Gi,r as ii,n as Ns,c as Zs,p as Ys}from"./chunk-xwDo9nIo.js";import{u as js}from"./chunk-AozVAsla.js";import{I as Ws,H as qs,S as Js,g as Ks,l as Qs,_ as to,v as eo,h as io,E as Wa,z as ta,c as ao,B as no,U as so}from"./chunk-ywCDB325.js";import{l as oo}from"./chunk-pV6VSnOa.js";import{i as ro,o as lo,p as ho}from"./chunk-4QByfKiN.js";import"./chunk-t4TbIqUg.js";import"./chunk-b85WE5Iw.js";import"./chunk-A1x0uTjV.js";import"./chunk-dKJxsAmi.js";import"./chunk-uWwJCq9p.js";import"./chunk-6cVeal0h.js";import"./chunk-b7wP5lso.js";const po=3025,co={default:15,far:25};let lt=class extends Pt{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=an(async i=>{const a=await nn("esri/core/t9n/Units");sn(i),this._messagesUnits=a});this.addHandles([f(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(i=>on(()=>this.context?.editGeometryOperations,i,()=>this._update())),F(()=>t.abort()),f(()=>this._colors,i=>this._updateStyle(i))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return co[this.edgeDistance]}get _colors(){const t=this.context?.view.effectiveTheme.textColor??tt.fromArray([255,255,255]);return{textColor:t,backgroundColor:ie(wa(t,rn.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const{context:t,stagedVertex:i}=this;if(!t)return this._destroyUnusedLabels();const{editGeometryOperations:a}=t,{components:n,geometry:s,coordinateHelper:o}=a.data;if(!s)return this._destroyUnusedLabels();const r=n.length;for(let l=0;l<r;++l){const h=uo(s,a,i,o,l);if(h.length<2||!go(h,t.view,t.elevationInfo,o.spatialReference))continue;const d=r===1&&!ln(h);let u=mo,g=fo;this.toScreenPointArray(t,h[0],u);for(let _=1;_<h.length;++_){const m=h[_-1],y=h[_];this.toScreenPointArray(t,y,g),this._addLabel(t,m,u,y,g,d),[u,g]=[g,u]}}this._destroyUnusedLabels()}_updateStyle({textColor:t,backgroundColor:i}){const a=this._nextLabelIndex,n=this._labelInfos;for(let s=0;s<a;++s){const{label:o}=n[s];o.textColor=t,o.backgroundColor=i}}_addLabel(t,i,a,n,s,o){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||hn(a,s)<po)return void(r.visible=!1);const{spatialReference:l}=t.editGeometryOperations.data,h=ja(i,n,l),d=this._messagesUnits,u=pn(t.view);r.text=d!=null&&h!=null?Ps(d,h,u):"",r.visible=!0;const g=s[0]-a[0],_=s[1]-a[1];o?Gt(rt,-_,g):Gt(rt,_,-g),xa(rt,rt),Oa(rt,rt,this._edgeDistancePixels),cn(ue,a,s,.5),un(ue,ue,rt),r.position=[ue[0],ue[1]],Math.abs(rt[0])>Math.abs(rt[1])?r.anchor=rt[0]>0?"left":"right":r.anchor=-rt[1]<0?"top":"bottom"}_getOrCreateLabel(t){const i=this._labelInfos.length>this._nextLabelIndex,{textColor:a,backgroundColor:n}=this._colors;if(i){const r=this._labelInfos[this._nextLabelIndex++],{label:l}=r;return l.textColor=a,l.backgroundColor=n,r}const s=new zs({anchor:"center",fontSize:8,textColor:a,backgroundColor:n});t.view.overlay?.items.add(s);const o={label:s};return this._labelInfos.push(o),this._nextLabelIndex=this._labelInfos.length,o}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){this.context?.view.overlay?.items.remove(t),t.destroy()}};function uo(e,t,i,a,n){const s=[];if(t.data.components[n].iterateVertices(l=>{s.push(a.toXYZ(l.pos,x.get()))}),n===0&&i!=null&&s.push(a.toXYZ(i,x.get())),s.length<2)return s;const o=s[0],r=s[s.length-1];return e.type==="polygon"&&s.length>2&&!dn(o,r)&&s.push(o),s}function go(e,t,i,a){if(t.type==="2d")return!0;const n=gn(a)??1,s=Ea(a),o=r=>_n(t,r,a,i,mn)??0;for(let r=1;r<e.length;++r){const l=e[r-1],h=e[r],d=(h[0]-l[0])*n,u=(h[1]-l[1])*n,g=(o(h)-o(l))*s;if(Math.abs(g)/Math.sqrt(d*d+u*u)>_o)return!1}return!0}p([c()],lt.prototype,"context",void 0),p([c()],lt.prototype,"stagedVertex",void 0),p([c()],lt.prototype,"visible",void 0),p([c()],lt.prototype,"edgeDistance",void 0),p([c()],lt.prototype,"updating",null),p([c()],lt.prototype,"_messagesUnits",void 0),p([c()],lt.prototype,"_edgeDistancePixels",null),p([c()],lt.prototype,"_colors",null),lt=p([k("esri.views.interactive")],lt);const _o=be(5),rt=ge(),ue=ge(),mo=Ye(),fo=Ye();let Xe=class extends lt{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:i,editGeometryOperations:a},n,s=Ye()){const{spatialReference:o}=a.data.coordinateHelper;return fn(n,o,i,t,ea),t.state.camera.projectToScreen(ea,s),s}};Xe=p([k("esri.views.3d.interactive.SegmentLabels3D")],Xe);const ea=$();function Di(e,t){const{graphic:i}=e;return[f(()=>e.displaying,a=>{a?vo(i,t):ia(i,t)},{...ae}),F(()=>ia(i,t))]}function vo(e,t){const{geometry:i}=e;qa(i,t)&&e.notifyMeshTransformChanged({action:Ta.EnableFastUpdates})}function ia(e,t){const{geometry:i}=e;qa(i,t)&&e.notifyMeshTransformChanged({action:Ta.DisableFastUpdates})}function qa(e,{state:{viewingMode:t},spatialReference:i}){if(e?.type!=="mesh")return!1;const{vertexSpace:a,spatialReference:n}=e;if(!Aa(a))return!1;const{type:s}=a;return t===_i.Global&&s==="local"||t===_i.Local&&vn(i,n)&&s==="georeferenced"&&!n.isGeographic}const ee=.3;function he(e,t){t&&Object.assign(e,t)}let yo=class{constructor(t){this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=V.Opaque,this.color=t.accent}},li=class{constructor({colors:t,...i}){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=t.accent,this.outlineColor=t.outline,this.renderOccluded=V.Opaque,this.hoverOutlineColor=t.selectedOutline,he(this,i)}applyColor(t){this._apply(this.color,t)}applyOutline(t){this._apply(this.outlineColor,t)}applyHoverOutline(t){this._apply(this.hoverOutlineColor,t)}_apply(t,i){i.setParameters({color:C(t),renderOccluded:this.renderOccluded})}},Mo=class{constructor({colors:t,...i}){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.renderOccluded=V.Transparent,this.minSquaredEdgeLength=900,this.color=ie(t.accent,.5),this.hoverColor=t.accent,he(this,i)}applyColor(t){this._apply(this.color,t)}applyHover(t){this._apply(this.hoverColor,t)}_apply(t,i){i.setParameters({color:C(t),renderOccluded:this.renderOccluded})}},bo=class{constructor(t){this.vertex=new li({colors:t,color:t.accent,outlineColor:t.outline}),this.edge=new li({colors:t,color:yn(ie(t.accent,2/3),.5),outlineColor:ie(t.outline,.5),size:8,collisionPadding:8}),this.selected=new li({colors:t,color:t.selected,outlineColor:t.outline}),this.edgeOffset=new Mo({colors:t})}},yi=class{constructor({colors:t,...i}){this.width=1.5,this.stipplePattern=Mn(3.3),this.falloff=0,this.innerWidth=1.5,this.renderOccluded=V.OccludeAndTransparent,this.color=t.selected,this.stippleOffColor=t.outline,this.innerColor=t.selected,he(this,i)}apply(t){t.color=C(this.color),t.width=this.width,t.stipplePattern=this.stipplePattern,t.stippleOffColor=C(this.stippleOffColor),t.falloff=this.falloff,t.innerWidth=this.innerWidth,t.innerColor=C(this.innerColor),t.renderOccluded=this.renderOccluded}},So=class{constructor({colors:t,...i}){this.size=4,this.outlineSize=1,this.shape="square",this.color=t.selected,this.outlineColor=t.outline,he(this,i)}apply(t){t.color=C(this.color),t.size=this.size,t.outlineSize=this.outlineSize,t.outlineColor=C(this.outlineColor),t.primitive=this.shape}},Ne=class{constructor({colors:t,...i}){this.innerWidth=1,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=ee,this.globalAlphaContrastBoost=1.5,this.radius=3,this.innerColor=t.selected,this.glowColor=t.accent,this.heightFillColor=t.accent,he(this,i)}apply(t,i=1){const a={glowColor:tt.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:tt.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i*this.glowColor.a,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in t?t.style=a:t.laserlineStyle=a}},wo=class{constructor(t){this.outline=new yi({colors:t,color:t.stippleOff,renderOccluded:V.OccludeAndTransparentStencil,stippleOffColor:t.stippleOn,innerWidth:0}),this.staged=new yi({colors:t,color:t.stippleOn,renderOccluded:V.OccludeAndTransparentStencil,innerColor:t.stagedSolid,stippleOffColor:t.stippleOff}),this.shadowStyle=new Ne({colors:t,globalAlpha:ee,glowColor:t.accent,glowFalloff:8,glowWidth:8,innerColor:t.selected,innerWidth:1})}};class xo{constructor(t){this.outline=new So({colors:t,color:t.selected,outlineColor:t.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Ne({colors:t,globalAlpha:ee,glowColor:t.accent,glowFalloff:1.5,glowWidth:6,innerColor:t.selected,innerWidth:1,radius:2})}}let Oo=class extends yi{constructor({colors:t,...i}){super({colors:t}),this.extensionType=Ia.GROUND_RAY,he(this,i)}},Eo=class{constructor(t){this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,this.lineGraphics=new wo(t),this.pointGraphics=new xo(t),this.heightPlane=new Ne({colors:t,globalAlpha:ee,glowColor:t.accent,glowFalloff:8,glowWidth:8,innerColor:t.selected,innerWidth:1}),this.heightBox=new Ne({colors:t,globalAlpha:ee,glowColor:t.accent,glowFalloff:8,glowWidth:8,innerColor:t.selected,innerWidth:0,heightFillColor:t.accent}),this.zVerticalLine=new Oo({colors:t,color:ie(t.accent,5*ee/3),falloff:2,innerColor:ie(t.selected,0),renderOccluded:V.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:Ia.GROUND_RAY})}},Y=class extends Pt{constructor(t){super(t)}get colors(){const t=this.getTheme().accentColor,i=t.a;return{accent:t,contrast:wa(t),selected:tt.fromArray([255,255,255,i]),selectedOutline:tt.fromArray([255,255,255,i]),staged:tt.fromArray([12,207,255,i]),stagedSolid:tt.fromArray([12,207,255,1]),outline:tt.fromArray([0,0,0,.5*i]),stippleOn:tt.fromArray([255,255,255,1]),stippleOff:tt.fromArray([0,0,0,.5])}}get visualElements(){return new Eo(this.colors)}get manipulators(){return new bo(this.colors)}get zManipulator(){return new yo(this.colors)}};p([c()],Y.prototype,"colors",null),p([c()],Y.prototype,"visualElements",null),p([c()],Y.prototype,"manipulators",null),p([c()],Y.prototype,"zManipulator",null),p([c()],Y.prototype,"getTheme",void 0),Y=p([k("esri.views.3d.interactive.editingTools.settings.Settings")],Y);let Nt=class extends bn{constructor(t){super(t),this._attachmentOrigin=Se(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new ft,this._geometry=null,this._width=1,this._color=Li(1,0,1,1),this._innerWidth=0,this._innerColor=Li(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=V.OccludeAndTransparentStencil,this._attachmentOrigin.spatialReference=t.view.spatialReference,this._laserline=new Re({view:t.view,isDecoration:t.isDecoration}),this.applyProperties(t),this.attached=t.attached??!0}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(t){return{view:t,createResources:i=>this._createObject3DResources(i),destroyResources:i=>this._destroyExternalResources(i),recreateGeometry:(i,a)=>{i.geometries.length=0,this._recreateGeometry(a,i.material,i.geometries)}}}createDrapedResourceFactory(t){return{view:t,createResources:()=>this._createDrapedResources(),destroyResources:i=>this._destroyExternalResources(i),recreateGeometry:i=>{i.geometries=this._createRenderGeometriesDraped(i.material),this._attachmentOriginChanged()}}}get _laserlineAttached(){return this.attached&&this.visible&&this._laserlineStyle!=null&&!this.isDraped&&this.laserlineEnabled}onAttachedChange(t){this._laserline.attached=this._laserlineAttached,t&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._updateMaterial())}get color(){return this._color}set color(t){oi(t,this._color)||(ki(this._color,t),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(t){t!==this._innerWidth&&(this._innerWidth=t,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(t){oi(t,this._innerColor)||(ki(this._innerColor,t),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const i=t!=null!=(this._stipplePattern!=null);this._stipplePattern=t,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){t&&this._stippleOffColor&&oi(t,this._stippleOffColor)||(this._stippleOffColor=t?Sn(t):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(t){t!==this._falloff&&(this._falloff=t,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,this._laserline.attached=this._laserlineAttached,t!=null&&(this._laserline.style=t)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const t=this.object3dResources.resources?.geometries;if(!t||t.length===0)return null;st(Yt,0,0,0);let i=0;for(const a of t)a.computeAttachmentOrigin(aa)&&(Ot(Yt,Yt,aa),i++);return i===0?null:(Ut(Yt,Yt,1/i),this.view.renderCoordsHelper.fromRenderCoords(Yt,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){this.object3dResources.resources!=null&&this.object3dResources.resources.material.setParameters(this._materialParameters),this.drapedResources.resources!=null&&this.drapedResources.resources.material.setParameters(this._materialParameters)}get _isClosed(){return this.geometry!=null&&this.geometry.type==="polygon"}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===V.OccludeAndTransparentStencil?V.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(t,i,a){this._createRenderGeometries(i,a);for(const n of a)t.addGeometry(n);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_destroyExternalResources(t){t.geometries=[]}_createObject3DResources(t){const i=new Hi(this._materialParameters),a=new Array;return this._recreateGeometry(t,i,a),{material:i,geometries:a,forEach:n=>{n(i),a.forEach(n)}}}_createDrapedResources(){const t=new Hi(this._materialParameters);return{material:t,geometries:this._createRenderGeometriesDraped(t)}}_createRenderGeometriesDraped(t){const{geometry:i,view:a}=this,n=a.basemapTerrain.spatialReference;return i==null||n==null?[]:wn(i,n).lines.map(({position:s})=>{const o={overlayInfo:{spatialReference:n,renderCoordsHelper:a.renderCoordsHelper},attributeData:{position:s},removeDuplicateStartEnd:this._isClosed};return new xn(Vi(t,o))})}calculateMapBounds(t){if(this.object3dResources.resources==null)return!1;const i=this.view.renderCoordsHelper;for(const a of this.object3dResources.resources.geometries){const n=a.attributes.get(On.POSITION),s=En(n.data.length);Tn(n.data,i.spatialReference,0,s,this.view.spatialReference,0,n.data.length/3),An(t,s)}return!0}_createRenderGeometries(t,i){const a=this.geometry;if(a==null)return;const n=In(a,this.view.elevationProvider,this.view.renderCoordsHelper,je.fromElevationInfo(this.elevationInfo??new Ga({mode:Gn(a,null)}))),s=new Array;for(const{position:o,mapPositions:r}of n.lines){const l={mapPositions:r,attributeData:{position:o},removeDuplicateStartEnd:this._isClosed};i.push(Vi(t,l)),s.push(o)}this._laserline.pathVerticalPlane=s}};const aa=$(),Yt=$();let et=class extends ft.EventedAccessor{constructor(t){super(t),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};p([c({constructOnly:!0})],et.prototype,"graphic",void 0),p([c()],et.prototype,"tracking",void 0),p([c()],et.prototype,"displaying",void 0),p([c()],et.prototype,"isDraped",void 0),et=p([k("esri.views.3d.layers.graphics.GraphicState")],et);function To(e,t){const i=e?.geometry;if(!e||i?.type!=="mesh"||!t)return;const{renderCoordsHelper:a,elevationProvider:n}=t,{camera:s}=t.state,{extent:o}=i,{center:r,spatialReference:l}=o,h=Ce(l),d=Ea(l),u=Ce(a.spatialReference),g=o.width*h,_=o.height*d,m=(o.zmax??0)*d,y=m-(o.zmin??0)*d,M=Math.max(g,_,y)/u,{x:E,y:v}=r,b=r.z??0;st(Te,E,v,b),a.toRenderCoords(Te,l,Te);const W=M/s.computeScreenPixelSizeAt(Te);if(W>s.width*Io)return"meshTooClose";if(W<Ao)return"meshTooFar";const it=H(e),{absoluteZ:Zt}=Dn(E,v,m,l,t,it);return Zt<(n.getElevation(E,v,b,l,"ground")??0)*d+y*Go?"meshUnderground":"mesh"}const Ao=20,Io=1,Go=.1,Te=$();let jt=class extends Vs{constructor(e){super(e),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new Y({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:e,offset:t,unit:i}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Ga({mode:e,offset:t,unit:i});const a=this.geometryToPlace;a&&this.addHandles([f(()=>a.vertexSpace.origin,()=>this.graphic?.notifyMeshTransformChanged(),se),f(()=>({vertexAttributes:a.vertexAttributes,alwaysUpdate:{}}),()=>this.graphic?.notifyGeometryChanged(),se)])}normalizeCtorArgs(e){if(!e.elevationInfo){const t=e.hasZ??!0;return{...e,elevationInfo:$n(t)}}return e}initializeGraphic(e){const{view:t}=this,i=this._createGraphicState=new et({graphic:e});return X([t.maskOccludee(e),t.trackGraphicState(i),f(()=>({element:this._outlineVisualElement,isDraped:i.isDraped}),({element:a,isDraped:n})=>{a&&(a.isDraped=n)},ae),this._setupLoadingIndicator(i),...Di(i,t)])}updateDrawMeshTooltipInfo(e){const{graphic:t,sketchOptions:i,view:a}=this;e.sketchOptions=i,e.viewType=a.type,e.helpMessage=To(t,this.view),this.updateElevation(e.elevation)}makeDrawOperation(){const{geometryType:e}=this,t=e!=="circle"&&e!=="rectangle";return new Rn({view:this.view,manipulators:this.manipulators,geometryType:Bs(e),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Cn(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Pn(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new ve,segmentLabels:t?new Xe:null,labelOptions:this.sketchOptions.labels,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Bi(this.hasZ,this.elevationInfo)==="on-the-ground",cursor:this.cursor,constraintsEnabled:!0})}onActiveVertexChanged(e){const{view:t}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[e],this._activeVertexVisualElement.recreate(),this._updateVerticalLineVisualElement(e),F();const i=this._settings,a=i.manipulators.vertex,n=new Ki({view:t,spatialReference:t.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=n;const s=i.visualElements.zVerticalLine,o=new bi({view:t,extensionType:s.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:V.OccludeAndTransparent,isDecoration:!0});this._verticalLineVisualElement=o;const r=X([f(()=>i.visualElements.zVerticalLine,l=>l.apply(o),D),f(()=>({selectedColor:C(i.colors.selected),outlineColor:C(i.manipulators.vertex.outlineColor)}),({selectedColor:l,outlineColor:h})=>{n.color=l,n.outlineColor=h},D),F(()=>{this._activeVertexVisualElement=R(this._activeVertexVisualElement),this._verticalLineVisualElement=R(this._verticalLineVisualElement)})]);return n.attached=!0,this._updateVerticalLineVisualElement(e),r}_updateVerticalLineVisualElement(e){const t=this._verticalLineVisualElement;if(!t)return;const{renderCoordsHelper:i,elevationProvider:a}=this.view;st(Wt,e[0],e[1],e[2]),na.setFromElevationInfo(this.elevationInfo),Wt[2]=Si(Wt,a,na,i),i.toRenderCoords(Wt,this.view.spatialReference,Wt)?(t.setStartEndFromWorldDownAtLocation(Wt),t.attached=!0):t.attached=!1}onOutlineChanged(e){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=e,F();const t=this.internalGraphicsLayer.elevationInfo,{view:i}=this,a=this._settings,n=new Nt({view:i,geometry:e,elevationInfo:t,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Bi(this.hasZ,t)==="on-the-ground",attached:!1,isDecoration:!0});this._outlineVisualElement=n;const s=X([f(()=>a.visualElements.lineGraphics.outline,o=>o.apply(n),D),f(()=>a.visualElements.lineGraphics.shadowStyle,o=>o.apply(n),D),F(()=>{this._outlineVisualElement=R(this._outlineVisualElement)})]);return n.attached=!0,n.laserlineEnabled=!0,s}onRegularVerticesChanged(e){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=e,F();const{view:t}=this,i=this._settings,a=i.manipulators.vertex,n=new Ki({view:t,spatialReference:t.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0}),s=X([f(()=>({color:C(i.manipulators.vertex.color),outlineColor:C(i.manipulators.vertex.outlineColor)}),({color:o,outlineColor:r})=>{n.color=o,n.outlineColor=r},D),F(()=>{this._verticesVisualElement=R(this._verticesVisualElement)})]);return n.attached=!0,this._verticesVisualElement=n,s}updateGraphicGeometry(e){if(this.geometryType!=="mesh"||e?.type!=="point")super.updateGraphicGeometry(e);else{const t=this.geometryToPlace;t?.centerAt(e);const i=this._graphic;t&&i.geometry===t||(i.geometry=t)}}_setupLoadingIndicator(e){const{drawOperation:t}=this;if(!this.geometryToPlace)return t.loading=!1,null;t.loading=!0;const i=F(()=>{t.loading=!1});let a;const n=()=>a&&cancelAnimationFrame(a);return X([ne(()=>e.displaying,()=>{n(),a=requestAnimationFrame(()=>i.remove())},{...ae,once:!0}),F(n),i])}};p([c({constructOnly:!0})],jt.prototype,"elevationInfo",void 0),p([c({constructOnly:!0})],jt.prototype,"geometryType",void 0),p([c()],jt.prototype,"type",void 0),p([c({constructOnly:!0})],jt.prototype,"view",void 0),jt=p([k("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],jt);const na=new je,Wt=$();function Do(e){const t=$i(e);return zn(Math.cos(t),Math.sin(t))}function $i(e){if(e==null||e.type!=="polyline"&&e.type!=="polygon")return 0;const t=e.type==="polyline"?e.paths:e.rings,i=Ln();for(const a of t)for(let n=0;n<a.length-1;n++){const s=a[n],o=a[n+1],r=s[0]-o[0],l=s[1]-o[1];if(r*r+l*l>i)return Math.atan2(o[1]-s[1],o[0]-s[0])}return 0}var ct;(function(e){e[e.NONE=0]="NONE",e[e.ANY=1]="ANY",e[e.Z=2]="Z",e[e.XY=4]="XY"})(ct||(ct={}));var I;(function(e){e[e.TRANSLATE_Z=0]="TRANSLATE_Z",e[e.TRANSLATE_XY=1]="TRANSLATE_XY",e[e.SCALE=2]="SCALE",e[e.ROTATE=3]="ROTATE",e[e.SCALE_ROTATE=4]="SCALE_ROTATE"})(I||(I={}));let Ja=class{constructor(){this.grabbingState=ct.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=ct.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator((i,a)=>{if(a===I.TRANSLATE_Z&&(this.zManipulator=i),i instanceof ot&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),this.firstGrabbedXY==null&&i.grabbing&&a===I.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=ct.ANY,a){case I.TRANSLATE_Z:this.grabbingState|=ct.Z;break;case I.TRANSLATE_XY:this.grabbingState|=ct.XY}})}};function $o(e){const{view:t,graphic:i}=e,a=new et({graphic:i}),n=Ro(e,a),s=[n,Co(e,n.visualElement,a),t.maskOccludee(i),t.trackGraphicState(a)];return{visualElement:n.visualElement,remove:()=>wi(s)}}function Ro(e,t){const{view:i,graphic:a}=e,n=new Nt({view:i,geometry:Mi(a)?a.geometry:null,elevationInfo:H(a),attached:!1,isDecoration:!0}),s=new Y({getTheme:()=>i.effectiveTheme}),o=()=>{n.attached=t.displaying},r=X([f(()=>s.visualElements.lineGraphics.outline,l=>l.apply(n),D),f(()=>s.visualElements.lineGraphics.shadowStyle,l=>l.apply(n),D),f(()=>t.displaying,o),f(()=>t.isDraped,l=>{n.isDraped=l}),t.on("changed",()=>n.geometry=Mi(a)?a.geometry:null),Rt(n)]);return o(),{visualElement:n,remove:()=>r.remove()}}function Co(e,t,i){const{graphic:a,view:n}=e,s=[],o=H(a),r=o.mode==="on-the-ground"||!o.offset&&o.mode!=="absolute-height",l=new Ja,h=new Y({getTheme:()=>n.effectiveTheme}),d=h.visualElements,u=new bi({view:n,extensionType:d.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:V.OccludeAndTransparent,isDecoration:!0}),g=be(d.heightPlaneAngleCutoff),_=new Re({view:n,attached:!1,angleCutoff:g,isDecoration:!0}),m=Pe(1);s.push(f(()=>({lineShadowStyle:h.visualElements.lineGraphics.shadowStyle,pointShadowStyle:h.visualElements.pointGraphics.shadowStyle,alpha:m.value}),({lineShadowStyle:b,pointShadowStyle:W,alpha:it})=>{b.apply(t,it),W.apply(u,it)},D));const y=Pe(1);s.push(f(()=>({heightPlane:h.visualElements.heightPlane,alpha:y.value}),({heightPlane:b,alpha:W})=>b.apply(_,W),D));const M=()=>{if(l.update(e),!i.displaying||r&&(i.isDraped||!Mi(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,u.attached=!1,void(_.attached=!1);t.laserlineEnabled=!0;const b=l.grabbingState&ct.XY?d.laserlineAlphaMultiplier:1;m.value=b;const W=l.grabbingState&ct.Z?d.laserlineAlphaMultiplier:1;y.value=W,Po(u,l),zo(e,t,_,l)};s.push(f(()=>h.visualElements.zVerticalLine,b=>b.apply(u),D)),s.push(i.on("changed",M),f(()=>i.displaying,M),t.events.on("attachment-origin-changed",M),Rt(u),Rt(_));const E=[],v=()=>{wi(E),E.length=0,e.forEachManipulator(b=>E.push(b.events.on("grab-changed",M))),e.forEachManipulator(b=>E.push(b.events.on("select-changed",M))),M()};return v(),s.push(e.onManipulatorsChanged(v),Da(()=>X(E))),X(s)}function Po(e,t){const i=t.numSelected===1?t.firstSelected:t.numSelected>1&&t.firstGrabbedXY!=null?t.firstGrabbedXY:null;i!=null?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}function zo(e,t,i,a){if(a.numSelected>0){st(kt,0,0,0);let n=0;e.forEachManipulator((s,o)=>{o===I.TRANSLATE_XY&&s.selected&&s instanceof ot&&(Ot(kt,kt,s.renderLocation),n++)}),n>0?(i.heightManifoldTarget=Ut(kt,kt,1/n),i.attached=!0):i.attached=!1}else{const n=t.attachmentOrigin;n!=null&&e.view.renderCoordsHelper.toRenderCoords(n,kt)?(i.heightManifoldTarget=kt,i.attached=!0):i.attached=!1}}function Mi(e){return e.geometry!=null&&(e.geometry.type==="polygon"||e.geometry.type==="polyline")}const kt=$();function Lo(e){const{view:t,graphic:i}=e,a=new et({graphic:i}),n=[],s=Ho(e,a,n);return ko(e,a,n,s),n.push(t.trackGraphicState(a)),{visualElement:s,remove:()=>wi(n)}}function ko(e,t,i,a){const{view:n,graphic:s}=e,o=new Y({getTheme:()=>n.effectiveTheme}),r=new bi({view:n,extensionType:o.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:V.OccludeAndTransparent,isDecoration:!0});i.push(f(()=>o.visualElements.zVerticalLine,v=>v.apply(r),D));const l=new Re({view:n,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),h=be(o.visualElements.heightPlaneAngleCutoff),d=new Re({view:n,attached:!1,angleCutoff:h,isDecoration:!0}),u=H(e.graphic),g=je.fromElevationInfo(u),_=u.mode==="on-the-ground"||!u.offset&&u.mode!=="absolute-height",m=new Ja,y=Pe(1);i.push(f(()=>({heightPlane:o.visualElements.heightPlane,alpha:y.value}),({heightPlane:v,alpha:b})=>v.apply(d,b),D));const M=Pe(1);i.push(f(()=>({shadowStyle:o.visualElements.pointGraphics.shadowStyle,alpha:M.value}),({shadowStyle:v,alpha:b})=>v.apply(l,b),D));const E=()=>{m.update(e);const v=Ri(s),b=_&&(t.isDraped||v==null||!v.hasZ);let W=!0;if(b||v==null)W=!1;else{const at=Si(v,n.elevationProvider,g,n.renderCoordsHelper);st(pt,v.x,v.y,at),Ui(pt,v.spatialReference,pt,n.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(pt),l.intersectsWorldUpAtLocation=pt}const it=m.grabbingState&ct.Z?o.visualElements.laserlineAlphaMultiplier:1;y.value=it;const Zt=Vn(Fo);!b&&t.displaying&&a.calculateMapBounds(Zt)&&Ui(Bn(Zt,pt),n.spatialReference,pt,n.renderCoordsHelper.spatialReference)?(d.heightManifoldTarget=pt,d.attached=!0):d.attached=!1;const A=m.grabbingState&ct.XY?o.visualElements.laserlineAlphaMultiplier:1;M.value=A;const q=W&&t.displaying&&!b;l.attached=q,r.attached=q};i.push(f(()=>[t.displaying,t.isDraped],E),t.on("changed",E)),e.forEachManipulator(v=>{i.push(v.events.on("grab-changed",E))}),i.push(Rt(l)),i.push(Rt(r)),i.push(Rt(d)),E()}function Ho(e,t,i){const{view:a,graphic:n}=e,s=new Hn({view:a,geometry:Ri(n),elevationInfo:H(n),isDecoration:!0});return Vo(e,s,t,i),i.push(Rt(s)),s}function Ri(e){const t=e.geometry;return t==null?null:t.type==="point"?t:t.type==="mesh"?t.anchor.clone():null}function Vo(e,t,i,a){const n=()=>{t.attached=i.displaying},s=new Y({getTheme:()=>e.view.effectiveTheme});Bo(e,t,i,a),s.visualElements.pointGraphics.outline.apply(t),a.push(f(()=>i.displaying,n,D))}function Bo(e,t,i,a){const{view:n,graphic:s}=e;let o=null;const r=h=>{o!=null&&(o.remove(),o=null),i.isDraped&&h!=null&&(o=Uo(n,h,()=>{t.geometry=h}))},l=()=>{const h=Ri(s);r(h),t.geometry=h};a.push(i.on("changed",l),Da(()=>o)),l()}function Uo(e,t,i){const a=e.elevationProvider.spatialReference;Un(t,pt,a);const n=pt[0],s=pt[1];return e.elevationProvider.on("elevation-change",o=>{$a(o.extent,n,s)&&i()})}const pt=$(),Fo=kn();function ai(e){switch(e.graphic.geometry.type){case"point":case"mesh":return Lo(e);case"polygon":case"polyline":return $o(e);default:return null}}const Ka=128,mt=70,Xo=80,Qa=.02,No=54,Zo=100,tn=Math.ceil(mt/3*2),Vt=160,hi=.5,pi=24,qt=9,Yo=Vt+30,sa=Vt+53,jo=60,Wo=23,qo=5*Math.PI/12,Jo=1*Math.PI/3,oa=10,ra=.2,la=30,ha=53,pa=.2,ca=.3,Ko=200,Qo=3,tr=1e6;class Oe{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(i=>i.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(i=>i.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(i=>i.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(i=>{t||(t=i.renderLocation)}),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(i=>i.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}hasManipulator(t){return this.someManipulator(i=>i===t)}someManipulator(t){let i=!1;return this.forEachManipulator(a=>{!i&&t(a)&&(i=!0)}),i}_forEachManipulator3D(t){this.forEachManipulator((i,a)=>{i instanceof ot&&t(i,a)})}}function ni(e,t,i){const a=(n,s)=>t({action:n,graphic:e,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY});return i((n,s,o)=>(s.next(r=>(r.action==="start"&&a("start",r),r)).next(Fn(e)).next(r=>{switch(r.action){case"start":case"update":(r.translationX||r.translationY||r.translationZ)&&a("update",r);break;case"end":a("end",r)}return r}),{steps:s,cancel:o=o.next(Xn(e)).next(r=>(a("end",{screenDeltaX:0,screenDeltaY:0}),r))}))}function Ze(e){if(e?.axis==null)return 1;const{mapStart:t,mapEnd:i,axis:a}=e,n=[i.x-t.x,i.y-t.y];return n[0]*a[0]+n[1]*a[1]>0?1:-1}let er=class extends Oe{constructor(t){super(),this._handles=new We,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=mt,this._updateAfterDrag=!1,this.events=new ft,this._tool=t.tool,this._view=t.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),t.radius!=null&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=R(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:i}of this._arrowManipulatorInfos)t(i,I.TRANSLATE_XY)}createGraphicDragPipeline(t,i,a){const n=i.graphic,s=H(n),o=n.geometry.spatialReference;return ni(n,a,r=>this.createDragPipeline((l,h,d,u,g)=>({steps:h,cancel:d}=t(l,h,d,u,g),r(l,h,d)),s,o,n))}createDragPipeline(t,i,a,n){return X(this._arrowManipulatorInfos.map(({manipulator:s},o)=>ut(s,(r,l,h,d,u)=>{const g=l.next(_=>({..._,manipulatorType:I.TRANSLATE_XY})).next(_e(this._view,r.elevationAlignedLocation)).next(xi(this._view,r.elevationAlignedLocation,i,a,n)).next(Nn(r.location,this.angle+(o+1)*Math.PI*.5)).next(le());t(r,g,h,d,u)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:i},a){const n=this._radius/mt,s=No*n,o=s*Math.sqrt(3)/2,r=ze(this._opaqueMaterial,o,s/2,s/2,Qa);Ra(r,Fi(Z.get(),st(x.get(),0,-o/3,0))),t.renderObjects=[new w(r,O.Focused),new w(r.instantiate({material:this._transparentMaterial}),O.Unfocused)],t.radius=o/3*2*1.2;const l=Zn(Z.get(),a*Math.PI/2),h=Fi(Z.get(),st(x.get(),0,Zo*n,0));$e(i,l,h)}_createManipulators(){for(let t=0;t<4;t++){const i=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,i=Ca(Z.get(),t,j(0,0,1));if(i==null)return;const a=Le(Z.get(),st(x.get(),this.displayScale,this.displayScale,this.displayScale)),n=$e(Z.get(),a,i);for(const s of this._arrowManipulatorInfos){const o=$e(Z.get(),n,s.transform);s.manipulator.modelTransform=o}}_createArrowManipulator(t){const i=new ot({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:j(0,0,1)}}),a={manipulator:i,transform:qe()};return this._updateArrowManipulator(a,t),this._handles.add(i.events.on("drag",n=>{this._updateAfterDrag&&n.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(t=1){const i=new Oi({cullFace:Ei.Back,renderOccluded:V.Transparent,isDecoration:!0});return this._handles.add(f(()=>tt.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=t,i.setParameters({color:a})},D)),i}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:t})=>t)}}},ir=class{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const i=this._lastDragEvent.mapEnd,a=this._snap(this._lastDragEvent.screenEnd);if(a!=null){const n={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:t===!0?a:i,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(n)}}this._enabled=t}_snap(t){const i=this._view!=null?this._view.toMap(t,{exclude:[]}):null;return i!=null&&this._view!=null&&(i.z=Yn(i,this._view,this._elevationInfo)),i}createDragEventPipelineStep(t,i){this._view=t,this._elevationInfo=i,this._lastDragEvent=null;const a=new Pa;return this._next=a,[n=>{if(this._lastDragEvent=n.action!=="end"?{...n}:null,this._enabled){const s=this._snap(n.screenEnd);return s!=null?{action:n.action,mapStart:n.mapStart,mapEnd:s,screenStart:n.screenStart,screenEnd:n.screenEnd}:null}return{action:n.action,mapStart:n.mapStart,mapEnd:n.mapEnd,screenStart:n.screenStart,screenEnd:n.screenEnd}},a]}},ar=class extends Oe{constructor(t){super(),this._handles=new We,this._snapToScene=new ir,this._scale=1,this._radius=mt,this._view=t.view,this._tool=t.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),t.snapToScene!=null&&(this.snapToScene=t.snapToScene),t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles=R(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,I.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,i,a){const n=i.graphic,s=H(n),o=n.geometry.spatialReference;return ni(n,a,r=>this.createDragPipeline((l,h,d,u,g)=>({steps:h,cancel:d}=t(l,h,d,u,g),r(l,h,d)),s,o,n))}createDragPipeline(t,i,a,n){const s=this._view;return ut(this._manipulator,(o,r,l,h,d)=>{const u=r.next(_e(s,o.elevationAlignedLocation)).next(xi(s,o.elevationAlignedLocation,i,a,n)).next(...this._snapToScene.createDragEventPipelineStep(s,i)).next(g=>({...g,manipulatorType:I.TRANSLATE_XY})).next(le());t(o,u,l,h,d)})}_updateManipulatorTransform(){const t=Le(Z.get(),st(x.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new ot({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:j(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=jn(this._discMaterial,Qa,1,Ka,j(0,0,1),j(0,0,0));t.transformation=Le(qe(),j(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new w(t,O.Focused),new w(t.instantiate({material:this._discMaterialTransparent}),O.Unfocused)],this._manipulator.radius=Xo*(this._radius/mt)}_createMaterial(t=1){const i=new Oi({cullFace:Ei.Back,renderOccluded:V.Transparent,isDecoration:!0});return this._handles.add(f(()=>tt.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=t,i.setParameters({color:a})},D)),i}get test(){return{discManipulator:this._manipulator}}},nr=class extends Oe{constructor(t){super(),this._radius=mt,this.events=new ft,this._tool=t.tool,this._view=t.view;const i=new Y({getTheme:()=>this._view.effectiveTheme});this._settings=i,t.radius!=null&&(this._radius=t.radius);const a=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:xt(this._createDarkenedColor(a,1,.25),V.Occlude),materialFocused:xt(this._createDarkenedColor(a,1,0),V.Occlude),materialOccludedUnfocused:xt(this._createDarkenedColor(a,.7,0),i.zManipulator.renderOccluded),materialOccludedFocused:xt(this._createDarkenedColor(a,.85,0),i.zManipulator.renderOccluded)},this._themeHandle=f(()=>this._view.effectiveTheme.accentColor,n=>{const s=this._createDarkenedColor(n,1,.25),o=this._createDarkenedColor(n,1,0),r=this._createDarkenedColor(n,.7,0),l=this._createDarkenedColor(n,.85,0),{materialUnfocused:h,materialFocused:d,materialOccludedUnfocused:u,materialOccludedFocused:g}=this._materials;h.setParameters({color:s}),d.setParameters({color:o}),u.setParameters({color:r}),g.setParameters({color:l})}),this._createManipulator(),this.forEachManipulator(n=>this._tool.manipulators.add(n))}destroy(){this._themeHandle=vt(this._themeHandle),this._manipulator.applyObjectTransform=or,this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,I.TRANSLATE_Z)}createGraphicDragPipeline(t,i,a){const n=i.graphic.geometry.spatialReference;return ni(i.graphic,a,s=>this.createDragPipeline((o,r,l,h,d)=>({steps:r,cancel:l}=t(o,r,l,h,d),s(o,r,l)),n))}createDragPipeline(t,i){const a=this._view;return ut(this._manipulator,(n,s,o,r,l)=>{const h=s.next(d=>({...d,manipulatorType:I.TRANSLATE_Z})).next(za(a,n.renderLocation,i)).next(le());t(n,h,o,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,i=this._radius/mt,a=t.zManipulator.height*i,n=t.zManipulator.coneHeight*i,s=t.zManipulator.coneWidth*i,o=t.zManipulator.width*i,r=[j(0,0,0),j(0,0,a)],l=[j(0,0,0),j(0,0,a+n)],h=E=>{const v=qe();if(Qn(v,v,[0,0,a]),La(v,v,Math.PI/2),E){const b=1+2*E/s;ka(v,v,[b,b,b])}return v},d=h(0),{materialUnfocused:u,materialFocused:g,materialOccludedUnfocused:_,materialOccludedFocused:m}=this._materials,y=Wn(u,r,o/2,16,!1),M=qn(u,n,s/2,16,!1);M.transformation=d,this._manipulator.renderObjects=[new w(M,O.Unfocused),new w(y,O.Unfocused),new w(M.instantiate({material:g}),O.Focused),new w(y.instantiate({material:g}),O.Focused),new w(M.instantiate({material:_}),O.Unfocused),new w(y.instantiate({material:_}),O.Unfocused),new w(M.instantiate({material:m}),O.Focused),new w(y.instantiate({material:m}),O.Focused)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const t=this._view,i=new ot({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});i.applyObjectTransform=a=>{const n=t.state.camera,s=ua;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,s);const o=Jn(n.eye,s),r=n.computeRenderPixelSizeAtDist(o),l=P(Jt,s,n.eye);mi(l,l);const h=sr;t.renderCoordsHelper.worldUpAtPosition(ua,h);const d=Math.abs(ke(l,h)),u=Ct(Jt,l,h),g=Ct(Jt,u,h),_=fi(d,.01,1),m=1-Math.sqrt(1-_*_)/_/n.fullWidth,y=this._settings,M=this._radius/mt,E=y.zManipulator.width*M;Ut(g,mi(g,g),(1/m-1)*o+r*E),a[12]-=Jt[0],a[13]-=Jt[1],a[14]-=Jt[2]},this._manipulator=i,this._updateManipulator()}_createDarkenedColor(t,i,a){const n=Kn(t,a);return n.a*=i,tt.toUnitRGBA(n)}get test(){return{manipulator:this._manipulator}}};const ua=$(),Jt=$(),sr=$(),or=()=>{};class Xt extends Oe{constructor(t){super(),this._handles=new We,this._interactive=!0;const{tool:i,view:a,snapToScene:n,radius:s}=t;this._view=a,this.xyManipulation=new ar({tool:i,view:a,snapToScene:n,radius:s}),this.xyAxisManipulation=new er({tool:i,view:a,radius:s}),this.zManipulation=new nr({tool:i,view:a,radius:s}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(o=>this._handles.add(o.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,i,a){return X([this.xyManipulation.createGraphicDragPipeline((n,s,o,r,l)=>t(S.XY,n,s,o,r,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((n,s,o,r,l)=>t(S.XY_AXIS,n,s,o,r,l),i,a),this.zManipulation.createGraphicDragPipeline((n,s,o,r,l)=>t(S.Z,n,s,o,r,l),i,a)])}createDragPipeline(t,i,a,n){return X([this.xyManipulation.createDragPipeline((s,o,r,l,h)=>t(S.XY,s,o,r,l,h),i,a,n),this.xyAxisManipulation.createDragPipeline((s,o,r,l,h)=>t(S.XY_AXIS,s,o,r,l,h),i,a,n),this.zManipulation.createDragPipeline((s,o,r,l,h)=>t(S.Z,s,o,r,l,h),a)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(i=>t(i,I.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>t(i,I.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>t(i,I.TRANSLATE_Z))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,i=this.xyManipulation;if(ts("esri-mobile"))return;const a=[];i.forEachManipulator(s=>a.push(s)),t.forEachManipulator(s=>a.push(s));const n=()=>{const s=[];this._xyAxisVisible||t.forEachManipulator(o=>s.push(o.disableDisplay())),this._handles.remove(da),this._handles.add(s,da)};for(const s of a)this._handles.add(s.events.on("focus-changed",n));this._view.inputManager&&this._handles.add(ne(()=>this._view.inputManager?.latestPointerType,n)),n()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(i=>{i.interactive=!t&&this._interactive||i.grabbing})}static radiusForSymbol(t){const i=t!=null&&t.type==="point-3d"&&t.symbolLayers;return i&&i.some(a=>a.type==="icon")?tn:mt}}const da="disable-xy-axis-display";var S;(function(e){e[e.XY=0]="XY",e[e.XY_AXIS=1]="XY_AXIS",e[e.Z=2]="Z"})(S||(S={}));class Ci extends Oe{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,I.TRANSLATE_XY)}createGraphicDragPipeline(t){return ni(this._graphicState.graphic,t,i=>this.createDragPipeline(i))}createDragPipeline(t){const i=this._view,a=this._graphicState.graphic,n=a.geometry!=null?a.geometry.spatialReference:null;return ut(this._manipulator,(s,o,r,l,h)=>{const d=o.next(es(h,i,a,n)).next(Qt()).next(le());t(s,d,r,l,h)})}_createManipulator(){const t=this._view,i=this._graphicState.graphic;this._manipulator=new Xs({graphic:i,view:t,selectable:!0,cursor:"move"})}}class rr{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class lr{constructor(t,i,a){this.dx=t,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class ga{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const dt="manipulators";let gt=class extends ft.EventedMixin(Je){constructor(e){super(e),this._infos=new Map,this.graphics=new is,this.enableZ=!0,this.sketchOptions=new zt,this.type="move-3d",this.tooltip=null,this._updatingHandles=new Ti,this._moveManipulation=null,this._latestTooltipInfo=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{view:e}=this;this.addHandles([this.graphics.on("change",i=>{i.removed.forEach(a=>this.removeHandles(a)),this._updateGraphicInfos(i),this._setupFastTransformUpdates(i.added),this._refreshManipulators()}),f(()=>this.sketchOptions.tooltips.effectiveEnabled,i=>{this.tooltip=i?new xe({info:this._latestTooltipInfo,view:e}):R(this.tooltip)},ae)]);const t=this.graphics.toArray();this._updateGraphicInfos({added:t,removed:[]}),this._setupFastTransformUpdates(t),this._refreshManipulators(),this.finishToolCreation()}destroy(){this.tooltip=R(this.tooltip),this._moveManipulation=R(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:e,removed:t}){for(const i of e){if(as(i)!==Ha.SUPPORTED)continue;const a=new hr(i),n=this.view.trackGraphicState(a.state);this._infos.set(a.graphic,{info:a,handle:n})}for(const i of t)this._infos.get(i)?.handle.remove(),this._infos.delete(i)}_setupFastTransformUpdates(e){const{view:t}=this;for(const i of e){const{info:a}=this._infos.get(i);this.addHandles(Di(a.state,t),i)}}_refreshManipulators(){if(this.removeHandles(dt),this._moveManipulation=R(this._moveManipulation),this.manipulators.removeAll(),this._infos.size===0)return;const e=Array.from(this._infos.values(),({info:t})=>t);this._createManipulators(e),this._createVisualElements(e),this._updateMoveManipulation(e)}_createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Ci({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator(a=>this.addHandles([a.events.on("immediate-click",n=>{this.emit("immediate-click",{...n,graphic:i.graphic}),n.stopPropagation()}),a.events.on("grab-changed",({action:n})=>{n==="start"?this._showTooltip(S.XY):this._hideTooltip()})],dt)),this.addHandles(t.manipulationXY.createDragPipeline((a,n,s,o)=>this._buildDragEventPipeline(e,S.XY,a,n,s,o)),dt)}this._createMoveManipulation(e)}_createMoveManipulation(e){const t=new Xt({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:e.length===1?Xt.radiusForSymbol(e[0].graphic.symbol):mt});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator(s=>{this.addHandles(s.events.on("immediate-click",o=>{t.zManipulation.hasManipulator(s)||this.graphics.length!==1||this.emit("immediate-click",{...o,graphic:this.graphics.at(0)}),o.stopPropagation()}),dt)});const i=s=>o=>{this.addHandles([o.events.on("focus-changed",({action:r})=>{r==="focus"?this._showTooltip(s):this._hideTooltip()}),o.events.on("grab-changed",()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=nt)})],dt)};this._moveManipulation.xyManipulation.forEachManipulator(i(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(S.Z));const a=()=>this._updateMoveManipulation(e);for(const s of e)this.addHandles([s.state.on("changed",a),f(()=>s.state.displaying,a)],dt);const n=e[e.length-1];this.addHandles(n.state.on("changed",()=>this._updateMoveManipulationAngle(n)),dt),this.addHandles(t.createDragPipeline((s,o,r,l,h)=>this._buildDragEventPipeline(e,s,o,r,l,h),H(n.graphic),n.graphic.geometry.spatialReference,n.graphic),dt),this._updateMoveManipulationAngle(n)}_createVisualElements(e){for(const t of e){const i=t.graphic,a=ai({view:this.view,graphic:i,forEachManipulator:n=>{t.manipulationXY?.forEachManipulator(n),this._moveManipulation?.forEachManipulator(n)},onManipulatorsChanged:()=>F()});a!=null&&(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof Nt&&this.addHandles([t.geometryRepresentation.events.on("attachment-origin-changed",()=>{t.state.isDraped||this._updateMoveManipulation(e)}),f(()=>t.state.isDraped,()=>this._updateMoveManipulation(e))],dt),this.addHandles(a,dt))}}_updateMoveManipulationAngle(e){this._moveManipulation&&(this._moveManipulation.angle=$i(e.graphic.geometry))}_updateMoveManipulation(e){const t=Se(0,0,0,this.view.spatialReference);let i=0,a=!1;const n=this._moveManipulation;if(n){for(const s of e){if(!s.state.displaying)continue;const o=s.state.graphic;this.enableZ&&Ft(o)&&(a=!0);const r=s.geometryRepresentation instanceof Nt&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:Va(this.view,o);if(r!=null){const{x:l,y:h,z:d}=r;t.x+=l,t.y+=h,d&&(t.z??=0,t.z+=d),i++}}i>0?(t.x/=i,t.y/=i,t.z??=0,t.z/=i,n.location=t,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1}}_buildDragEventPipeline(e,t,i,a,n,s){const o=[],r=[];let l=null,h=null;const d=()=>{for(const u of o)u.dragging=!1;o.length=0,r.length=0,l=null,h=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(e.length===1&&t===S.XY){const u=e[0].graphic;({steps:a,cancel:n}=this._buildSnappingPipelineSteps(u,H(u),a,n,s))}return n=n.next(u=>h?.(u)).next(()=>(this.emit("graphic-move-stop",new ga(r)),this.destroyed||d(),null)),{steps:a=a.next(u=>{if(u.action==="start"){o.length=0,r.length=0;for(const g of e)g.dragging||!g.manipulationXY?.hasManipulator(i)&&g.manipulationXY?.grabbing||(o.push(g),r.push(g.graphic),g.dragging=!0);if(r.length!==0&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=ns(r),h=ss(r),this.emit("graphic-move-start",new rr(r)),this.destroyed))return null}return r.length!==0?u:null}).next(u=>l?.(u)).next(u=>(this._updateMoveTooltip(t,u),u)).next(u=>{switch(u.action){case"start":case"update":if(u.translationX||u.translationY||u.translationZ){const g=this.view.toScreen(u.mapStart),_=this.view.toScreen(u.mapEnd),m=_.x-g.x,y=_.y-g.y;if(this.emit("graphic-move",new lr(m,y,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new ga(r)),this.destroyed)return null;d()}return null}),cancel:n}}_showTooltip(e){this._updateMoveTooltip(e),this._latestTooltipInfo&&(this._latestTooltipInfo.distance=nt)}_hideTooltip(){this.tooltip?.clear(),this._latestTooltipInfo=null}_updateMoveTooltip(e,t){const{sketchOptions:i,tooltip:a}=this;switch(e){case S.XY:this._latestTooltipInfo=this._translateGraphicTooltipInfo??=new ii({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,t,(n,s)=>$t(n,s));break;case S.XY_AXIS:this._latestTooltipInfo=this._translateGraphicXYTooltipInfo??=new Gi({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,t,(n,s)=>He($t(n,s),Ze(t)));break;case S.Z:this._latestTooltipInfo=this._translateGraphicZTooltipInfo??=new ei({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,t,Fe)}this._latestTooltipInfo.sketchOptions=i,a&&(a.info=this._latestTooltipInfo)}_updateMoveTooltipDistance(e,t,i){if(t==null||t.action==="end")return;const{mapStart:a,mapEnd:n}=t,s=i(a,n);e.distance=s??nt}_buildSnappingPipelineSteps(e,t,i,a,n){const s=e.geometry;if(s==null||s.type!=="point"&&s.type!=="mesh")return{steps:i,cancel:a};const o=(s.type==="point"?s:s.anchor).clone(),r=new Ve({elevationInfo:t,pointer:n,editGeometryOperations:Ke.fromGeometry(o,this.view.state.viewingMode),visualizer:new ve,excludeFeature:e}),l=this.snappingManager,{snappingStep:h,cancelSnapping:d}=Be({snappingContext:r,snappingManager:l,updatingHandles:this._updatingHandles});return a=a.next(d),{steps:i=i.next(u=>(o.z=os(this.view,o,H(e),{mode:"absolute-height",offset:0}),{...u,snapOrigin:r.coordinateHelper.pointToVector(o)})).next(...h),cancel:a}}};p([c({constructOnly:!0,nonNullable:!0})],gt.prototype,"view",void 0),p([c()],gt.prototype,"graphics",void 0),p([c({constructOnly:!0,nonNullable:!0})],gt.prototype,"enableZ",void 0),p([c({constructOnly:!0,type:zt})],gt.prototype,"sketchOptions",void 0),p([c({constructOnly:!0})],gt.prototype,"snappingManager",void 0),p([c()],gt.prototype,"type",void 0),p([c()],gt.prototype,"updating",null),p([c()],gt.prototype,"tooltip",void 0),gt=p([k("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],gt);class hr{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new et({graphic:t})}get graphic(){return this.state.graphic}}function _a(e,t,i){const a=i.mode==="on-the-ground"?Xi.XY:Xi.XYZ;return new rs(e,a,t,0)}function ma(e,t,i){const a=$();if(!e.renderCoordsHelper.toRenderCoords(t,a))return null;const n=fa(e,t,we(i.plane)),s=fa(e,t,i.edgeDirection);if(n==null||s==null)return null;const o=Ct($(),n,s);return Ba(a,o,Ai())}function fa(e,t,i){const a=Se(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),n=$(),s=$();return e.renderCoordsHelper.toRenderCoords(t,n)&&e.renderCoordsHelper.toRenderCoords(a,s)?Ua(s,n,s):null}function pr(e,t,i){const a=we(e),n=Ua($(),t,i),s=Ct($(),n,a),o=Ct($(),n,s);return ls(n[0],n[1],n[2],0,s[0],s[1],s[2],0,o[0],o[1],o[2],0,0,0,0,1)}function cr(e,t,i){const a=i.projectToRenderScreen(e,Ni()),n=i.projectToRenderScreen(t,Ni());return a!=null&&n!=null?hs(P(a,a,n)):0}let Dt=class extends ti{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=nt,this.area=null,this.totalLength=null}};p([c()],Dt.prototype,"type",void 0),p([c()],Dt.prototype,"distance",void 0),p([c()],Dt.prototype,"area",void 0),p([c()],Dt.prototype,"totalLength",void 0),Dt=p([k("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Dt);let z=class extends ft.EventedMixin(Pt){constructor(e){super(e),this._selectedIndex=0,this._manipulatorHandles=new We,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=G.NONE,this._updatingHandles=new Ti,this._recreatingManipulators=!1,this._settings=new Y({getTheme:()=>this.view.effectiveTheme}),this._latestTooltipInfo=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null,this._translateVertexTooltipInfo=null,this._translateVertexXYTooltipInfo=null,this._translateVertexZTooltipInfo=null,this._edgeOffsetTooltipInfo=null,this.outputGeometry=null,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:e,view:t}=this,i=this._settings.manipulators,a=i.vertex;this._vertexManipulatorMaterial=xt(C(a.color),a.renderOccluded),this._vertexManipulatorOutlineMaterial=ce(C(a.outlineColor),a.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=ce(C(a.hoverOutlineColor),a.renderOccluded);const n=i.edge;this._edgeManipulatorMaterial=xt(C(n.color),n.renderOccluded),this._edgeManipulatorOutlineMaterial=ce(C(n.outlineColor),n.renderOccluded);const s=i.edgeOffset;this._edgeOffsetManipulatorMaterial=xt(C(s.color),s.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=xt(C(s.hoverColor),s.renderOccluded,!1);const o=i.selected;this._selectedManipulatorMaterial=xt(C(o.color),o.renderOccluded),this._selectedManipulatorOutlineMaterial=ce(C(o.outlineColor),o.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=ce(C(o.hoverOutlineColor),o.renderOccluded);const r=this._graphicState=new et({graphic:e});this.tooltip=new xe({view:t}),this.addHandles([f(()=>{const l=this._settings.manipulators;return{vertexSettings:l.vertex,edgeSettings:l.edge,edgeOffsetSettings:l.edgeOffset,selectedSettings:l.selected}},({vertexSettings:l,edgeSettings:h,edgeOffsetSettings:d,selectedSettings:u})=>{l.applyColor(this._vertexManipulatorMaterial),l.applyOutline(this._vertexManipulatorOutlineMaterial),l.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),h.applyColor(this._edgeManipulatorMaterial),h.applyOutline(this._edgeManipulatorOutlineMaterial),d.applyColor(this._edgeOffsetManipulatorMaterial),d.applyHover(this._edgeOffsetManipulatorHoverMaterial),u.applyColor(this._selectedManipulatorMaterial),u.applyOutline(this._selectedManipulatorOutlineMaterial),u.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)}),f(()=>r.displaying,l=>{for(const h of this._manipulatorInfos)h.manipulator.available=l}),f(()=>({labels:this._segmentLabels,enabled:this.sketchOptions.labels.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:l,enabled:h,edgeOffsetEnabled:d})=>{l!=null&&(l.visible=h,l.edgeDistance=d?"far":"default")},D),f(()=>this.sketchOptions.tooltips.effectiveEnabled,l=>{this.tooltip.info=l?this._latestTooltipInfo:null},D),this.view.trackGraphicState(r)])}destroy(){this._segmentLabels=R(this._segmentLabels),this.tooltip=R(this.tooltip),this._removeManipulators(),this._updatingHandles.destroy()}get inputGeometry(){return this._editGeometryOperations!=null?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get sketchOptions(){return this.tool.sketchOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}removeSelectedVertices(){const e=this._manipulatorInfos.filter(t=>t.manipulator.selected&&t.type==="vertex");this._removeVertices(e)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=R(this._moveManipulation),this._graphicMoveManipulation=R(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(e){if(this._editGeometryOperations==null)return;const t=H(this.graphic);for(const i of this._editGeometryOperations.data.components){const a=e?.byComponentIndex.get(i.index);for(const n of i.vertices){const s=a?.has(n.index);this._createVertexOrEdgeManipulator(n,t,s)}for(const n of i.edges)this._createVertexOrEdgeManipulator(n,t)}this._createGraphicMoveManipulation(),this._createMoveManipulation(t),this._createVisualElements()}get canRedo(){return this._editGeometryOperations!=null&&this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations!=null&&this._editGeometryOperations.canUndo}redo(){if(this._editGeometryOperations==null)return null;const e=this._editGeometryOperations.redo();return e!=null&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if(this._editGeometryOperations==null)return null;this.emit("undo");const e=this._editGeometryOperations.undo();return e!=null&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._hideTooltip(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(e){const t={byComponentIndex:new Map};if(e!=null&&this.inputGeometry!=null&&ps(e,this.inputGeometry)){for(const n of this._manipulatorInfos)if(n.type==="vertex"&&n.manipulator.selected){const{index:s,component:{index:o}}=n.handle,{byComponentIndex:r}=t,l=r.get(o)||new Set;l.add(s),r.set(o,l)}}if(this._recreatingManipulators=!0,this._removeManipulators(),this._hideTooltip(),this._editGeometryOperations=R(this._editGeometryOperations),this._segmentLabels=R(this._segmentLabels),e==null)return void(this._recreatingManipulators=!1);const i=e.type==="mesh"?e.anchor:e;this._editGeometryOperations=Ke.fromGeometry(i,this.view.state.viewingMode),this._createManipulators(t);const a=this.sketchOptions.labels;this._segmentLabels=new Xe({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:H(this.graphic),labelOptions:a,graphic:this.graphic,graphicState:this._graphicState},visible:a.enabled}),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(e,t){if(t.action==="end")return t;let i=0;const a=[],n=this._manipulatorInfos.some(o=>o.type==="vertex"&&o.manipulator.selected),s=e===te.SELECTED_OR_ALL&&n;for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.grabbing||s&&!o.manipulator.selected||a.push(o),i++);if(a.length===0)return t;if(this._moveVertices(a,t),a.length===i){if(this._updateEventState(G.MOVING),this.destroyed)return t;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(G.RESHAPING),this.destroyed)return t;this.emit("reshape",{type:"reshape",mover:this.graphic})}return t}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((e,t)=>t.type==="vertex"&&t.manipulator.selected?e+1:e,0)>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(G.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const n=[];for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected&&!s.manipulator.grabbing||s===e.info)&&n.push(s);this._moveVertices(n,e,Et.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case G.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case G.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case G.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case G.MOVING:switch(this._reshapeEventState){case G.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case G.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case G.RESHAPING:switch(this._reshapeEventState){case G.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case G.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulation(){const{tool:e,view:t}=this,i=this._graphicState;if(this._graphicMoveManipulation=new Ci({tool:e,view:t,graphicState:i}),this.enableMoveGraphic){let a=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((n,s,o)=>{s.next(r=>this._trackNumDragging(r)).next(r=>(r.action==="start"&&(a=this._editGeometryOperations.createUndoGroup()),r)).next(r=>this._perGraphicManipulatorDragAction(te.ALL,r)).next(r=>(this._updateTranslateGraphicTooltip(S.XY,r),r)).next(r=>{r.action==="end"&&(this._hideTooltip(),a=vt(a))}),o.next(()=>this._onDragCancel(!0,()=>a=vt(a)))})),this._graphicMoveManipulation.forEachManipulator(n=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(n,!1)))}else this._graphicMoveManipulation.forEachManipulator(a=>{a.grabbable=!1,a.cursor=null});this._graphicMoveManipulation.forEachManipulator(a=>this._manipulatorHandles.add(a.events.on("immediate-click",n=>{this._manipulatorInfos.some(s=>s.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...n,graphic:this.graphic}),n.stopPropagation()})))}_createMoveManipulation(e){const{graphic:t,tool:i,view:a}=this,n=this._graphicState;this._moveManipulation=new Xt({tool:i,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Ft(t),snapToScene:!1,radius:Xt.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator(r=>this.addHandles([r.events.on("immediate-click",l=>{this._moveManipulation.zManipulation.hasManipulator(r)||this._manipulatorInfos.some(h=>h.manipulator.selected)||this.emit("immediate-click",{...l,graphic:t}),l.stopPropagation()}),this._watchAndUpdateGrabState(r,!1)]));const s=r=>l=>{this.addHandles(l.events.on("focus-changed",({action:h})=>{h==="focus"?this._updateTranslateTooltip(r):this._hideTooltip()}))};this._moveManipulation.xyManipulation.forEachManipulator(s(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(s(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(s(S.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const o=t.geometry.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline((r,l,h,d,u)=>{const{snappingStep:g,cancelSnapping:_}=Be({predicate:m=>!!m.info,snappingManager:i.snappingManager,snappingContext:new Ve({editGeometryOperations:this._editGeometryOperations,elevationInfo:e,pointer:u,excludeFeature:t,visualizer:new ve}),updatingHandles:this._updatingHandles,useZ:!1});return d=d.next(m=>(this._onDragCancel(),m)).next(_),{steps:h=h.next(m=>this._trackNumDragging(m)).next(m=>{const y=this._manipulatorInfos.filter(M=>M.type==="vertex"&&M.manipulator.selected);return m.manipulatorType===I.TRANSLATE_XY&&y.length===1?{...m,info:y[0],snapOrigin:y[0].handle.pos}:m}).next(Zi(this.view,e,t)).next(...g).next(Qt()).next(m=>this._perGraphicManipulatorDragAction(te.SELECTED_OR_ALL,m)).next(m=>(this._updateTranslateTooltip(r,m),m)),cancel:d}},e,o,t),f(()=>n.displaying,()=>this._updateMoveManipulationPosition(),D),n.on("changed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),f(()=>n.isDraped,r=>{this._updateMoveManipulationPosition();const l="align-move-manipulation";r?this.addHandles(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),l):this.removeHandles(l)},D)])}_createVisualElements(){const{graphic:e,view:t}=this,i=ai({view:t,graphic:e,forEachManipulator:a=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a);for(const n of this._manipulatorInfos)a(n.manipulator,I.TRANSLATE_XY)}},onManipulatorsChanged:a=>this.on("manipulators-changed",a)});i!=null&&(this._outlineVisualElement=i.visualElement instanceof Nt?i.visualElement:null),this._outlineVisualElement!=null&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e,t=H(this.graphic)){if(e.component.vertices.length<=2)return null;const i=this._settings.manipulators.edgeOffset,a=i.size/2,n=a+i.collisionPadding,s=a/n,o=s*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside==null&&(this._edgeOffsetManipulatorGeometryInside=ze(this._edgeOffsetManipulatorMaterial,o,s/2,s/2,i.height,i.offset)),this._edgeOffsetManipulatorGeometryOutside==null&&(this._edgeOffsetManipulatorGeometryOutside=ze(this._edgeOffsetManipulatorMaterial,-o,s/2,s/2,i.height,-i.offset));const r=[new w(this._edgeOffsetManipulatorGeometryInside.instantiate(),O.Unfocused),new w(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),O.Focused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate(),O.Unfocused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),O.Focused)],l=new ot({view:this.view,renderObjects:r,elevationInfo:t.mode!=="on-the-ground"||Yi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionType:{type:"disc",direction:j(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),h=new ot({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),d={manipulator:l,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(d,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(d);const u=[];for(const _ of[e.leftVertex,e.rightVertex]){const m=this._getManipulatorInfoFromHandle(_);m!=null&&u.push(m.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(d)))}d.locationUpdateHandle=X(u),this._manipulatorHandles.add(d.locationUpdateHandle,l),this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!0),this._watchAndUpdateGrabState(h,!0)],l),this._manipulatorHandles.add(ut(l,this._createEdgeOffsetPipeline(d,t)),l),this._manipulatorHandles.add(ut(h,(_,m,y,M)=>{if(M==="touch")this._createEdgeOffsetPipeline(d,t)(_,m,y);else if(this.enableMoveGraphic){const E=this.graphic,v=E.geometry!=null?E.geometry.spatialReference:null;m.next(b=>this._trackNumDragging(b)).next(_e(this.view,_.elevationAlignedLocation)).next(xi(this.view,_.elevationAlignedLocation,t,v,E)).next(le()).next(Qt()).next(b=>this._perGraphicManipulatorDragAction(te.ALL,b)).next(b=>(this._updateTranslateGraphicTooltip(S.XY,b),b)).next(b=>{b.action==="end"&&this._hideTooltip()}),y.next(()=>this._onDragCancel(!_.metadata.deleting))}}),l);const g=_=>{this._manipulatorInfos.some(m=>m.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{..._,graphic:this.graphic}),_.stopPropagation()};return this._manipulatorHandles.add([l.events.on("immediate-click",g),h.events.on("immediate-click",g),l.events.on("focus-changed",({action:_})=>{const{sketchOptions:m,tooltip:y}=this;if(_==="focus"){const M=this._edgeOffsetTooltipInfo??=new Dt({sketchOptions:m});M.distance=nt,M.sketchOptions=m,this._updateTooltipAreaOrTotalLength(M),this._latestTooltipInfo=M,y.info=m.tooltips.effectiveEnabled?this._latestTooltipInfo:null}else this._hideTooltip()})],l),this._manipulatorInfos.push(d),this.manipulators.add(l),this.manipulators.add(h),this.emit("manipulators-changed"),d}_autoHideEdgeOffsetManipulator(e,t){const i=e.manipulator,a=e.edgeManipulator,n=()=>{e.visibilityHandle=vt(e.visibilityHandle);const s=this._getManipulatorInfoFromHandle(e.handle.leftVertex),o=this._getManipulatorInfoFromHandle(e.handle.rightVertex),r=s!=null&&o!=null&&cr(s.manipulator.renderLocation,o.manipulator.renderLocation,this.view.state.camera)<t;(!i.focused&&!a.focused||r)&&(i.grabbable=!r,a.grabbable=!r,e.visibilityHandle=X([i.disableDisplay(),F(()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic})]))};this._manipulatorHandles.add([i.events.on("focus-changed",n),a.events.on("focus-changed",n),F(()=>{vt(e.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)})],i),n()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const{coordinateHelper:t}=this._editGeometryOperations.data,i=ma(this.view,e.manipulator.elevationAlignedLocation,_a(t,e.handle,e.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(e.handle.leftVertex),n=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(a==null||n==null)return;const s=a.manipulator.renderLocation,o=n.manipulator.renderLocation,r=i!=null?pr(i,s,o):cs;e.manipulator.modelTransform=r,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=r;const l=oe(P(Ae,s,o))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(i,a,n)=>{this._clearSelection();const{step:s,cleanup:o}=this._initializeEdgeOffset(e,t);a.next(r=>this._trackNumDragging(r)).next(_e(this.view,i.elevationAlignedLocation)).next(s).next(us(this.view)).next(ds(this.view,this._editGeometryOperations.data.spatialReference)).next(Qt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(e)).next(this._showEdgeOffsetTooltip()).next(r=>{r.action==="end"&&o()}),n.next(()=>{i.metadata.deleting||(o(),this._onDragCancel())})}}_initializeEdgeOffset(e,t){const{view:i}=this,a=this._editGeometryOperations,n=_a(a.data.coordinateHelper,e.handle,t),s=a.createUndoGroup(),o=ma(i,e.manipulator.elevationAlignedLocation,n);if(n.requiresSplitEdgeLeft){const _=this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge);_!=null&&this._splitEdgeManipulator(_,1)}if(n.requiresSplitEdgeRight){const _=this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge);_!=null&&this._splitEdgeManipulator(_,0)}const r=()=>new vs({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:a.data.spatialReference}),l=this._settings,h=new Nt({view:i,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:e.elevationInfo,width:l.visualElements.lineGraphics.outline.width,attached:!1,isDecoration:!0});let d;const u=()=>{this._cleanEdgeOffsetCollapsedEdges(e),d=vt(d)},g=this.on("undo",u);return d=X([f(()=>C(this._accentColor),_=>h.color=_,D),Rt(h),f(()=>this._graphicState.isDraped,_=>h.isDraped=_),this._graphicState.on("changed",()=>h.geometry=r()),s,g]),h.attached=!0,{step:_=>n==null||o==null?(u(),null):{..._,operation:n,plane:o},cleanup:u}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||t.operation==null)return t;this._updateEventState(G.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:n}=t;return(i||a||n)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_applyComputeEdgeOffsetDistanceStep(){return e=>{const{operation:t,mapEnd:i}=e;return t==null||i==null?e:(e.action==="start"&&t.selectArrowFromStartPoint(i),{...e,signedDistance:t.signedDistanceToPoint(i)})}}_showEdgeOffsetTooltip(){return e=>{const{mapEnd:t,signedDistance:i,operation:a}=e,{tooltip:n,sketchOptions:s}=this;if(i!=null){const o=this._edgeOffsetTooltipInfo??=new Dt({sketchOptions:s});o.sketchOptions=s,o.distance=e.action==="end"?nt:ur(this._graphicState.isDraped,i*a.selectedArrow,t,a.plane,this._editGeometryOperations.data.coordinateHelper),this._updateTooltipAreaOrTotalLength(o),this._latestTooltipInfo=o}else this._latestTooltipInfo=null;return n.info=s.tooltips.effectiveEnabled?this._latestTooltipInfo:null,e}}_cleanEdgeOffsetCollapsedEdges(e){const t=e.handle.leftVertex.leftEdge?.leftVertex,i=e.handle.leftVertex,a=e.handle.rightVertex.rightEdge?.rightVertex,n=e.handle.rightVertex,s=this._editGeometryOperations.data.coordinateHelper,o=[];if(t&&s.distance(t.pos,i.pos)<ci){const r=this._getManipulatorInfoFromHandle(i);r!=null&&o.push(r)}if(s.distance(i.pos,n.pos)<ci||a&&s.distance(a.pos,n.pos)<ci){const r=this._getManipulatorInfoFromHandle(n);r!=null&&o.push(r)}o.length&&this._removeVertices(o)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=H(this.graphic),i=!1){const{view:a}=this,n=this._settings;if(e.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(this._vertexManipulatorGeometry==null||this._vertexManipulatorOutlineGeometry==null){const{size:u,outlineSize:g}=this._computeVertexManipulatorSizeAndOutline(n.manipulators.vertex);this._vertexManipulatorGeometry=Ee(this._vertexManipulatorMaterial,u,16,16),this._vertexManipulatorOutlineGeometry=Ee(this._vertexManipulatorOutlineMaterial,g,16,16)}if(this._edgeManipulatorGeometry==null||this._edgeManipulatorOutlineGeometry==null){const{size:u,outlineSize:g}=this._computeVertexManipulatorSizeAndOutline(n.manipulators.edge);this._edgeManipulatorGeometry=Ee(this._edgeManipulatorMaterial,u,16,16),this._edgeManipulatorOutlineGeometry=Ee(this._edgeManipulatorOutlineMaterial,g,16,16)}const{geometry:s}=this.graphic,o=s?.type,r=o==="point"||o==="mesh"?[]:[new w(this._vertexManipulatorGeometry.instantiate(),ht.Vertex|O.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate(),ht.Vertex|O.Unfocused|O.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),ht.Vertex|O.Focused|O.Unselected),new w(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),O.Selected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),O.Selected|O.Unfocused),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),O.Selected|O.Focused)];this.enableMidpoints&&r.push(new w(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),ht.Edge|O.Focused|O.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),ht.Edge|O.Focused|O.Unselected),new w(this._edgeManipulatorGeometry.instantiate(),ht.Edge|O.Unfocused|O.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate(),ht.Edge|O.Unfocused|O.Unselected));const l=new ot({view:a,renderObjects:r,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),metadata:{deleting:!1}});l.selected=i,this._setTypeSpecificManipulatorSettings(l,e,t);const h=e.type==="edge"?{manipulator:l,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:l,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(h),this.manipulators.add(l),this._updateManipulatorPosition(h),h.type==="edge"){const u=[];for(const g of[h.handle.leftVertex,h.handle.rightVertex]){const _=this._getManipulatorInfoFromHandle(g);_!=null&&u.push(_.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(h)))}h.locationUpdateHandle=X(u),this._manipulatorHandles.add(h.locationUpdateHandle,l)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(l,!0),l);const d=ut(l,(u,g,_,m)=>{let y=null;const{snappingStep:M,cancelSnapping:E}=Be({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Ve({editGeometryOperations:this._editGeometryOperations,elevationInfo:t,pointer:m,excludeFeature:this.graphic,visualizer:new ve}),updatingHandles:this._updatingHandles,useZ:!1});_=_.next(v=>(this._onDragCancel(!u.metadata.deleting,()=>y=vt(y)),v)).next(E),g.next(v=>this._trackNumDragging(v)).next(v=>{if(v.action==="start"&&(y=this._editGeometryOperations.createUndoGroup()),h.type==="edge"){const b=this._splitEdgeManipulator(h);return{...v,info:b,snapOrigin:b.handle.pos}}return{...v,info:h,snapOrigin:h.handle.pos}}).next(_e(this.view,u.elevationAlignedLocation)).next(ys(this.view,this.graphic,u.elevationAlignedLocation,u.location.spatialReference,this.graphic)).next(Zi(this.view,t,this.graphic)).next(...M).next(Qt()).next(v=>{this._perVertexManipulatorDragAction(v),v.action==="end"&&(y=vt(y)),this._updateTranslateVertexTooltip(u,S.XY,v)})});return this._manipulatorHandles.add([d,l.events.on("immediate-click",u=>this._manipulatorClickCallback(u,h)),l.events.on("select-changed",()=>{h.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),l.events.on("focus-changed",({action:u})=>{u==="focus"&&h.type!=="edge"?this._updateTranslateVertexTooltip(l,S.XY):this._hideTooltip()})],l),this.emit("manipulators-changed"),h}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_onDragCancel(e=!0,t){switch(this._numDragging--,e&&(this.undo(),this.outputGeometry=this._editGeometryOperations!=null?this._editGeometryOperations.data.geometry:null),this.tool.snappingManager!=null&&this.tool.snappingManager.doneSnapping(),this._hideTooltip(),this._reshapeEventState){case G.NONE:break;case G.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case G.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(G.NONE)}_setTypeSpecificManipulatorSettings(e,t,i){const{graphic:a}=this,n=this._settings;switch(t.type){case"vertex":{e.state=ht.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2;const{size:s,collisionPadding:o}=n.manipulators.vertex;e.radius=s/2+o,e.elevationInfo=i;const{geometry:r}=a,l=r?.type;e.interactive=l!=null&&l!=="point"&&l!=="mesh";break}case"edge":{e.state=ht.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1;const{size:s,collisionPadding:o}=n.manipulators.edge;e.radius=s/2+o,e.elevationInfo=i.mode!=="on-the-ground"||Yi(a.symbol)?{mode:"absolute-height",offset:0}:i;break}}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",i=>this._onGrabStateChanged(e,t,i.action,i.pointerType))}_onGrabStateChanged(e,t,i,a="mouse"){if(!this._recreatingManipulators){if(i==="start")t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(G.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(n=>{const{manipulator:s}=n,{geometry:o}=this.graphic,r=o?.type;s.interactive=s.grabbing||!this._numGrabbing&&r!=null&&r!=="point"&&r!=="mesh","edgeManipulator"in n&&(n.edgeManipulator.interactive=n.edgeManipulator.grabbing||!this._numGrabbing)}),this._graphicMoveManipulation.forEachManipulator(n=>{n.interactive=n.grabbing||!this._numGrabbing}))}}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e!=null&&(e.manipulator.metadata.deleting=!0,this.manipulators.remove(e.manipulator),this._manipulatorHandles.remove(e.manipulator),gs(this._manipulatorInfos,e),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e){for(const t of this._manipulatorInfos)if(e===t.handle)return t}return null}_updateManipulatorPosition(e){if(e==null)return;const t=this._editGeometryOperations;if(e.type==="vertex")e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,de),e.manipulator.grabbing&&this._vertexLaserLineVisualElement!=null&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if(e.type==="edge"){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex),a=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(i==null||a==null)return;const n=i.manipulator,s=a.manipulator;if(e.manipulator.elevationInfo!=null&&e.manipulator.elevationInfo.mode==="on-the-ground"){const o=n.location,r=s.location,l=.5,h=o.x+l*(r.x-o.x),d=o.y+l*(r.y-o.y),u=o.hasZ&&r.hasZ?0:void 0;e.manipulator.location=Se(h,d,u,t.data.spatialReference)}else Ht(Ae,n.renderLocation,s.renderLocation,.5),e.manipulator.renderLocation=Ae}}_splitEdgeManipulator(e,t=.5){const i=this._editGeometryOperations,a=i.splitEdge(e.handle,t).createdVertex;e.locationUpdateHandle=vt(e.locationUpdateHandle);const n=H(this.graphic);let s;this.enableEdgeOffset?(this._removeManipulator(e),s=this._createVertexOrEdgeManipulator(a)):(s=e,s.handle=a,s.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,n)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(s),this.enableEdgeOffset||this._updateTranslateVertexTooltip(s.manipulator,S.XY),this._updateSelection(e.manipulator);const o=this._updateEventState(G.RESHAPING),r=i.data.coordinateHelper.vectorToArray(s.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:a.index}],added:r}),o&&this._updateEventState(G.NONE),s}_updateMoveManipulationPosition(){const e=st(Ae,0,0,0);let t=0,i=!1,a=null,n=null;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected?(t++,Ot(e,e,s.manipulator.renderLocation),a==null||s.selectedIndex>a.selectedIndex?(n=a,a=s):(n==null||s.selectedIndex>n.selectedIndex)&&(n=s)):i=!0);if(t===0){const s=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s,this._moveManipulation.zManipulation.available=s&&this.enableZShape&&Ft(this.graphic),this._moveManipulation.angle=$i(this.graphic.geometry),this._moveManipulation.radius=Xt.radiusForSymbol(this.graphic.symbol)}else{const s=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.zManipulation.available=s&&this.enableZVertex&&Ft(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s&&t!==1;let o=0;if(a!=null){const r=a.handle.pos,l=n!=null?n.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,h=n==null&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;l&&h?this._moveManipulation.xyAxisManipulation.available=!1:l?o=va(l,r):h&&(o=va(r,h))}this._moveManipulation.angle=o,this._moveManipulation.radius=tn}t!==0&&i?(Ut(e,e,1/t),de.spatialReference=this._editGeometryOperations.data.spatialReference,de.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,de),this._moveManipulation.elevationAlignedLocation=de):this._outlineVisualElement==null||this._graphicState.isDraped||this._outlineVisualElement.attachmentOrigin==null?Fa(this.view,this._moveManipulation,this.graphic):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(e){const t=new Array,i=this._editGeometryOperations;for(const a of e){const n=a.handle.component;if(a.type==="vertex"&&i.canRemoveVertex(n)){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const s=i.removeVertices([a.handle]),o=s.removedVertices?.[0].createdEdge;o?this._createVertexOrEdgeManipulator(o):this.enableEdgeOffset&&n.vertices.length<=2&&this._removeManipulator(this._getManipulatorInfoFromHandle(n.edges[0]))}}if(t.length>0){const a=t.map(s=>{const o=i.data.components.indexOf(s.component);return{coordinates:i.data.coordinateHelper.vectorToArray(s.pos),componentIndex:o,vertexIndex:s.index}});this.outputGeometry=i.data.geometry;const n=this._updateEventState(G.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(s=>s.coordinates),vertices:a}),this.destroyed)||n&&(this._updateEventState(G.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=t.action==="start"?Et.NEW_STEP:Et.ACCUMULATE_STEPS){const a=this._editGeometryOperations;a.moveVertices(e.map(n=>n.handle),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const n of e)this._updateManipulatorPosition(n)}_offsetEdge(e,t){if(t.operation==null||t.signedDistance==null)return;const i=this._editGeometryOperations,a=t.operation.clone();a.distance=t.signedDistance,i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),t.type==="vertex"&&(t.manipulator.selected=!t.manipulator.selected,e.button===ji.Right&&this._removeVertices([t])),t.type==="edge"&&e.button===ji.Left&&this._splitEdgeManipulator(t),e.stopPropagation()}_updateTranslateTooltip(e,t){const i=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,e,t):this._updateTranslateGraphicTooltip(e,t)}_updateTranslateGraphicTooltip(e,t){const{sketchOptions:i,tooltip:a}=this;switch(e){case S.XY:this._latestTooltipInfo=this._translateGraphicTooltipInfo??=new ii({sketchOptions:i}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,t,(n,s)=>$t(n,s));break;case S.XY_AXIS:this._latestTooltipInfo=this._translateGraphicXYTooltipInfo??=new Gi({sketchOptions:i}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,t,(n,s)=>He($t(n,s),Ze(t)));break;case S.Z:this._latestTooltipInfo=this._translateGraphicZTooltipInfo??=new ei({sketchOptions:i}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,t,Fe)}this._latestTooltipInfo.sketchOptions=i,a.info=i.tooltips.effectiveEnabled?this._latestTooltipInfo:null}_updateTranslateVertexTooltip(e,t,i){const{sketchOptions:a,tooltip:n}=this;switch(t){case S.XY:this._latestTooltipInfo=this._translateVertexTooltipInfo??=new Ys({sketchOptions:a}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,i,(o,r)=>$t(o,r)),this._updateTooltipAreaOrTotalLength(this._latestTooltipInfo);break;case S.XY_AXIS:this._latestTooltipInfo=this._translateVertexXYTooltipInfo??=new Zs({sketchOptions:a}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,i,(o,r)=>He($t(o,r),Ze(i))),this._updateTooltipAreaOrTotalLength(this._latestTooltipInfo);break;case S.Z:this._latestTooltipInfo=this._translateVertexZTooltipInfo??=new Ns({sketchOptions:a}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,i,Fe)}const s=Ls(e.location);this._latestTooltipInfo.elevation=s!=null?Us({actual:s}):null,this._latestTooltipInfo.sketchOptions=a,n.info=a.tooltips.effectiveEnabled?this._latestTooltipInfo:null}_updateTranslateTooltipDistance(e,t,i){if(t!=null&&t.action!=="end"){const{mapStart:a,mapEnd:n}=t,s=i(a,n);e.distance=s??nt}else e.distance=nt}_updateTooltipAreaOrTotalLength(e){const{geometry:t}=this.graphic;if(t==null)return e.area=null,void(e.totalLength=null);e.area=t.type==="polygon"?js(t):null,e.totalLength=t.type==="polyline"?ks(t):null}_hideTooltip(){this.tooltip.clear(),this._latestTooltipInfo=null}get test(){return{segmentLabels:this._segmentLabels,manipulatorInfos:this._manipulatorInfos}}};function va(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function ur(e,t,i,a,n){if(e){const s=n.toXYZ(n.pointToVector(i)),o=_s(a,s,x.get()),r=ms(o,s,n.spatialReference);if(r!=null)return Ue(r.value*Math.sign(t),r.unit)}return Ue(t*Ce(i.spatialReference),"meters")}p([c()],z.prototype,"_editGeometryOperations",void 0),p([c()],z.prototype,"_segmentLabels",void 0),p([c({constructOnly:!0})],z.prototype,"tool",void 0),p([c()],z.prototype,"tooltip",void 0),p([c()],z.prototype,"inputGeometry",null),p([c()],z.prototype,"outputGeometry",void 0),p([c({readOnly:!0})],z.prototype,"updating",null),p([c()],z.prototype,"manipulators",null),p([c()],z.prototype,"view",null),p([c()],z.prototype,"graphic",null),p([c()],z.prototype,"enableZShape",null),p([c()],z.prototype,"enableZVertex",null),p([c()],z.prototype,"enableMoveGraphic",null),p([c()],z.prototype,"enableMidpoints",null),p([c()],z.prototype,"enableEdgeOffset",null),p([c()],z.prototype,"sketchOptions",null),p([c()],z.prototype,"_accentColor",null),z=p([k("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],z);const de=Se(0,0,void 0,fs.WGS84),Ae=$(),ci=1e-6;var ht,G,te;(function(e){e.Vertex=wt.Custom1,e.Edge=wt.Custom2})(ht||(ht={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(G||(G={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(te||(te={}));let U=class extends ft.EventedMixin(Je){constructor(t){super(t),this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.sketchOptions=new zt,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new z({tool:this});this.addHandles([t.on("reshape",i=>{i.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",i)}),t.on("move",i=>{i.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",i)}),t.on("vertex-add",i=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",i)}),t.on("vertex-remove",i=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",i)}),t.on("immediate-click",i=>this.emit("immediate-click",i)),this.view.on("pointer-down",["Shift"],i=>i.stopPropagation()),f(()=>this.graphic,()=>this._updateGraphic(),ae)]),this.finishToolCreation()}destroy(){this._reshapeOperation=R(this._reshapeOperation)}get updating(){return this._reshapeOperation?.updating??!1}_updateGeometry(){const t=Ms(this.graphic);this._reshapeOperation.inputGeometry=t!=null?t.clone():null}_updateGraphic(){if(this.removeHandles("onGraphicGeometryChange"),this._updateGeometry(),bs(this.graphic)!==Ha.SUPPORTED)return;const t=f(()=>this.graphic?.geometry,()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},se);this.addHandles(t,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0;const{graphic:i}=this,{geometry:a}=i;a?.type==="mesh"&&t.type==="point"?(i.geometry=a.centerAt(t),i.notifyGeometryChanged()):i.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:t}=this._reshapeOperation;this.graphic!=null&&t&&this._updateGeometryInternally(t.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.undo(),{outputGeometry:i}=this._reshapeOperation;t&&i&&this._updateGeometryInternally(i.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){this.snappingManager!=null&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.redo(),{outputGeometry:i}=this._reshapeOperation;t&&i&&this._updateGeometryInternally(i.clone())}onInputEvent(t){t.type!=="key-down"||t.key!=="Delete"&&t.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};p([c()],U.prototype,"_reshapeOperation",void 0),p([c({constructOnly:!0,nonNullable:!0})],U.prototype,"view",void 0),p([c({constructOnly:!0})],U.prototype,"graphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZShape",void 0),p([c({constructOnly:!0,nonNullable:!0})],U.prototype,"enableZVertex",void 0),p([c({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMoveGraphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],U.prototype,"enableMidpoints",void 0),p([c({constructOnly:!0,nonNullable:!0})],U.prototype,"enableEdgeOffset",void 0),p([c()],U.prototype,"type",void 0),p([c({constructOnly:!0,type:zt})],U.prototype,"sketchOptions",void 0),p([c({constructOnly:!0})],U.prototype,"snappingManager",void 0),p([c()],U.prototype,"updating",null),p([c()],U.prototype,"automaticManipulatorSelection",void 0),U=p([k("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],U);let yt=class extends ti{constructor(t){super(t),this.type="transform-rotate",this.rotation=null,this.rotationPrecision=null,this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic"}};p([c()],yt.prototype,"type",void 0),p([c()],yt.prototype,"rotation",void 0),p([c()],yt.prototype,"rotationPrecision",void 0),p([c()],yt.prototype,"orientation",void 0),p([c()],yt.prototype,"orientationPrecision",void 0),p([c()],yt.prototype,"rotationType",void 0),yt=p([k("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],yt);let It=class extends ti{constructor(e){super(e),this.type="transform-scale",this.size=null,this.sizeUnit=null,this.sizePrecision=null}};p([c()],It.prototype,"type",void 0),p([c()],It.prototype,"scale",void 0),p([c()],It.prototype,"size",void 0),p([c()],It.prototype,"sizeUnit",void 0),p([c()],It.prototype,"sizePrecision",void 0),It=p([k("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],It);let _t=class extends ti{constructor(t){super(t),this.type="transform-absolute",this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic",this.size=null,this.sizePrecision=null,this.sizeUnit=null}};p([c()],_t.prototype,"type",void 0),p([c()],_t.prototype,"orientation",void 0),p([c()],_t.prototype,"orientationPrecision",void 0),p([c()],_t.prototype,"rotationType",void 0),p([c()],_t.prototype,"size",void 0),p([c()],_t.prototype,"sizePrecision",void 0),p([c()],_t.prototype,"sizeUnit",void 0),_t=p([k("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],_t);var T;(function(e){e.ScaleIn=wt.Custom2,e.ScaleOut=wt.Custom3,e.RotateLeft=wt.Custom4,e.RotateRight=wt.Custom5,e.Unlocked=wt.Custom7,e.DelayedFocused=wt.Custom8,e.TouchInput=wt.Custom12})(T||(T={}));let Mt=class extends Pt{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this._ringManipulator.location=e}set elevationAlignedLocation(e){this._ringManipulator.elevationAlignedLocation=e}get grabbing(){return this._ringManipulator.grabbing}set interactive(e){this._ringManipulator.interactive=e}get updating(){return!!this._activeAnimation}constructor(e){super(e),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=Ko,this._absoluteTooltipInfo=null,this._scaleTooltipInfo=null,this._rotateTooltipInfo=null,this.events=new ft,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>this._scaleRotateDragData?.mode==="scale"?this.adapter.scale:1}initialize(){this._tooltip=new xe({view:this.tool.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([ne(()=>!this.sketchOptions.tooltips.effectiveEnabled,()=>this._tooltip.clear(),D),f(()=>{const{adapter:e}=this,{info:t}=this._tooltip;return t===this._absoluteTooltipInfo&&this.getFocused()?[t,e.size,e.orientationClockwise]:[null]},([e])=>{e&&this._updateFocusTooltip()})])}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=R(this._tooltip)}startAnimation(e){this.cancelActiveAnimation(),e.start();const t=Ss({update:({deltaTime:i})=>{e.update(i)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:t}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=R(this._activeAnimation)}forEachManipulator(e){e(this._ringManipulator,I.SCALE_ROTATE)}_createManipulator(){const e=this._createRingManipulator();this._ringManipulator=e,this.tool.manipulators.add(e);const t=this.tool.graphicState.graphic,i=ut(e,(a,n,s)=>{this._scaleRotateDragData=null;const o=this.adapter.startInteraction(),r={mode:"none",origin:me(a.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=r,this._updateDragState();const l=x.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(a.renderLocation,l),n.next(Ii(this.tool.view,Ba(a.renderLocation,l,Ai()))).next(h=>{const d=we(h.plane),u=Xa(h.renderStart,h.renderEnd,r.origin,d),g=xs.shortestSignedDiff(r.angle,u);r.angleDir=fi(r.angleDir+g,-ca,ca),r.angle=u;const _=dr(r,h),m=_-this.adapter.scale;if(r.scaleDir=fi(r.scaleDir+m,-pa,pa),this._onScaleChanged(),r.mode==="none"){const y=this.mode||gr(h,h.plane,r.origin,this.tool.view.state.camera);if(y!=null){switch(y){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}r.mode=y}}switch(r.mode){case"rotate":o.state.angle=r.initialAngle+u;break;case"scale":o.state.scale=_,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),h.action){case"start":case"update":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:ye(r.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:_,yScale:_})}break;case"end":switch(r.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:ye(r.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:_,yScale:_})}}return h.action==="end"&&(this.startAnimation(ya(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),o.done()),h}).next(this._updateTooltipPipelineStep(r)),s.next(()=>{if(o.cancel(),this._scaleRotateDragData!=null){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(ya(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this.addHandles([i,e.events.on("focus-changed",a=>{a.action==="focus"?this.startAnimation(_r(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),e.events.on("immediate-click",a=>{a.stopPropagation()}),f(()=>this.tool.graphicState?.displaying,a=>this._ringManipulator.available=a,D)])}_updateTooltipPipelineStep(e){return t=>{const{sketchOptions:i}=this,{effectiveEnabled:a,visualVariables:n}=i.tooltips;if(!a)return t;if(t.action==="end")return this._updateFocusTooltip(),t;const s=this._tooltip;switch(e.mode){case"scale":{s.info=this._scaleTooltipInfo??=new It({sketchOptions:i});const{size:o,scale:r}=this.adapter,l=n?.size,h=s.info;h.sketchOptions=i,h.scale={value:r},h.size=o!=null?Ue(o,"meters"):void 0,h.sizePrecision=Ge(l?.valueType),h.sizeUnit=l?.unit;break}case"rotate":{s.info=this._rotateTooltipInfo??=new yt({sketchOptions:i});const{orientationClockwise:o,relativeAngleClockwise:r}=this.adapter,l=n?.rotation,h=Ge(l?.valueType),d=s.info;d.sketchOptions=i,d.rotation=r!=null?ri(r,"radians","geographic"):void 0,d.rotationPrecision=h,d.rotationType=l?.rotationType??"geographic",d.orientation=o!=null?ri(o,"radians","geographic"):void 0,d.orientationPrecision=h;break}}return t}}_updateFocusTooltip(){const{sketchOptions:e,_tooltip:t}=this,{effectiveEnabled:i,visualVariables:a}=e.tooltips;if(i)if(this.getFocused()){const n=a?.rotation,s=a?.size,o=this.mode,{size:r,orientationClockwise:l}=this.adapter,h=l!=null&&(o==null||o==="rotate"),d=r!=null&&(o==null||o==="scale");t.info=this._absoluteTooltipInfo??=new _t({sketchOptions:e});const u=t.info;u.sketchOptions=e,u.orientation=h?ri(l,"radians","geographic"):void 0,u.orientationPrecision=Ge(n?.valueType),u.rotationType=n?.rotationType??"geographic",u.size=d?Ue(r,"meters"):void 0,u.sizeUnit=s?.unit,u.sizePrecision=Ge(s?.valueType)}else t.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(T.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(T.Unlocked,!(this._scaleRotateDragData!=null&&this._scaleRotateDragData?.mode!=="none")),this._scaleRotateDragData!=null)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(T.ScaleIn|T.ScaleOut,!1),this._ringManipulator.updateStateEnabled(T.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(T.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(T.RotateLeft|T.RotateRight,!1),this._ringManipulator.updateStateEnabled(T.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(T.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(T.ScaleIn|T.ScaleOut|T.RotateLeft|T.RotateRight,!1)}_updateManipulatorTransform(){const e=Ca(Z.get(),this.adapter.angle,j(0,0,1));if(e==null)return;const t=this.getScale(),i=Le(Z.get(),st(x.get(),t,t,t));this._ringManipulator.modelTransform=$e(Z.get(),i,e)}_createRingManipulator(){const e=(A,q,at)=>{const Tt=[],At=Math.ceil(Ka*(q-A)/(2*Math.PI));for(let B=0;B<At+1;B++){const pe=A+B*(q-A)/At;Tt.push(j(at*Math.cos(pe),at*Math.sin(pe),0))}return Tt},t=A=>e(0,2*Math.PI,A),i=A=>[[-A/2,0],[A/2,0],[A/2,hi/2],[-A/2,hi/2]],a=this._createMaterial(1),n=(A,q,at=a)=>Os(at,i(q),A,[],[],!1),s=t(Vt),o=n(s,pi),r={left:new Array,right:new Array},l=[];for(let A=0;A<2;A++){const q=A*Math.PI-Math.PI/4,at=Math.PI/2-qo,Tt=q+at,At=q+Math.PI/2-at,B=e(Tt,At,Yo),pe=n(B,qt);l.push(B),l.push(e(Tt,At,sa-pi/2)),r.left.push(pe),r.right.push(pe.instantiate());for(let si=0;si<2;si++){const Pi=si===0,J=qe();if(Pi){ka(J,J,[1,-1,1]),Wi(J,J,-Tt,[0,0,1]);const Lt=Math.round(ra*(B.length-1));J[12]=B[Lt][0],J[13]=B[Lt][1],J[14]=B[Lt][2]}else{Wi(J,J,At,[0,0,1]);const Lt=Math.round((1-ra)*(B.length-1));J[12]=B[Lt][0],J[13]=B[Lt][1],J[14]=B[Lt][2]}const zi=ze(a,jo,0,Wo,hi);Ra(zi,J),(Pi?r.left:r.right).push(zi)}}const h=[];for(let A=0;A<2;A++){const q=A*Math.PI-Math.PI/4,at=Math.PI/2-Jo,Tt=q+at,At=q+Math.PI/2-at,B=e(Tt,At,sa);h.push(n(B,qt))}const d=this._createMaterial(.66),u=this._createMaterial(.5),g=this._createMaterial(.33),_=t(Vt+la),m=t(Vt+ha),y=n(_,qt,d),M=n(m,qt,g),E=t(Vt-la),v=t(Vt-ha),b=n(E,qt,d),W=n(v,qt,g);let it=[new w(o,T.DelayedFocused),new w(o.instantiate({material:u}),O.None)];this.mode&&this.mode!=="scale"||(it=it.concat([...h.map(A=>new w(A,T.DelayedFocused|T.Unlocked)),new w(y,T.DelayedFocused|T.ScaleIn),new w(M,T.DelayedFocused|T.ScaleIn),new w(b,T.DelayedFocused|T.ScaleOut),new w(W,T.DelayedFocused|T.ScaleOut)])),this.mode&&this.mode!=="rotate"||(it=it.concat([...r.right.map(A=>new w(A.instantiate(),T.DelayedFocused|T.Unlocked)),...r.left.map(A=>new w(A,T.DelayedFocused|T.RotateLeft)),...r.right.map(A=>new w(A,T.DelayedFocused|T.RotateRight))]));const Zt=[s,...l];return new ot({view:this.tool.view,renderObjects:it,autoScaleRenderObjects:!1,worldOriented:!0,radius:pi,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:H(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:Zt,direction:j(0,0,1)}})}_createMaterial(e){const t=new Oi({cullFace:Ei.Back,renderOccluded:V.Transparent,isDecoration:!0});return this.addHandles(f(()=>({color:ws(this.tool.view.effectiveTheme.accentColor,e)}),i=>t.setParameters(i),D)),t}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:e=>this._ringIndicatorDelayMs=e,tooltip:this._tooltip}}};function dr(e,t){const i=P(x.get(),t.renderStart,e.origin),a=P(x.get(),t.renderEnd,e.origin),n=oe(i),s=oe(a);return n===0?0:s/n}function gr(e,t,i,a){const{renderStart:n,renderEnd:s}=e,o=Ie(n,a,x.get()),r=Ie(s,a,x.get());if(Es(o,r)<oa*oa)return null;const l=P(x.get(),n,i),h=Ct(x.get(),l,we(t)),d=n,u=Ot(x.get(),d,h),g=Ie(i,a,x.get()),_=o,m=Ie(u,a,x.get()),y=P(x.get(),m,_),M=P(x.get(),o,g),E=qi(_,y),v=qi(g,M);return Ji(E,r)<Ji(v,r)?"rotate":"scale"}function Ie(e,t,i){return t.projectToScreen(e,ui),st(i,ui[0],ui[1],0)}var re;function ya(e,t){let i=null,a=1;const n=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=n,t()},update:s=>(a+=((a+1)/2-a)*Math.min(s*Qo,1),t(),Math.abs(a-1)<.01?re.STOP:re.CONTINUE),destroy:()=>{i&&(e.getScale=i),t()}}}function _r(e,t,i){let a=0,n=null;const s=()=>!1;return{start:()=>{n=e.getFocused,e.getFocused=s,a=0,t()},update:o=>(a+=o,!n?.()||a>=i.delayMs?re.STOP:re.CONTINUE),destroy:()=>{n&&(e.getFocused=n),t()}}}function Ge(e){switch(e){case"integer":case"long":return 0;default:return null}}p([c({constructOnly:!0})],Mt.prototype,"tool",void 0),p([c({constructOnly:!0})],Mt.prototype,"adapter",void 0),p([c({constructOnly:!0})],Mt.prototype,"sketchOptions",void 0),p([c()],Mt.prototype,"mode",void 0),p([c()],Mt.prototype,"_activeAnimation",void 0),p([c()],Mt.prototype,"updating",null),Mt=p([k("esri.views.3d.interactive.editingTools.transformGraphic.GraphicScaleRotateTransform")],Mt),function(e){e[e.CONTINUE=0]="CONTINUE",e[e.STOP=1]="STOP"}(re||(re={}));const ui=Ye();function en(e){return e.geometry!=null&&e.geometry.type==="mesh"?mr(e.geometry):fr(e)}function mr(e){return Aa(e.vertexSpace)?vr(e,e.transform,e.vertexSpace):yr(e)}function fr(e){let t=e.geometry,i=null;return{undo(a){i=a.geometry,a.geometry=t},redo(a){t=a.geometry,a.geometry=i}}}function vr(e,t,i){let a=t?.clone(),n=me(i.origin),s=null,o=null;return{undo:r=>{s=e.transform?.clone(),o=me(i.origin),e.transform=a,e.vertexSpace.origin=n,r.notifyMeshTransformChanged()},redo:r=>{a=e.transform?.clone(),n=me(i.origin),e.transform=s,e.vertexSpace.origin=o,r.notifyMeshTransformChanged()}}}function yr(e){let t,i=e.vertexAttributes.clonePositional();return{undo:a=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,a.notifyGeometryChanged()}}}let Q=class extends Pt{constructor(e){super(e),this._interactionState=null}initialize(){this.addHandles([ne(()=>{const e=this._interactionState;return e&&e.angle!==e.previousAngle?{interactionState:e,angle:e.state.angle}:null},({interactionState:e})=>{this._updateMeshRotation(e)},se),ne(()=>{const e=this._interactionState;return e&&e.scale!==e.previousScale?{interactionState:e,scale:e.state.scale}:null},({interactionState:e})=>{this._updateMeshSize(e)},se)])}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){const e=this.geometry.transform;if(e==null)return this._interactionState?.angle??0;const t=Ts(e.rotation)[2];return Math.abs(t)>.999999?be(As(e.rotation))*Math.sign(t):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}startInteraction(){const e=new bt({angle:this.angle});this._interactionState=e;const t=()=>{this._interactionState=null};return{state:e,done:t,cancel:()=>{e.cancel(),t()}}}createUndoRecord(){return en(this.graphic)}_updateMeshRotation(e){const{angle:t,previousAngle:i}=e;e.previousAngle=t;const a=ye(t-i),{geometry:n}=this,s=n.anchor;n.rotate(0,0,a,{origin:s}),n.transform&&n.vertexSpace.origin?this.graphic.notifyMeshTransformChanged():this.graphic.notifyGeometryChanged()}_updateMeshSize(e){const{scale:t,previousScale:i}=e;e.previousScale=t;const{geometry:a}=this,n=t/i,s=this.geometry.anchor;this.geometry.scale(n,{origin:s}),a.transform&&a.vertexSpace.origin?this.graphic.notifyMeshTransformChanged():this.graphic.notifyGeometryChanged()}};p([c({constructOnly:!0})],Q.prototype,"graphic",void 0),p([c({constructOnly:!0})],Q.prototype,"geometry",void 0),p([c({constructOnly:!0})],Q.prototype,"viewingMode",void 0),p([c()],Q.prototype,"initialAngle",null),p([c()],Q.prototype,"angle",null),p([c()],Q.prototype,"angleClockwise",null),p([c()],Q.prototype,"relativeAngle",null),p([c()],Q.prototype,"relativeAngleClockwise",null),p([c()],Q.prototype,"scale",null),p([c()],Q.prototype,"_interactionState",void 0),Q=p([k("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],Q);let bt=class extends Pt{get state(){const{angle:t,scale:i}=this;return{angle:t,scale:i}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};p([c()],bt.prototype,"angle",void 0),p([c()],bt.prototype,"initialAngle",void 0),p([c()],bt.prototype,"previousAngle",void 0),p([c()],bt.prototype,"previousScale",void 0),p([c()],bt.prototype,"scale",void 0),p([c()],bt.prototype,"state",null),bt=p([k("InteractionState")],bt);let L=class extends Pt{constructor(e){super(e),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(ne(()=>this._interactionState!=null?this._interactionState.state:null,e=>{this._updateSymbol(e)},se))}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){return this._interactionState!=null?this._interactionState.angle:this._orientationReferenceSymbolLayer!=null?Mr(this._orientationReferenceSymbolLayer.heading??0):0}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}get size(){const e=this._sizeReferenceSymbolLayer;if(e==null)return null;const t=this.findLayerView(),i=this._graphicSymbol;if(t==null||i==null||i.type!=="point-3d")return null;const a=t.getSymbolLayerSize(i,e);if("size"in a&&a.size!=null)return a.size;const n=this.sizeAxis;return!("width"in a)||a.width==null||n!=null&&n!=="width"&&n!=="all"&&n!=="width-and-depth"?!("depth"in a)||e.depth==null||n!=null&&n!=="depth"&&n!=="all"&&n!=="width-and-depth"?!("height"in a)||e.height==null||n!=null&&n!=="height"&&n!=="all"?null:a.height:a.depth:a.width}get _sizeReferenceSymbolLayer(){const e=this._graphicSymbol;return e==null||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object")}get _orientationReferenceSymbolLayer(){const e=this._graphicSymbol;return e==null||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object"&&t.heading!=null)}get _graphicSymbol(){return this.graphic?.symbol!=null&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(e){this.graphic.symbol=e}startInteraction(){const e=this._graphicSymbol,t=this.findLayerView();if(this._interactionState!=null||e==null||t==null)return br;const i=e.symbolLayers.map(r=>r.type==="object"?t.getSymbolLayerSize(e,r):null).toArray(),a=e.clone(),n=this.angle,s=new St({originalSymbol:a,angle:n,initialSizes:i});this._interactionState=s;const o=()=>{this._interactionState=null};return{state:s,done:o,cancel:()=>{this._graphicSymbol=a,o()}}}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e},redo:i=>{e=i.symbol,i.symbol=t}}}_updateSymbol({scale:e,angle:t,originalSymbol:i,initialSizes:a}){const n=this._graphicSymbol;if(n==null||n.type!=="point-3d")return;const s=n.clone(),o=-ye(t-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,s,(l,h,d)=>{const u=(l.heading??0)+o;h.heading!==u&&(h.heading=u,r=!0);const g=a[d];if(g!=null&&"width"in g){g.width=this.sizeFilter(g.width),g.height=this.sizeFilter(g.height),g.depth=this.sizeFilter(g.depth);const _=g.width*e;h.width!==_&&(h.width=_,r=!0);const m=g.depth*e;h.depth!==m&&(h.depth=m,r=!0);const y=g.height*e;h.height!==y&&(h.height=y,r=!0)}}),r&&(this._graphicSymbol=s)}_forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach((a,n)=>{const s=t.symbolLayers.at(n);a.type==="object"&&s.type==="object"&&i(a,s,n)})}};function Mr(e){return-be(e)}p([c()],L.prototype,"initialAngle",null),p([c()],L.prototype,"angle",null),p([c()],L.prototype,"angleClockwise",null),p([c()],L.prototype,"orientation",null),p([c()],L.prototype,"orientationClockwise",null),p([c()],L.prototype,"relativeAngle",null),p([c()],L.prototype,"relativeAngleClockwise",null),p([c()],L.prototype,"scale",null),p([c()],L.prototype,"size",null),p([c()],L.prototype,"sizeAxis",void 0),p([c({constructOnly:!0})],L.prototype,"graphic",void 0),p([c()],L.prototype,"_interactionState",void 0),p([c({constructOnly:!0})],L.prototype,"findLayerView",void 0),p([c({constructOnly:!0})],L.prototype,"sizeFilter",void 0),p([c()],L.prototype,"_sizeReferenceSymbolLayer",null),p([c()],L.prototype,"_orientationReferenceSymbolLayer",null),p([c()],L.prototype,"_graphicSymbol",null),L=p([k("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],L);const br={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let St=class extends Pt{get state(){const{originalSymbol:e,angle:t,initialAngle:i,scale:a,initialSizes:n}=this;return{originalSymbol:e,angle:t,initialAngle:i,scale:a,initialSizes:n}}constructor(e){super(e),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=e.angle}};p([c()],St.prototype,"originalSymbol",void 0),p([c()],St.prototype,"angle",void 0),p([c()],St.prototype,"initialAngle",void 0),p([c()],St.prototype,"initialSizes",void 0),p([c()],St.prototype,"scale",void 0),p([c()],St.prototype,"state",null),St=p([k("InteractionState")],St);let N=class extends ft.EventedMixin(Je){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.sketchOptions=new zt,this.type="transform-3d",this.tooltip=null,this._updatingHandles=new Ti,this._scaleRotate=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{graphic:e,view:t}=this;this.graphicState=new et({graphic:e}),this.addHandles(f(()=>this.sketchOptions.tooltips.effectiveEnabled,s=>{this.tooltip=s?new xe({view:t}):R(this.tooltip)},ae)),this._moveManipulation=new Xt({tool:this,view:t,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Ft(e),radius:Xt.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(s=>this.addHandles(s.events.on("immediate-click",o=>{this.emit("immediate-click",{...o,graphic:e}),o.stopPropagation()})));const i=s=>o=>{this.addHandles(o.events.on("focus-changed",({action:r})=>{const l=this.tooltip;l!=null&&(r==="focus"?this._updateMoveTooltip(s):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(S.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(S.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(S.Z));const a=H(e);this._moveManipulation.elevationInfo=a,this.addHandles(Di(this.graphicState,t));const{geometry:n}=e;if(this._moveManipulation.createGraphicDragPipeline((s,o,r,l,h)=>{if(n!=null&&s===S.XY){const{snappingStep:d,cancelSnapping:u}=Be({snappingContext:new Ve({elevationInfo:a,pointer:h,editGeometryOperations:Ke.fromGeometry(new Is({spatialReference:n.spatialReference}),t.state.viewingMode),visualizer:new ve,excludeFeature:e}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});l=l.next(u),r=r.next(Gs(this.view,a)).next(...d)}return{steps:r=r.next(d=>(this._updateMoveTooltip(s,d),d)),cancel:l}},this.graphicState,s=>{const{action:o,graphic:r,dxScreen:l,dyScreen:h}=s,d={graphic:r,dxScreen:l,dyScreen:h};switch(o){case"start":this.emit("graphic-translate-start",d),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",d);break;case"end":this.emit("graphic-translate-stop",d)}}),this._moveManipulation.angle=this._scaleRotate!=null?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(f(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const s=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Mt({tool:this,mode:s,adapter:this._scaleRotateAdapter,sketchOptions:this.sketchOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.addHandles([ai({view:this.view,graphic:this.graphic,forEachManipulator:s=>this._forEachManipulator(s),onManipulatorsChanged:()=>F()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),f(()=>t.scale,()=>this._updateMoveAngle())].filter(Ds)),this.addHandles(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(s=>{s instanceof ot&&this.addHandles(s.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this.tooltip=R(this.tooltip),this._moveManipulation.destroy(),this._scaleRotate=R(this._scaleRotate),this._scaleRotateAdapter=R(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){this._scaleRotate!=null&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return this.graphic.geometry!=null&&this.graphic.geometry.type==="mesh"?new Q({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new L({graphic:this.graphic,sizeFilter:e=>this._enforceNonZeroSize(e),findLayerView:()=>this.view.allLayerViews.find(e=>e.layer===this.graphic.layer),sizeAxis:this.sketchOptions?.tooltips?.visualVariables?.size?.axis??null})}_forEachManipulator(e){this._moveManipulation?.forEachManipulator(e),this._scaleRotate?.forEachManipulator(e)}_hideManipulatorsForGraphicState(){return f(()=>this.graphicState.displaying,e=>{this._forEachManipulator(t=>t.available=e),this._moveManipulation.zManipulation.available=e&&this.enableZ&&Ft(this.graphic)})}_createGeometryUndoRecord(){return en(this.graphic)}set snapToScene(e){this._moveManipulation&&(this._moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this._updatingHandles.updating||!!this._scaleRotate?.updating}set location(e){this._moveManipulation.location=e,this._scaleRotate&&(this._scaleRotate.location=e)}set elevationAlignedLocation(e){this._moveManipulation.elevationAlignedLocation=e,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=e)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){this._scaleRotate!=null&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===_i.Local||this.view.scale<tr?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){Fa(this.view,this,this.graphic)}_enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(e,t){const{sketchOptions:i,tooltip:a}=this;if(a!=null){switch(a.clear(),e){case S.XY:a.info=this._translateGraphicTooltipInfo??=new ii({sketchOptions:i}),this._updateMoveTooltipDistance(a.info,t,(n,s)=>$t(n,s));break;case S.XY_AXIS:a.info=this._translateGraphicXYTooltipInfo??=new Gi({sketchOptions:i}),this._updateMoveTooltipDistance(a.info,t,(n,s)=>He($t(n,s),Ze(t)));break;case S.Z:a.info=this._translateGraphicZTooltipInfo??=new ei({sketchOptions:i}),this._updateMoveTooltipDistance(a.info,t,Fe)}a.info.sketchOptions=i}}_updateMoveTooltipDistance(e,t,i){if(t!=null&&t.action!=="end"){const{mapStart:a,mapEnd:n}=t,s=i(a,n);e.distance=s??nt}else e.distance=nt}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:this._scaleRotate!=null?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:e=>this._scaleRotate!=null?this._scaleRotate.test.setRingIndicatorDelayMs(e):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate}}};p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"view",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"graphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableZ",void 0),p([c()],N.prototype,"enableRotation",void 0),p([c()],N.prototype,"enableScaling",void 0),p([c({constructOnly:!0,type:zt})],N.prototype,"sketchOptions",void 0),p([c()],N.prototype,"graphicState",void 0),p([c({value:!1})],N.prototype,"snapToScene",null),p([c({constructOnly:!0})],N.prototype,"snappingManager",void 0),p([c({readOnly:!0})],N.prototype,"type",void 0),p([c({readOnly:!0})],N.prototype,"updating",null),p([c()],N.prototype,"tooltip",void 0),N=p([k("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],N);class Sr{constructor(t,i,a,n){this._tool=t,this._graphicState=i,this._editGeometryOperations=a,this._bounds=n,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const s=this._tool,o=s.view;this.moveXYGraphicManipulation=new Ci({view:o,tool:s,graphicState:this._graphicState}),s.addHandles(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=new Ws(o,qs.CENTER_ON_CALLOUT),this.moveZManipulator.state|=Js,s.manipulators.add(this.moveZManipulator),s.addHandles([this._createMoveZDragPipeline()]),s.addHandles([s.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null})])}destroy(){this.moveXYGraphicManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYGraphicManipulation.forEachManipulator(t),t(this.moveZManipulator,I.TRANSLATE_Z)}updateManipulators(t,i){const a=this.moveZManipulator,n=$s(Z.get(),t,Math.PI);n[12]=0,n[13]=0,n[14]=0,a.modelTransform=n,a.renderLocation=P(x.get(),i.origin,i.basis1)}getUpdatedTooltipInfo(){return this.moveXYGraphicManipulation.grabbing||this.moveXYGraphicManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool,i=this._moveXYTooltipInfo??=new ii({sketchOptions:t.sketchOptions});if(this.moveXYGraphicManipulation.dragging){const a=this._bounds,n=a.mapBoundsStart.origin,s=a.mapBounds.origin,{renderSpatialReference:o}=t.view;if(!o)return null;const r=ja(n,s,o);if(r==null)return null;i.distance=r}else i.distance=nt;return i}_computeMoveZTooltipInfo(){const t=this._tool,i=this._moveZTooltipInfo??=new ei({sketchOptions:t.sketchOptions});if(this.moveZManipulator.dragging){const a=this._bounds,n=a.mapBoundsStart.origin,s=a.mapBounds.origin,{renderSpatialReference:o}=t.view;if(!o)return null;const r=Hs(n,s,o);if(r==null)return null;i.distance=r}else i.distance=nt;return i}_createMoveXYGraphicDragPipeline(){return this.moveXYGraphicManipulation.createDragPipeline((t,i,a)=>this._applyGraphicMoveSteps(i,a))}_createMoveZDragPipeline(){const t=this._editGeometryOperations.data.spatialReference;return ut(this.moveZManipulator,(i,a,n)=>{const s=me(i.renderLocation),o=a.next(za(this._tool.view,s,t)).next(le());this._applyGraphicMoveSteps(o,n)})}_applyGraphicMoveSteps(t,i){const a=this._tool,n=a.graphic,s=t.next(o=>(o.action==="start"&&(a.inputState={type:"move"},this._bounds.backupMapBounds(),a.emit("graphic-translate-start",{graphic:n,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY})),o)).next(Qt()).next(this._moveDragUpdateGeometry()).next(o=>{const r={graphic:n,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY};switch(o.action){case"start":case"update":(o.mapEnd.x-o.mapStart.x||o.mapEnd.y-o.mapStart.y||(o.mapEnd.z??0)-(o.mapStart.z??0))&&a.emit("graphic-translate",r);break;case"end":a.inputState=null,a.emit("graphic-translate-stop",r)}return o});return i.next(()=>{a.inputState!=null&&a.emit("graphic-translate-stop",{graphic:n,dxScreen:0,dyScreen:0}),a.cancel()}),s}_moveDragUpdateGeometry(){const t=this._tool;return i=>{if(t.inputState==null||t.inputState.type!=="move")return i;const a=[];for(const o of this._editGeometryOperations.data.components)a.push(...o.vertices);const n=i.action==="start"?Et.NEW_STEP:Et.ACCUMULATE_STEPS,s=this._editGeometryOperations.moveVertices(a,i.mapDeltaX,i.mapDeltaY,i.mapDeltaZ,n);return Qe(s,this._bounds.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,i}}}class wr{constructor(t,i,a){this._tool=t,this._editGeometryOperations=i,this._bounds=a,this._rotateTooltipInfo=null,this._startAngle=0,this._endAngle=0;const n=this._tool,s=n.view,o=!s._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this.rotateManipulator=new Ks(s,(r,l)=>oo(s.textures,{accentColor:r,contrastColor:l,preMultiplyAlpha:o})),n.addHandles([this.rotateManipulator.events.on("grab-changed",r=>this._onRotateGrab(r)),this._createRotateDragPipeline(this.rotateManipulator)]),n.manipulators.add(this.rotateManipulator),n.addHandles([n.on("graphic-rotate-start",r=>{this._startAngle=r.angle}),n.on("graphic-rotate",r=>{this._endAngle=r.angle}),n.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0})])}destroy(){this._tool.manipulators.remove(this.rotateManipulator),this.rotateManipulator.destroy()}forEachManipulator(t){t(this.rotateManipulator,I.ROTATE)}updateManipulators(t,i){const a=this._bounds.mapBounds.plane[2]<0?Math.PI:0,n=La(Z.get(),t,a);n[12]=0,n[13]=0,n[14]=0,this.rotateManipulator.modelTransform=n,this.rotateManipulator.renderLocation=Ot(x.get(),i.origin,i.basis1)}getUpdatedTooltipInfo(){return this.rotateManipulator.focused?this._computeRotateTooltipInfo():null}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo??=new ro({sketchOptions:this._tool.sketchOptions});return t.angle=this._startAngle-this._endAngle,t}_onRotateGrab({action:t,screenPoint:i}){const a=this._tool,n=this._bounds;if(t!=="start"||!i)return;const s=Qs(n.displayBounds,a.view.renderCoordsHelper,to.HEADING,Ai()),o=Na(a.view.state.camera,i);Za(s,o,x.get())&&(n.backupMapBounds(),a.inputState={type:"rotate",rotatePlane:s})}_createRotateDragPipeline(t){const i=this._tool,a=i.graphic;return ut(t,(n,s,o)=>{const r=i.inputState;r!=null&&(s.next(l=>(l.action==="start"&&i.emit("graphic-rotate-start",{graphic:a,angle:0}),l)).next(Ii(i.view,r.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(r)).next(this._rotateDragUpdateGeometry()).next(l=>{const h={graphic:a,angle:ye(l.rotateAngle)};switch(l.action){case"start":case"update":i.emit("graphic-rotate",h);break;case"end":i.inputState=null,i.emit("graphic-rotate-stop",h)}return l}),o.next(()=>{i.inputState!=null&&i.emit("graphic-rotate-stop",{graphic:a,angle:0}),i.cancel()}))})}_rotateDragRenderPlaneToRotate(t){return i=>{const a=we(t.rotatePlane),n=Xa(i.renderStart,i.renderEnd,this._bounds.displayBounds.origin,a);return{...i,rotateAxis:a,rotateAngle:n}}}_rotateDragUpdateGeometry(){const t=this._tool,i=this._bounds;return a=>{const n=vi($(),i.mapBoundsStart.origin),s=[];for(const l of this._editGeometryOperations.data.components)s.push(...l.vertices);const o=a.action==="start"?Et.NEW_STEP:Et.ACCUMULATE_STEPS,r=this._editGeometryOperations.rotateVertices(s,n,a.rotateAngle,o,Ya.REPLACE);return Me(i.mapBoundsStart,i.mapBounds),Qe(r,i.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,a}}}class xr{constructor(t,i,a){this._tool=t,this._onDisplayBoundsChanged=i,this.mapBounds=fe(),this.mapBoundsStart=fe(),this.displayBounds=fe(),this._calculateMapBounds(a)}get displayBoundsMargin(){const{view:t,graphic:i}=this._tool,a=t.pointsOfInterest?.centerOnSurfaceFrequent.location??i.geometry?.extent?.center;return a?Or*t.pixelSizeAt(a):0}backupMapBounds(){Me(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged()}_calculateMapBounds(t){const{view:i,attachmentOrigin:a}=this._tool,n=t.geometry,s=Do(n);Oa(s,s,-1);const o=i.spatialReference,r=n.spatialReference,l=a?i.pixelSizeAt(a)*Rs(o)/Ce(r):0;Fs(s,t,Er*l,this.mapBounds)}_calculateDisplayBounds(){const{view:t,attachmentOrigin:i,graphic:a}=this._tool;if(!a.geometry)return;const n=i?.z??Si(this.mapBounds.origin,t.elevationProvider,je.fromElevationInfo(H(a)),t.renderCoordsHelper),s=Me(this.mapBounds);s.origin[2]=n??0,Tr(s,t.renderCoordsHelper,a.geometry.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const Or=10,Er=80;function Tr(e,t,i,a=0,n){n||(n=fe()),t.toRenderCoords(e.origin,i,n.origin);const s=x.get();Ot(s,e.origin,e.basis1),Ot(s,s,e.basis2),t.toRenderCoords(s,i,s);const o=x.get();Ot(o,e.origin,e.basis1),P(o,o,e.basis2),t.toRenderCoords(o,i,o);const r=x.get();P(r,e.origin,e.basis1),P(r,r,e.basis2),t.toRenderCoords(r,i,r);const l=x.get();P(l,e.origin,e.basis1),Ot(l,l,e.basis2),t.toRenderCoords(l,i,l);const h=Ht(x.get(),s,o,.5);P(h,h,n.origin);const d=Ht(x.get(),r,l,.5);P(d,n.origin,d),Ht(n.basis1,h,d,.5);const u=Ht(x.get(),l,s,.5);P(u,u,n.origin);const g=Ht(x.get(),o,r,.5);P(g,n.origin,g),Ht(n.basis2,u,g,.5);const _=Ct(x.get(),n.basis1,n.basis2),m=Ct(_,_,n.basis1);return mi(m,m),Ut(n.basis2,m,ke(n.basis2,m)),Ut(n.basis1,n.basis1,1+a/oe(n.basis1)),Ut(n.basis2,n.basis2,1+a/oe(n.basis2)),Cs(n),n}function Ma(e,t,i){return P(Kt,P(Kt,e.origin,e.basis1),e.basis2),Bt(De,Kt,e.basis1,2),Bt(gi,De,e.basis2,2),Bt(di,Kt,e.basis2,2),Kt[2]=De[2]=gi[2]=di[2]=t,lo({topLeft:di,topRight:gi,bottomRight:De,bottomLeft:Kt,spatialReference:i})}const di=$(),gi=$(),De=$(),Kt=$();class Ar{get zMax(){if(!this._zMaxDirty)return this._zMax;const t=this._editGeometryOperations.data;if(t.geometry.hasZ){const i=t.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const n of a.vertices){const s=i.getZ(n.pos)??0;this._zMax=Math.max(s,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(t,i,a,n,s){this._tool=t,this._graphicState=i,this._editGeometryOperations=a,this._bounds=n,this._preserveAspectRatioStep=s,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._scaleTooltipInfo=null,this._displayBoundsStart=fe(),this._displayBoundsMarginStart=0,this._startScale=ge(),this._endScale=ge(),this._sizeStart=null,this._zMax=0,this._zMaxDirty=!0;const o=this._tool,r=o.view;this.resizeManipulators=this._resizeHandles.map(l=>{const h=new eo(r,l);return o.addHandles([h.events.on("grab-changed",d=>this._onResizeGrab(d)),this._createResizeDragPipeline(h,l)]),h}),o.manipulators.addMany(this.resizeManipulators),o.addHandles([o.on("graphic-scale-start",l=>{Gt(this._startScale,l.xScale,l.yScale),Gt(this._endScale,l.xScale,l.yScale)}),o.on("graphic-scale",l=>{Gt(this._endScale,l.xScale,l.yScale)}),o.on("graphic-scale-stop",()=>{Gt(this._startScale,0,0),Gt(this._endScale,0,0)}),this._graphicState.on("changed",()=>{o.inputState?.type!=="resize"&&(this._zMaxDirty=!0)})])}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){this.resizeManipulators.forEach(i=>t(i,I.SCALE))}updateManipulators(t,i){this.resizeManipulators.forEach((a,n)=>{io(a,this._resizeHandles[n],t,i)})}getUpdatedTooltipInfo(){return this.resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null}_computeScaleTooltipInfo(){const t=this._tool,i=this._scaleTooltipInfo??=new ho({sketchOptions:t.sketchOptions}),a=t.graphic.geometry;if(a==null)return null;const n=Ma(this._bounds.mapBounds,this.zMax,a.spatialReference);return n==null?null:(i.xSize=n.xSize,i.ySize=n.ySize,this._sizeStart!=null&&this.resizeManipulators.some(s=>s.dragging)?(i.xScale=n.xSize.value/this._sizeStart.xSize.value,i.yScale=n.ySize.value/this._sizeStart.ySize.value):(i.xScale=1,i.yScale=1),i)}_onResizeGrab({action:t,screenPoint:i}){const a=this._tool,n=this._bounds;if(t!=="start"||!i||!a.graphic.geometry)return;const s=Na(a.view.state.camera,i);Za(n.displayBounds.plane,s,x.get())&&(n.backupMapBounds(),Me(n.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=n.displayBoundsMargin,this._sizeStart=Ma(n.mapBoundsStart,this.zMax,a.graphic.geometry.spatialReference),a.inputState={type:"resize"})}_createResizeDragPipeline(t,i){const a=this._tool,n=a.graphic;return ut(t,(s,o,r)=>{a.inputState!=null&&(o.next(l=>(l.action==="start"&&a.emit("graphic-scale-start",{graphic:n,xScale:1,yScale:1}),l)).next(Ii(a.view,this._displayBoundsStart.plane)).next(l=>({...l,handle:i})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next(l=>{const h={graphic:n,xScale:l.factor1,yScale:l.factor2};switch(l.action){case"start":case"update":a.emit("graphic-scale",h);break;case"end":a.inputState=null,a.emit("graphic-scale-stop",h)}return l}),r.next(()=>{a.inputState!=null&&a.emit("graphic-scale-stop",{graphic:n,xScale:1,yScale:1}),a.cancel()}))})}_resizeDragRenderPlaneToFactors(){const t=this._bounds;return i=>{const a=this._displayBoundsStart,n=i.handle.direction,s=t.displayBoundsMargin,o=this._displayBoundsMarginStart,r=vi(x.get(),a.origin);Bt(r,r,a.basis1,-n[0]),Bt(r,r,a.basis2,-n[1]);const l=P(x.get(),i.renderEnd,r),h=P(x.get(),i.renderStart,r),d=Wa(i.handle),u=ta(a),g=ta(t.displayBounds)/u,_=(m,y)=>{if(m===0)return 1;let M=oe(y),E=.5*m*ke(y,l)/M;const v=E<0?-1:1;d&&(E+=(M-.5*m*ke(y,h)/M)*v*g);const b=M<1.5*o?1:ba;return M=Math.max(M-o,ba),v>0&&(E-=s),v*Math.max(v*(E/M),b)};return{...i,factor1:_(n[0],a.basis1),factor2:_(n[1],a.basis2)}}}_resizeDragUpdateGeometry(){const t=this._tool,i=this._bounds;return a=>{const n=vi($(),i.mapBoundsStart.origin);Bt(n,n,i.mapBoundsStart.basis1,-a.handle.direction[0]),Bt(n,n,i.mapBoundsStart.basis2,-a.handle.direction[1]);const s=Gt(ge(),i.mapBoundsStart.basis1[0],i.mapBoundsStart.basis1[1]);xa(s,s);const o=[];for(const h of this._editGeometryOperations.data.components)o.push(...h.vertices);const r=a.action==="start"?Et.NEW_STEP:Et.ACCUMULATE_STEPS,l=this._editGeometryOperations.scaleVertices(o,n,s,a.factor1,a.factor2,r,Ya.REPLACE);return Me(i.mapBoundsStart,i.mapBounds),Qe(l,i.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,a}}}const ba=1e-6;class Ir{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const i={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(i),this._next.execute(i)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new Pa;return this._next=t,[i=>(this._lastDragEvent=i.action!=="end"?{...i}:null,this._enabled&&this._adjustScaleFactors(i),i),t]}_adjustScaleFactors(t){const i=Wa(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):t.handle.direction[0]===0?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-i:i,t.factor2=t.factor2<0?-i:i}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}let K=class extends ft.EventedMixin(Je){constructor(e){super(e),this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.sketchOptions=new zt,this._preserveAspectRatio=new Ir,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){const{view:e,graphic:t}=this,i=this._graphicState=new et({graphic:t}),a=t.geometry,n=this._editGeometryOperations=Ke.fromGeometry(a,e.state.viewingMode),s=this._bounds=new xr(this,()=>this._updateManipulators(),n.data);this._extentMove=new Sr(this,i,n,s),this._extentScale=new Ar(this,i,n,s,()=>this._preserveAspectRatio.createDragEventPipelineStep()),this._extentRotate=new wr(this,n,s),this.addHandles([f(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,I.TRANSLATE_Z)),f(()=>this.enableScaling,()=>this._extentScale.forEachManipulator(h=>this._updateManipulatorAvailability(h,I.SCALE))),f(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,I.ROTATE))]),this._updateAllManipulatorAvailability();const o=ai({view:e,graphic:t,forEachManipulator:h=>this._forEachManipulator(h),onManipulatorsChanged:()=>F()});if(o!=null){const{visualElement:h}=o;h instanceof Nt&&(this._outlineVisualElement=h,this.addHandles(h.events.on("attachment-origin-changed",()=>this._bounds.updateDisplayBounds()))),this.addHandles(o)}this.addHandles([i.on("changed",()=>this._onGeometryChanged()),f(()=>i.displaying,()=>this._updateAllManipulatorAvailability()),f(()=>i.isDraped,()=>this._graphicDrapedChanged(),D),f(()=>e.pointsOfInterest?.centerOnSurfaceFrequent.location,()=>s.updateDisplayBounds()),e.trackGraphicState(i)]);const r=h=>{this.addHandles(h.events.on("grab-changed",()=>{this.grabbing=h.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(r);const l=(h,d)=>{this.addHandles(h.events.on("immediate-click",u=>{d===I.TRANSLATE_XY&&this.emit("immediate-click",{...u,graphic:t}),u.stopPropagation()}))};this._forEachManipulator(l),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this._editGeometryOperations.destroy(),this.tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{view:e}=this,t=this.tooltip=new xe({view:e}),i=()=>{t.info=this._getUpdatedTooltipInfo()};this.addHandles([f(()=>this.sketchOptions.tooltips.effectiveEnabled,i),this.on("graphic-translate-start",i),this.on("graphic-translate",i),this.on("graphic-translate-stop",()=>{this.tooltip.clear()}),this.on("graphic-rotate-start",i),this.on("graphic-rotate",i),this.on("graphic-rotate-stop",i),this.on("graphic-scale-start",i),this.on("graphic-scale",i),this.on("graphic-scale-stop",i)]),this._forEachManipulator(a=>{this.addHandles([a.events.on("focus-changed",i),a.events.on("grab-changed",i),a.events.on("drag",n=>{n.action==="cancel"?this.tooltip.clear():i()})])})}_getUpdatedTooltipInfo(){return this.sketchOptions.tooltips.effectiveEnabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(Sa),this._bounds.updateDisplayBounds(),this._graphicState.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",e=>{this._attachmentOrigin!=null&&$a(e.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()}),Sa)}_updateManipulators(){if(!this.visible)return;const e=this._bounds.displayBounds,t=ao(e,Z.get());this._extentMove.updateManipulators(t,e),this._extentScale.updateManipulators(t,e),this._extentRotate.updateManipulators(t,e)}_updateAllManipulatorAvailability(){this._forEachManipulator((e,t)=>this._updateManipulatorAvailability(e,t))}_updateManipulatorAvailability(e,t){const i=this.grabbing&&!e.grabbing;if(e.interactive=!i,e instanceof ot){const a=this._graphicState.displaying,n=this.enableZ&&Ft(this.graphic);switch(t){case I.ROTATE:e.available=a&&this.enableRotation;break;case I.SCALE:e.available=a&&(this.enableScaling||this.enableRotation||n),e.interactive=!i&&this.enableScaling,e.state=this.enableScaling?no:so;break;case I.TRANSLATE_Z:e.available=a&&n;break;default:e.available=a}}}_forEachManipulator(e){this._extentMove.forEachManipulator(e),this._extentScale.forEachManipulator(e),this._extentRotate.forEachManipulator(e)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}get attachmentOrigin(){const e=this.graphic.geometry,t=this._graphicState.isDraped?null:this._outlineVisualElement?.attachmentOrigin;return this._attachmentOrigin=t??Va(this.view,this.graphic)??e?.extent?.center,this._attachmentOrigin}reset(){}cancel(){if(this.canUndo){const e=this._editGeometryOperations.undo();Qi(e,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}this.inputState=null}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(this.inputState!=null)this.view.activeTool=null;else if(this.canUndo){const e=this._editGeometryOperations.undo();Qi(e,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const e=this._editGeometryOperations.redo();Qe(e,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get test(){return{moveZManipulator:this._extentMove.moveZManipulator,resizeManipulators:this._extentScale.resizeManipulators,rotateManipulator:this._extentRotate.rotateManipulator}}};p([c({constructOnly:!0,nonNullable:!0})],K.prototype,"view",void 0),p([c({constructOnly:!0,nonNullable:!0})],K.prototype,"graphic",void 0),p([c()],K.prototype,"enableZ",void 0),p([c()],K.prototype,"enableScaling",void 0),p([c()],K.prototype,"enableRotation",void 0),p([c({constructOnly:!0,type:zt})],K.prototype,"sketchOptions",void 0),p([c()],K.prototype,"preserveAspectRatio",null),p([c()],K.prototype,"grabbing",void 0),p([c()],K.prototype,"inputState",void 0),p([c({readOnly:!0})],K.prototype,"type",void 0),p([c()],K.prototype,"tooltip",void 0),K=p([k("esri.views.3d.interactive.editingTools.transformGraphic.ExtentTransformTool")],K);const Sa="draped-elevation-changes";export{jt as DrawGraphicTool3D,K as ExtentTransformTool,gt as GraphicMoveTool,U as GraphicReshapeTool,N as GraphicTransformTool};
