import{cp as W,bv as ir,g8 as ft,_ as o,$ as l,a1 as v,a2 as de,bN as J,bY as $t,aK as nr,hx as Ye,s as w,gL as st,cy as Ft,bu as ge,cx as te,a0 as _e,L as pe,y as me,bR as ar,aq as ne,b0 as Pt,cr as fe,ce as Be,bE as we,le as gt,mm as wt,iQ as or,iB as sr,bz as Ot,bB as jt,bA as lr,hY as pr,Bt as dr,g9 as re,c4 as _t,b_ as $e,cl as Fe,iF as ur,iG as hr,bZ as cr,b$ as yr,iM as mr,an as At,V as bt,hd as Tt,A as fr}from"./chunk-AGUgPSYp.js";import{p as Z}from"./chunk-U0jvYCSY.js";import{_ as He}from"./chunk-oVLQlo07.js";import{m as gr}from"./chunk-c-Hb2HUP.js";import{W as wr}from"./chunk-SDGzCKa6.js";import"./chunk-2Rydd198.js";import"./chunk-YNLOY4vG.js";import"./chunk-cdSqQa6L.js";import"./chunk-FQ6JeNDJ.js";import"./chunk-v6EOeNTY.js";import"./chunk-YfR_ceww.js";import"./chunk-UUVz3sVw.js";import"./chunk-humpx67F.js";const _r="ESRI__DESTINATION_ID",br="ESRI__ORIGIN_ID";let Pe=class V{constructor(){this._featureLookup=new Map}static getInstance(){return V.instance||(V.instance=new V),V.instance}static resetInstance(){V.instance&&(V.instance=null)}deleteFromStore(t){t.forEach(r=>{this._featureLookup.delete(r)})}readFromStoreByList(t){const r=[];return t.forEach(i=>{const n=this.readFromStoreById(i);n&&r.push(n)}),r}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,r,i){const n=[];return t.forEach(a=>{if(!a?.id)return;a.properties||(a.properties=[]);let s,d=null;if(i&&a.properties[i]&&(d=W(a.properties[i])),"originId"in a&&"destinationId"in a&&(a.properties[br]=a.originId,a.properties[_r]=a.destinationId),a.properties[r]=a.id,a.id&&this._featureLookup.has(a.id)&&this._featureLookup.get(a.id).attributes){const c=this._featureLookup.get(a.id),u=JSON.parse(JSON.stringify(Object.assign(c.attributes,a.properties)));i&&a.properties[i]&&(u[i]=ir(a.properties[i])),s=new ft(d?JSON.parse(JSON.stringify(d)):c?.geometry?JSON.parse(JSON.stringify(c.geometry)):null,u,null,a.properties[r])}else s=new ft(d?JSON.parse(JSON.stringify(d)):null,a.properties,null,a.properties[r]);this._featureLookup.set(a.id,s),n.push(s)}),n}},ke=class extends de{constructor(t){super(t),this.resultRows=[]}};o([l()],ke.prototype,"resultRows",void 0),ke=o([v("esri.rest.knowledgeGraph.GraphQueryResult")],ke);const Et=ke;let Me=class extends de{constructor(t){super(t),this.resultRowsStream=new ReadableStream}};o([l()],Me.prototype,"resultRowsStream",void 0),Me=o([v("esri.rest.knowledgeGraph.GraphQueryResult")],Me);const kt=Me;let B=class extends J{constructor(t){super(t),this.name=null,this.unique=null,this.ascending=null,this.description=null,this.fieldNames=null}};o([l({type:String,json:{write:!0}})],B.prototype,"name",void 0),o([l({type:Boolean,json:{write:!0}})],B.prototype,"unique",void 0),o([l({type:Boolean,json:{write:!0}})],B.prototype,"ascending",void 0),o([l({type:String,json:{write:!0}})],B.prototype,"description",void 0),o([l({type:[String],json:{write:!0}})],B.prototype,"fieldNames",void 0),B=o([v("esri.rest.knowledgeGraph.FieldIndex")],B);const zt=B;let N=class extends J{constructor(t){super(t),this.name=null,this.alias=null,this.fieldType=null,this.geometryType=null,this.hasM=null,this.hasZ=null,this.nullable=null,this.editable=null,this.required=null,this.defaultVisibility=null,this.systemMaintained=null,this.role=null,this.defaultValue=null}};o([l({type:String,json:{write:!0}})],N.prototype,"name",void 0),o([l({type:String,json:{write:!0}})],N.prototype,"alias",void 0),o([l({type:String,json:{write:!0}})],N.prototype,"fieldType",void 0),o([l({type:String,json:{write:!0}})],N.prototype,"geometryType",void 0),o([l({type:Boolean,json:{write:!0}})],N.prototype,"hasM",void 0),o([l({type:Boolean,json:{write:!0}})],N.prototype,"hasZ",void 0),o([l({type:Boolean,json:{write:!0}})],N.prototype,"nullable",void 0),o([l({type:Boolean,json:{write:!0}})],N.prototype,"editable",void 0),o([l({type:Boolean,json:{write:!0}})],N.prototype,"required",void 0),o([l({type:Boolean,json:{write:!0}})],N.prototype,"defaultVisibility",void 0),o([l({type:Boolean,json:{write:!0}})],N.prototype,"systemMaintained",void 0),o([l()],N.prototype,"role",void 0),o([l({type:Object,json:{type:String,write:{writer:(e,t)=>{t.defaultValue=e!=null?e.toString():null}}}})],N.prototype,"defaultValue",void 0),N=o([v("esri.rest.knowledgeGraph.GraphProperty")],N);const Qt=N;let Y=class extends J{constructor(t){super(t),this.name=null,this.alias=null,this.role=null,this.strict=null,this.properties=null,this.fieldIndexes=null}};o([l({type:String,json:{write:!0}})],Y.prototype,"name",void 0),o([l({type:String,json:{write:!0}})],Y.prototype,"alias",void 0),o([l({type:String,json:{write:!0}})],Y.prototype,"role",void 0),o([l({type:Boolean,json:{write:!0}})],Y.prototype,"strict",void 0),o([l({type:[Qt],json:{write:!0}})],Y.prototype,"properties",void 0),o([l({type:[zt],json:{write:!0}})],Y.prototype,"fieldIndexes",void 0),Y=o([v("esri.rest.knowledgeGraph.GraphObjectType")],Y);const Ut=Y;let Je=class extends Ut{constructor(t){super(t)}};Je=o([v("esri.rest.knowledgeGraph.EntityType")],Je);const lt=Je;let xe=class extends Ut{constructor(t){super(t),this.endPoints=[]}};o([l()],xe.prototype,"endPoints",void 0),xe=o([v("esri.rest.knowledgeGraph.RelationshipType")],xe);const pt=xe;let j=class extends J{constructor(t){super(t),this.timestamp=null,this.spatialReference=null,this.strict=null,this.objectIdField=null,this.globalIdField=null,this.arcgisManaged=null,this.identifierInfo=null,this.searchIndexes=null,this.entityTypes=null,this.relationshipTypes=null}};o([l({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.timestamp=e?.getTime()}}}})],j.prototype,"timestamp",void 0),o([l({type:$t,json:{write:!0}})],j.prototype,"spatialReference",void 0),o([l({type:Boolean,json:{write:!0}})],j.prototype,"strict",void 0),o([l({type:String,json:{write:!0}})],j.prototype,"objectIdField",void 0),o([l({type:String,json:{write:!0}})],j.prototype,"globalIdField",void 0),o([l()],j.prototype,"arcgisManaged",void 0),o([l()],j.prototype,"identifierInfo",void 0),o([l()],j.prototype,"searchIndexes",void 0),o([l({type:[lt],json:{write:!0}})],j.prototype,"entityTypes",void 0),o([l({type:[pt],json:{write:!0}})],j.prototype,"relationshipTypes",void 0),j=o([v("esri.rest.knowledgeGraph.DataModel")],j);const qt=j;let G=class extends J{constructor(t){super(t),this.capabilities=[],this.supportsSearch=!1,this.supportedQueryFormats=[],this.allowGeometryUpdates=!1,this.searchMaxRecordCount=null,this.serviceCapabilities=null,this.maxRecordCount=null,this.description="",this.copyrightText="",this.units="",this.spatialReference=null,this.currentVersion=null,this.dateFieldsTimeReference=null,this.serviceItemId="",this.supportsDocuments=!1,this.dataEditingNotSupported=!1,this.schemaEditingNotSupported=!1}};o([l({type:[String],json:{write:!0}})],G.prototype,"capabilities",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"supportsSearch",void 0),o([l({type:[String],json:{write:!0}})],G.prototype,"supportedQueryFormats",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"allowGeometryUpdates",void 0),o([l({type:Number,json:{write:!0}})],G.prototype,"searchMaxRecordCount",void 0),o([l({type:Object,json:{write:!0}})],G.prototype,"serviceCapabilities",void 0),o([l({type:Number,json:{write:!0}})],G.prototype,"maxRecordCount",void 0),o([l({type:String,json:{write:!0}})],G.prototype,"description",void 0),o([l({type:String,json:{write:!0}})],G.prototype,"copyrightText",void 0),o([l({type:String,json:{write:!0}})],G.prototype,"units",void 0),o([l({type:Object,json:{write:!0}})],G.prototype,"spatialReference",void 0),o([l({type:Number,json:{write:!0}})],G.prototype,"currentVersion",void 0),o([l({type:Object,json:{write:!0}})],G.prototype,"dateFieldsTimeReference",void 0),o([l({type:String,json:{write:!0}})],G.prototype,"serviceItemId",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"supportsDocuments",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"dataEditingNotSupported",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"schemaEditingNotSupported",void 0),G=o([v("esri.rest.knowledgeGraph.ServiceDefinition")],G);const Yt=G;let ae=class extends J{constructor(t){super(t),this.dataModel=null,this.serviceDefinition=null}};o([l({type:String,json:{write:!0}})],ae.prototype,"url",void 0),o([l({type:qt,json:{write:!0}})],ae.prototype,"dataModel",void 0),o([l({type:Yt,json:{write:!0}})],ae.prototype,"serviceDefinition",void 0),ae=o([v("esri.rest.knowledgeGraph.KnowledgeGraph")],ae);const Tr=ae,Mt="esri/rest/knowledgeGraph/wasmInterface/";let Oe;async function H(){const e=Oe;if(e)return e;const t=nr("wasm-simd");return Oe=Er(t),Oe}async function Er(e){if(e){const{default:r}=await He(()=>import("./chunk-WFXsWejX.js"),__vite__mapDeps([0,1,2,3])).then(i=>i.a);return r({locateFile:i=>Ye(Mt+i)})}const{default:t}=await He(()=>import("./chunk-z2P5Qf-e.js"),__vite__mapDeps([4,1,2,3])).then(r=>r.a);return t({locateFile:r=>Ye(Mt+r)})}function Bt(e,t){const r=new t.ArrayValue;return r.deleteLater(),e.forEach(i=>{r.add_value(ut(i,t))}),r}function Ht(e,t){const r=new t.ObjectValue;r.deleteLater();for(const[i,n]of Object.entries(e))r.set_key_value(i,ut(n,t));return r}function dt(e,t){if(e instanceof Ft)return Cr(e,t);if(e instanceof ge)return Ir(e,t);if(e instanceof te||e instanceof _e)return xr(e,t);throw new w("knowledge-graph:unsupported-geometry","Only Point, Multipoint, Polyline, and Polygon geometry are supported by ArcGIS Knowledge",{geometry:e})}function kr(e,t){t.input_quantization_parameters={xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function Mr(e,t,r){if(!e.extent)throw new w("knowledge-graph:illegal-output-quantization","The Output quantization provided to the encoder had an illegal value as part of its extent",e.extent);if(!e.quantizeMode)throw new w("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal mode setting",e.quantizeMode);if(!e.tolerance)throw new w("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal tolerance setting",e.quantizeMode);t.output_quantization_parameters={extent:{xmax:e.extent.xmax,ymax:e.extent.ymax,xmin:e.extent.xmin,ymin:e.extent.ymin},quantize_mode:r.esriQuantizeMode[e.quantizeMode],tolerance:e.tolerance}}function ut(e,t){if(e==null)return"";if(typeof e!="object"||e instanceof Date)return e;if(e instanceof st)return dt(e,t);if(Array.isArray(e)){const r=new t.ArrayValue;return r.deleteLater(),e.forEach(i=>{r.add_value(ut(i,t))}),r}return Ht(e,t)}function xr(e,t){const r=new t.GeometryValue;r.deleteLater(),r.has_z=e.hasZ,r.has_m=e.hasM;const i=[],n=[];let a=[];e instanceof te?(r.geometry_type=t.esriGeometryType.esriGeometryPolyline,a=e.paths):e instanceof _e&&(r.geometry_type=t.esriGeometryType.esriGeometryPolygon,a=e.rings);let s=0,d=0;return a.forEach(c=>{let u=0;c.forEach(y=>{u++,y.forEach(b=>{i[d]=b,d++})}),n[s]=u,s++}),r.coords=new Float64Array(i),r.lengths=new Uint32Array(n),r}function Cr(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=r.geometry_type=t.esriGeometryType.esriGeometryMultipoint,r.has_z=e.hasZ,r.has_m=e.hasM;const i=[],n=[];n[0]=e.points.length;let a=0;return e.points.forEach(s=>{s.forEach(d=>{i[a]=d,a++})}),r.coords=new Float64Array(i),r.lengths=new Uint32Array(n),r}function Ir(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=t.esriGeometryType.esriGeometryPoint,r.has_z=e.hasZ,r.has_m=e.hasM;const i=[],n=[];n[0]=1,i[0]=e.x,i[1]=e.y;let a=2;return e.hasZ&&(i[a]=e.z,a++),e.hasM&&(i[a]=e.m,a++),r.coords=new Float64Array(i),r.lengths=new Uint32Array(n),r}let Ce=class extends J{constructor(t){super(t),this.properties=null}};o([l({json:{write:!0}})],Ce.prototype,"properties",void 0),Ce=o([v("esri.rest.knowledgeGraph.GraphObject")],Ce);const ht=Ce;let ce=class extends ht{constructor(t){super(t),this.typeName=null,this.id=null}};o([l({type:String,json:{write:!0}})],ce.prototype,"typeName",void 0),o([l({type:String,json:{write:!0}})],ce.prototype,"id",void 0),ce=o([v("esri.rest.knowledgeGraph.GraphNamedObject")],ce);const Jt=ce;let Ie=class extends Jt{constructor(t){super(t),this.layoutGeometry=null}};o([l({type:ge,json:{write:!0}})],Ie.prototype,"layoutGeometry",void 0),Ie=o([v("esri.rest.knowledgeGraph.Entity")],Ie);const Wt=Ie;let oe=class extends Jt{constructor(t){super(t),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};o([l({type:String,json:{write:!0}})],oe.prototype,"originId",void 0),o([l({type:String,json:{write:!0}})],oe.prototype,"destinationId",void 0),o([l({type:te,json:{write:!0}})],oe.prototype,"layoutGeometry",void 0),oe=o([v("esri.rest.Relationship.Relationship")],oe);const Vt=oe;function Te(e,t){if(!e.typeName)throw new w("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits");if(e instanceof Wt){const r=new t.EntityValue;r.deleteLater(),r.type_name=e.typeName;for(const[i,n]of Object.entries(e.properties))r.set_key_value(i,xt(n,t));return e.id&&r.set_id(e.id),r}if(e instanceof Vt){const r=new t.RelationshipValue;r.deleteLater(),r.type_name=e.typeName;for(const[i,n]of Object.entries(e.properties))r.set_key_value(i,xt(n,t));return e.id&&r.set_id(e.id),e.originId&&e.destinationId&&r.set_related_entity_ids(e.originId,e.destinationId),r}throw new w("knowledge-graph:applyEdits-encoding-failure","Could not determine the type of a named graph object passed to the encoder")}function Lr(e){return{xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function xt(e,t){return e==null?"":typeof e!="object"||e instanceof Date?e:e instanceof st?dt(e,t):""}let K=class extends de{constructor(t){super(t),this.name=null,this.supportedCategory=null,this.analyzers=[],this.searchProperties=new Map}};o([l()],K.prototype,"name",void 0),o([l()],K.prototype,"supportedCategory",void 0),o([l()],K.prototype,"analyzers",void 0),o([l()],K.prototype,"searchProperties",void 0),K=o([v("esri.rest.knowledgeGraph.SearchIndex")],K);const vr=K;var Ge,Re,Se,We,Ve,Ke,Ze;(function(e){e[e.Regular=0]="Regular",e[e.Provenance=1]="Provenance",e[e.Document=2]="Document"})(Ge||(Ge={})),function(e){e[e.esriFieldTypeSmallInteger=0]="esriFieldTypeSmallInteger",e[e.esriFieldTypeInteger=1]="esriFieldTypeInteger",e[e.esriFieldTypeSingle=2]="esriFieldTypeSingle",e[e.esriFieldTypeDouble=3]="esriFieldTypeDouble",e[e.esriFieldTypeString=4]="esriFieldTypeString",e[e.esriFieldTypeDate=5]="esriFieldTypeDate",e[e.esriFieldTypeOID=6]="esriFieldTypeOID",e[e.esriFieldTypeGeometry=7]="esriFieldTypeGeometry",e[e.esriFieldTypeBlob=8]="esriFieldTypeBlob",e[e.esriFieldTypeRaster=9]="esriFieldTypeRaster",e[e.esriFieldTypeGUID=10]="esriFieldTypeGUID",e[e.esriFieldTypeGlobalID=11]="esriFieldTypeGlobalID",e[e.esriFieldTypeXML=12]="esriFieldTypeXML",e[e.esriFieldTypeBigInteger=13]="esriFieldTypeBigInteger",e[e.esriFieldTypeDateOnly=14]="esriFieldTypeDateOnly",e[e.esriFieldTypeTimeOnly=15]="esriFieldTypeTimeOnly",e[e.esriFieldTypeTimestampOffset=16]="esriFieldTypeTimestampOffset"}(Re||(Re={})),function(e){e[e.esriGeometryNull=0]="esriGeometryNull",e[e.esriGeometryPoint=1]="esriGeometryPoint",e[e.esriGeometryMultipoint=2]="esriGeometryMultipoint",e[e.esriGeometryPolyline=3]="esriGeometryPolyline",e[e.esriGeometryPolygon=4]="esriGeometryPolygon",e[e.esriGeometryEnvelope=5]="esriGeometryEnvelope",e[e.esriGeometryAny=6]="esriGeometryAny",e[e.esriGeometryMultiPatch=7]="esriGeometryMultiPatch"}(Se||(Se={})),function(e){e[e.esriMethodHintUNSPECIFIED=0]="esriMethodHintUNSPECIFIED",e[e.esriUUIDESRI=1]="esriUUIDESRI",e[e.esriUUIDRFC4122=2]="esriUUIDRFC4122"}(We||(We={})),function(e){e[e.esriTypeUNSPECIFIED=0]="esriTypeUNSPECIFIED",e[e.esriTypeEntity=1]="esriTypeEntity",e[e.esriTypeRelationship=2]="esriTypeRelationship",e[e.esriTypeBoth=4]="esriTypeBoth"}(Ve||(Ve={})),function(e){e[e.esriGraphPropertyUNSPECIFIED=0]="esriGraphPropertyUNSPECIFIED",e[e.esriGraphPropertyRegular=1]="esriGraphPropertyRegular",e[e.esriGraphPropertyDocumentName=2]="esriGraphPropertyDocumentName",e[e.esriGraphPropertyDocumentTitle=3]="esriGraphPropertyDocumentTitle",e[e.esriGraphPropertyDocumentUrl=4]="esriGraphPropertyDocumentUrl",e[e.esriGraphPropertyDocumentText=5]="esriGraphPropertyDocumentText",e[e.esriGraphPropertyDocumentKeywords=6]="esriGraphPropertyDocumentKeywords",e[e.esriGraphPropertyDocumentContentType=7]="esriGraphPropertyDocumentContentType",e[e.esriGraphPropertyDocumentMetadata=8]="esriGraphPropertyDocumentMetadata",e[e.esriGraphPropertyDocumentFileExtension=9]="esriGraphPropertyDocumentFileExtension"}(Ke||(Ke={})),function(e){e[e.esriIdentifierInfoTypeUNSPECIFIED=0]="esriIdentifierInfoTypeUNSPECIFIED",e[e.esriIdentifierInfoTypeDatabaseNative=1]="esriIdentifierInfoTypeDatabaseNative",e[e.esriIdentifierInfoTypeUniformProperty=2]="esriIdentifierInfoTypeUniformProperty"}(Ze||(Ze={}));function Dr(e){return e.deleteLater(),new qt({timestamp:e.timestamp,spatialReference:new $t(e.spatial_reference),strict:e.strict,objectIdField:e.objectid_property,globalIdField:e.globalid_property,arcgisManaged:e.arcgis_managed,identifierInfo:{identifierMappingInfo:{identifierInfoType:Ze[e.identifier_info?.identifier_mapping_info?.identifier_info_type?.value],databaseNativeIdentifier:e.identifier_info?.identifier_mapping_info?.database_native_identifier,uniformPropertyIdentifier:{identifierPropertyName:e.identifier_info?.identifier_mapping_info?.uniform_property_identifier?.identifier_property_name}},identifierGenerationInfo:{uuidMethodHint:We[e.identifier_info?.identifier_generation_info?.uuid_method_hint?.value]}},searchIndexes:Ar(e.search_indexes),entityTypes:$r(e.entity_types),relationshipTypes:jr(e.relationship_types)})}function Gr(e){return e.deleteLater(),new lt(Kt(e))}function Rr(e){return e.deleteLater(),new zt({name:e.name,unique:e.unique,ascending:e.ascending,description:e.description,fieldNames:Fr(e.fields)})}function Kt(e){return{name:e.name,alias:e.alias,role:Ge[e.role.value]?Ge[e.role.value]:null,strict:e.strict,properties:Pr(e.properties),fieldIndexes:Or(e.field_indexes)}}function Sr(e){return e.deleteLater(),new Qt({alias:e.alias,name:e.name,fieldType:Re[e.field_type.value]?Re[e.field_type.value]:null,geometryType:Se[e.geometry_type.value]?Se[e.geometry_type.value]:null,hasM:e.has_m,hasZ:e.has_z,nullable:e.nullable,editable:e.editable,required:e.required,defaultVisibility:e.default_visibility,systemMaintained:e.system_maintained,role:Ke[e.role.value],defaultValue:e.default_value})}function Nr(e){e.deleteLater();const t=Kt(e),r=[];for(let i=0;i<e.end_points.size();i++){const n=e.end_points.get(i);r.push({originEntityType:n.origin_entity_type,destinationEntityType:n.dest_entity_type})}return new pt(Object.assign({endPoints:r},t))}function $r(e){const t=[];for(let r=0;r<e.size();r++)t.push(Gr(e.get(r)));return t}function Fr(e){const t=[];for(let r=0;r<e.size();r++)t.push(e.get(r));return t}function Pr(e){const t=[];for(let r=0;r<e.size();r++)t.push(Sr(e.get(r)));return t}function Or(e){const t=[];for(let r=0;r<e.size();r++)t.push(Rr(e.get(r)));return t}function jr(e){const t=[];for(let r=0;r<e.size();r++)t.push(Nr(e.get(r)));return t}function Ar(e){const t=[];for(let r=0;r<e.size();r++){const i=new vr,n=e.get(0);i.name=n.name,i.supportedCategory=Ve[n.supported_category.value];const a=n.analyzers.size();for(let s=0;s<a;s++)i.analyzers.push({name:n.analyzers.get(s).name});for(let s=0;s<n.search_properties.keys().size();s++){const d=n.search_properties.keys().get(s),c=n.search_properties.get(d),u=[];for(let y=0;y<c.property_names.size();y++)u.push(c.property_names.get(y));i.searchProperties.set(d,{propertyNames:u})}t.push(i)}return t}let Xe=class extends ht{constructor(t){super(t)}};Xe=o([v("esri.rest.knowledgeGraph.ObjectValue")],Xe);const zr=Xe;let Le=class extends J{constructor(t){super(t),this.path=null}};o([l({type:[ht],json:{write:!0}})],Le.prototype,"path",void 0),Le=o([v("esri.rest.knowledgeGraph.Path")],Le);const Qr=Le;var A;(function(e){e[e.ESRI_GEOMETRY_NULL=0]="ESRI_GEOMETRY_NULL",e[e.ESRI_GEOMETRY_POINT=1]="ESRI_GEOMETRY_POINT",e[e.ESRI_GEOMETRY_MULTIPOINT=2]="ESRI_GEOMETRY_MULTIPOINT",e[e.ESRI_GEOMETRY_POLYLINE=3]="ESRI_GEOMETRY_POLYLINE",e[e.ESRI_GEOMETRY_POLYGON=4]="ESRI_GEOMETRY_POLYGON",e[e.ESRI_GEOMETRY_ENVELOPE=5]="ESRI_GEOMETRY_ENVELOPE",e[e.ESRI_GEOMETRY_ANY=6]="ESRI_GEOMETRY_ANY",e[e.ESRI_GEOMETRY_MULTI_PATCH=7]="ESRI_GEOMETRY_MULTI_PATCH"})(A||(A={}));var X,Ct;(function(e){e[e.OBJECT=0]="OBJECT",e[e.ENTITY=1]="ENTITY",e[e.RELATIONSHIP=2]="RELATIONSHIP",e[e.PATH=3]="PATH",e[e.ARRAY=4]="ARRAY"})(X||(X={})),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(Ct||(Ct={}));function Ur(e){const t={},r=ct(e,t),i=e.lengths,n=e.coords,a=i[0];t.points=[];let s=0;for(let d=0;d<a;d++){const c=[];for(let u=0;u<r;u++)c[u]=n[s],s++;t.points.push(c)}return new Ft(t)}function qr(e){const t={};let r=2;ct(e,t);const i=e.coords;return t.x=i[0],t.y=i[1],e.has_z&&(t.z=i[r],r++),e.has_m&&(t.m=i[r]),new ge(t)}function Yr(e){return new te(Zt(e))}function Br(e){return new _e(Zt(e))}function Zt(e){const t={},r=ct(e,t),i=e.lengths,n=e.coords;let a="";if(e.geometry_type.value===A.ESRI_GEOMETRY_POLYGON)a="rings";else{if(e.geometry_type.value!==A.ESRI_GEOMETRY_POLYLINE)throw new w("KnowledgeGraph:illegal-geometry-type","Illegal Geometry type for multipath conversion");a="paths"}t[a]=[];let s=0;return i.forEach(d=>{const c=[];for(let u=0;u<d;u++){const y=[];for(let b=0;b<r;b++)y[b]=n[s],s++;c.push(y)}t[a].push(c)}),t}function ct(e,t){let r=2;return e.has_z?(t.hasZ=e.has_z,r++):t.hasZ=!1,e.has_m?(t.hasM=e.has_m,r++):t.hasM=!1,r}const Ee=pe.getLogger("esri.rest.knowledgeGraph.WasmToQueryResponseObjConstructors"),Hr={decodedWasmObjToQueryResponseObj:(e,t)=>{if(e==null)return null;if(typeof e!="object"||"getDate"in e)return e;if("geometry_type"in e)switch(e.geometry_type.value){case null:return null;case A.ESRI_GEOMETRY_POINT:return qr(e);case A.ESRI_GEOMETRY_MULTIPOINT:return Ur(e);case A.ESRI_GEOMETRY_POLYLINE:return Yr(e);case A.ESRI_GEOMETRY_POLYGON:return Br(e);case A.ESRI_GEOMETRY_ENVELOPE:case A.ESRI_GEOMETRY_MULTI_PATCH:return Ee.warnOnce("Envelope and Multipatch are not supported on knowledge entities, but one of those geometry types was detected. Result interpreted as null"),null;case A.ESRI_GEOMETRY_NULL:case A.ESRI_GEOMETRY_ANY:default:return Ee.warnOnce("Unknown or blank geometry type returned - Result interpreted as null"),null}else{if(!("object_value_type"in e))return Ee.warnOnce("A decoded value came back of a type that is not supported. Result interpreted as null"),null;switch(e.object_value_type.value){case X.OBJECT:return Wr(e,t);case X.ENTITY:return Xt(e,t);case X.RELATIONSHIP:return er(e,t);case X.PATH:return Vr(e,t);case X.ARRAY:return Jr(e,t);default:return Ee.warnOnce("Unknown graph object type detected!  Result interpreted as null"),null}}}};function Jr(e,t){const r=[],i=e.count();for(let n=0;n<i;n++){const a=e.get_value_at(n);r.push(yt(a,t))}return r}function yt(e,t){return Hr.decodedWasmObjToQueryResponseObj(e,t)}function Xt(e,t){const r=e.type_name,i=mt(e,t),n=e.get_id();return new Wt(Object.assign({typeName:r,id:n},i))}function mt(e,t){const r={},i=e.key_count();for(let n=0;n<i;n++)r[e.get_key_at(n)]=yt(e.get_value_at(n),t);return{properties:r}}function Wr(e,t){return new zr(mt(e,t))}function Vr(e,t){const r=e.entity_count(),i=e.relationship_count(),n=[];for(let a=0;a<r;a++)n.push(Xt(e.get_entity_at(a),t)),a<i&&n.push(er(e.get_relationship_at(a),t));return new Qr({path:n})}function er(e,t){const r=e.type_name,i=mt(e,t);return new Vt(Object.assign({typeName:r,id:e.get_id(),originId:e.get_origin_entity_id(),destinationId:e.get_destination_entity_id()},i))}let se=class extends de{constructor(t){super(t),this.hasError=null,this.error=null,this.editResults=[]}};o([l()],se.prototype,"hasError",void 0),o([l()],se.prototype,"error",void 0),o([l()],se.prototype,"editResults",void 0),se=o([v("esri.rest.knowledgeGraph.GraphApplyEdits")],se);const Kr=se;function Zr(e){const t=new Kr;t.hasError=e.has_error(),t.hasError&&(t.error={errorCode:e.error.error_code,errorMessage:e.error.error_message});const r=e.get_edit_results_count();for(let i=0;i<r;i++){const n=e.get_edit_results_at(i),a=e.get_edit_results_type_name_at(i),s=[],d=[],c=[],u=n.get_add_results_count(),y=n.get_update_results_count(),b=n.get_delete_results_count();for(let _=0;_<u;_++){const h=n.get_add_result_at(_);s.push({id:h.id,error:{errorCode:h.error.error_code,errorMessage:h.error.error_message}})}for(let _=0;_<y;_++){const h=n.get_update_result_at(_);d.push({id:h.id,error:{errorCode:h.error.error_code,errorMessage:h.error.error_message}})}for(let _=0;_<b;_++){const h=n.get_delete_result_at(_);c.push({id:h.id,error:{errorCode:h.error.error_code,errorMessage:h.error.error_message}})}t.editResults.push({typeName:a,adds:s,updates:d,deletes:c})}return t}const be={fetchKnowledgeGraph:async e=>{const t=new Tr({url:e}),r=[];return r.push(Ne(t)),r.push(ei(t)),await Promise.all(r),t},refreshDataModel:async e=>{e.dataModel=await tr(e)},refreshServiceDefinition:async e=>{const t=(await me(e.url,{query:{f:"json"}})).data;return t.capabilities=t?.capabilities?.split(","),t.supportedQueryFormats=t?.supportedQueryFormats?.split(","),e.serviceDefinition=new Yt(t),e.serviceDefinition},executeQueryStreaming:async(e,t,r)=>{const i=`${e.url}/graph/query`;await Ae(e);const n=await ze(i,r);n.data.body=await ii(t,e);const a=await je(n.data.url,n.data);if(e.dataModel)return new kt({resultRowsStream:await It(a,e.dataModel)});throw new w("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},executeApplyEdits:async(e,t,r)=>{if(e.serviceDefinition?.dataEditingNotSupported)throw new w("knowledge-graph:data-editing-not-supported","The Knowledge Graph Service definition indicated that data editing is not supported");const i=`${e.url}/graph/applyEdits`;await Ae(e);const n=await ze(i,r);return n.data.body=await ri(t,e),ai(await je(n.data.url,n.data))},executeQuery:async(e,t,r)=>{const i=`${e.url}/graph/query`,n=await me(i,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:t.openCypherQuery,...r?.query},signal:r?.signal,timeout:r?.timeout}),a=n.getHeader?.("content-type"),s=n.data;if(a?.includes("application/x-protobuf")){const d=new(await H()).GraphQueryDecoder;if(d.deleteLater(),e.dataModel)return new Et({resultRows:et(d,s,e.dataModel)});throw new w("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:a,data:n.data})},executeSearch:async(e,t,r)=>{const i=t.typeCategoryFilter,n=`${e.url}/graph/search`,a=await me(n,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${t.searchQuery}"`,typeCategoryFilter:i,...r?.query},signal:r?.signal,timeout:r?.timeout}),s=a.getHeader?.("content-type"),d=a.data;if(s?.includes("application/x-protobuf")){const c=new(await H()).GraphQueryDecoder;if(c.deleteLater(),e.dataModel)return new Et({resultRows:et(c,d,e.dataModel)});throw new w("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:s,data:a.data})},executeSearchStreaming:async(e,t,r)=>{const i=`${e.url}/graph/search`;await Ae(e);const n=await ze(i,r);n.data.body=await ni(t);const a=await je(n.data.url,n.data);if(e.dataModel)return new kt({resultRowsStream:await It(a,e.dataModel)});throw new w("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},_fetchWrapper:async(e,t)=>fetch(e,t)};async function ve(e,t,r){return be.executeQueryStreaming(e,t,r)}async function Xr(e){return be.fetchKnowledgeGraph(e)}async function Ne(e){return be.refreshDataModel(e)}async function ei(e){return be.refreshServiceDefinition(e)}async function je(e,t){return be._fetchWrapper(e,t)}async function Ae(e){ar?.findCredential(e.url)||(e.dataModel?await tr(e):await Ne(e))}function ue(e,t,r){if(e.error_code!==0)throw new w(t,r,{errorCode:e.error_code,errorMessage:e.error_message})}function ti(e,t,r,i){t==null?r.set_param_key_value(e,""):typeof t!="object"||t instanceof Date?r.set_param_key_value(e,t):t instanceof st?r.set_param_key_value(e,dt(t,i)):t instanceof Array?r.set_param_key_value(e,Bt(t,i)):r.set_param_key_value(e,Ht(t,i))}async function ri(e,t){if(t.dataModel||await Ne(t),!t.dataModel)throw new w("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const r=await H(),i=!!e.options?.cascadeDelete,n=new r.GraphApplyEditsEncoder(r.SpatialReferenceUtil.WGS84(),e.options?.inputQuantizationParameters?Lr(e.options?.inputQuantizationParameters):r.InputQuantizationUtil.WGS84_lossless());n.deleteLater(),n.cascade_delete=i;try{let s;e.entityAdds?.forEach(d=>{s=n.add_entity(Te(d,r)),ue(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")}),e.relationshipAdds?.forEach(d=>{if(!d.originId||!d.destinationId)throw new w("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination id on the appropriate class property");s=n.add_relationship(Te(d,r)),ue(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")}),e.entityUpdates?.forEach(d=>{if(!d.id)throw new w("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");s=n.update_entity(Te(d,r)),ue(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")}),e.relationshipUpdates?.forEach(d=>{if(!d.id)throw new w("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");s=n.update_relationship(Te(d,r)),ue(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")}),e.entityDeletes?.forEach(d=>{if(!d.typeName)throw new w("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const c=n.make_delete_helper(d.typeName,!0);c.deleteLater(),d.ids?.forEach(u=>{c.delete_by_id(u)})}),e.relationshipDeletes?.forEach(d=>{if(!d.typeName)throw new w("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const c=n.make_delete_helper(d.typeName,!1);d.ids?.forEach(u=>{c.delete_by_id(u)})}),n.encode()}catch(s){throw new w("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:s})}const a=n.get_encoding_result();return ue(a.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed"),a.get_byte_buffer()}async function ii(e,t){const r=await H(),i=new r.GraphQueryRequestEncoder;if(i.deleteLater(),i.output_spatial_reference=r.SpatialReferenceUtil.WGS84(),i.open_cypher_query=e.openCypherQuery,e.bindParameters)for(const[a,s]of Object.entries(e.bindParameters))ti(a,s,i,r);if(e.bindGeometryQuantizationParameters)kr(e.bindGeometryQuantizationParameters,i);else{if(t.dataModel||await Ne(t),t.dataModel?.spatialReference?.wkid!==4326)throw new w("knowledge-graph:SR-quantization-mismatch","If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");i.input_quantization_parameters=r.InputQuantizationUtil.WGS84_lossless()}e.outputQuantizationParameters&&Mr(e.outputQuantizationParameters,i,r);try{i.encode()}catch(a){throw new w("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:a})}const n=i.get_encoding_result();if(n.error.error_code!==0)throw new w("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{errorCode:n.error.error_code,errorMessage:n.error.error_message});return n.get_byte_buffer()}async function ni(e){const t=await H(),r=new t.GraphSearchRequestEncoder;if(r.deleteLater(),r.search_query=e.searchQuery,r.type_category_filter=t.esriNamedTypeCategory[e.typeCategoryFilter],e.returnSearchContext===!0&&(r.return_search_context=e.returnSearchContext),e.start!=null&&e.start>0&&(r.start_index=e.start),e.num!=null&&(r.max_num_results=e.num),e.idsFilter!=null&&Array.isArray(e.idsFilter)&&e.idsFilter.length>0)try{r.set_ids_filter(Bt(e.idsFilter,t))}catch(n){throw new w("knowledge-graph:ids-format-error","Attempting to set ids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:n})}e.namedTypesFilter?.forEach(n=>{r.add_named_type_filter(n)});try{r.encode()}catch(n){throw new w("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{error:n})}const i=r.get_encoding_result();if(i.error.error_code!==0)throw new w("knowledge-graph:search-encoding-failed","Attempting to get encoding result from the query failed",{errorCode:i.error.error_code,errorMessage:i.error.error_message});return i.get_byte_buffer()}async function ze(e,t){return me(e,{responseType:"native-request-init",method:"post",query:{f:"pbf",...t?.query},body:"x",headers:{"Content-Type":"application/octet-stream"},signal:t?.signal,timeout:t?.timeout})}async function ai(e){const t=e.headers.get("content-type");if(t?.includes("application/x-protobuf")){const r=await e.arrayBuffer(),i=new(await H()).GraphApplyEditsDecoder;return i.deleteLater(),i.decode(new Uint8Array(r)),Zr(i)}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:t,data:e.text()})}function et(e,t,r){e.push_buffer(new Uint8Array(t));const i=[];let n=0;for(;e.next_row();){n||(n=e.get_header_keys().size());const a=new Array(n);for(let s=0;s<n;s++){const d=e.get_value(s);a[s]=yt(d,r)}i.push(a)}if(e.has_error())throw new w("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:e.error.error_code,errorMessage:e.error.error_message});return i}async function It(e,t){const r=e.headers.get("content-type");if(e.headers.get("content-length")&&pe.getLogger("esri.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined."),r?.includes("application/x-protobuf")){const i=e.body?.getReader(),n=new(await H()).GraphQueryDecoder;return n.deleteLater(),new ReadableStream({async start(a){try{return s()}catch(d){i?.releaseLock(),a.error(new w("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:d})),a.close()}function s(){return i?.read().then(({done:d,value:c})=>{if(d){let y;if(n.has_error()&&(y=new w("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:n.error.error_code,errorMessage:n.error.error_message})),i.releaseLock(),y)throw a.error(y),y;return void a.close()}const u=et(n,c,t);return u.length>0&&a.enqueue(u),s()})}}})}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:r,data:e.text()})}async function tr(e){const t=`${e.url}/dataModel/queryDataModel`,r=await me(t,{responseType:"array-buffer",query:{f:"pbf"}}),i=r.getHeader?.("content-type"),n=r.data;if(i?.includes("application/x-protobuf")){const a=(await H()).decode_data_model_from_protocol_buffer(new Uint8Array(n));if(!a)throw new w("knowledge-graph:data-model-decode-failure","The server responded to the data model query, but the response failed to be decoded.  This typically occurs when the Knowledge JS API (4.26 or later) is used with an unsupported backend (11.0 or earlier)");return Dr(a)}throw new w("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:i,data:r.data})}let De=class extends de{constructor(t){super(t),this.openCypherQuery=""}};o([l()],De.prototype,"openCypherQuery",void 0),De=o([v("esri.rest.knowledgeGraph.GraphQuery")],De);const oi=De;let le=class extends oi{constructor(t){super(t),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null}};o([l()],le.prototype,"bindParameters",void 0),o([l()],le.prototype,"bindGeometryQuantizationParameters",void 0),o([l()],le.prototype,"outputQuantizationParameters",void 0),le=o([v("esri.rest.knowledgeGraph.GraphQueryStreaming")],le);const ye=le;function si(e){if(!e.spatialReference.isWGS84)throw new w("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let t;return t=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],t}async function li(e,t){const r=[],i=new Map,n=[];if(t.dataModel?.relationshipTypes)for(const a of t.dataModel.relationshipTypes)a.name&&i.set(a.name,[]);for(const a of e)i.has(a.typeName)&&i.get(a.typeName)?.push(a.id);for(const[a,s]of i){if(s.length<1)continue;const d=new ye({openCypherQuery:`MATCH (n)-[r:${a}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:s}});n.push(ve(t,d).then(async c=>{const u=c.resultRowsStream.getReader();for(;;){const{done:y,value:b}=await u.read();if(y)break;for(const _ of b)r.push({id:_[0],typeName:_[1]}),r.push({id:_[2],typeName:_[3]})}}))}return await Promise.all(n),r}const x="ESRI__ID",he="ESRI__ORIGIN_ID",Qe="ESRI__DESTINATION_ID",R="ESRI__LAYOUT_GEOMETRY",ee=12,Lt=pe.getLogger("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");let Q=class extends de{constructor(t){super(t),this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.memberIdTypeLookup=new Map,this._processingCacheUpdatesLookup=new Map;const r=new Map;t.knowledgeGraph.dataModel.entityTypes?.forEach(i=>{i.name&&(r.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),t.inclusionModeDefinition&&!t.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach(n=>{n.geometryType&&n.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:n.name??"",geometryType:n.geometryType})}))}),t.knowledgeGraph.dataModel.relationshipTypes?.forEach(i=>{i.name&&(r.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),t.inclusionModeDefinition&&!t.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach(n=>{n.geometryType&&n.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:n.name??"",geometryType:n.geometryType})}))}),t.inclusionModeDefinition?.namedTypeDefinitions.forEach((i,n)=>{if(r.get(n)==="entity")this.entityTypeNames.add(n);else{if(r.get(n)!=="relationship")return Lt.warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void t.inclusionModeDefinition?.namedTypeDefinitions.delete(n);this.relationshipTypeNames.add(n)}const a=new Map;i.members?.forEach(s=>{this.memberIdTypeLookup.set(s.id,n);const d=this.getById(s.id);d&&a.set(s.id,d)}),this.sublayerCaches.set(n,a)})}addToLayer(t){t.forEach(({typeName:r,id:i})=>{if(!this.inclusionModeDefinition)throw new w("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(r);n.members||(n.members=new Map),n.members.set(i,{id:i}),this.memberIdTypeLookup.set(i,r)}}else{const n=new Map;n.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(r,{useAllData:!1,members:n}),this.memberIdTypeLookup.set(i,r)}})}getById(t){return Pe.getInstance().readFromStoreById(t)}async getData(t,r,i){if(r.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(r.objectType.name))return[];let n;if(n=t||new ne({where:"1=1",outFields:["*"]}),r.parentCompositeLayer.type==="link-chart"){const a=r.parentCompositeLayer,s=this._processingCacheUpdatesLookup.get(r.objectType.name??""),d=n.outFields,c=n.geometry;let u="",y="";c&&c.extent&&(u=Z(c.extent.ymin,c.extent.xmin,ee),y=Z(c.extent.ymax,c.extent.xmax,ee)),d&&d.length===1&&d[0]===x&&n.where==="1=1"||await Promise.all(s??[]);const b=this.sublayerCaches.has(r.objectType.name??"")?Array.from(this.sublayerCaches.get(r.objectType.name)?.values()):[],_=[];return b.forEach(h=>{if(h.geometry=a.linkChartDiagramLookup.get(h.attributes[r.objectIdField]),h.attributes[R]=h.geometry,u&&y){const C=a.linkChartGeohashLookup.get(h.attributes[r.objectIdField]);C?C>=u&&C<=y&&_.push(h):_.push(h)}else _.push(h)}),_}return this.retrieveDataFromService(n,r,i)}async getConnectedRecordIds(t){const r=[],i=[],n=new Map;return t.forEach(a=>{if(this.memberIdTypeLookup.has(a)){const s=this.memberIdTypeLookup.get(a);if(!this.entityTypeNames.has(s))return;n.has(s)?n.get(s)?.push(a):n.set(s,[a])}}),n.forEach((a,s)=>{const d=`MATCH (n:${s})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`,c=new Promise(u=>{(async()=>{const y=(await ve(this.knowledgeGraph,new ye({openCypherQuery:d,bindParameters:{ids:a}}))).resultRowsStream.getReader();try{for(;;){const{done:b,value:_}=await y.read();if(b)break;for(let h=0;h<_.length;h++){const C=_[h];r.push({id:C[0],typeName:C[1]}),r.push({id:C[2],typeName:C[3]})}}}catch(b){if(b.name!=="AbortError")throw b;Lt.info("Request aborted as expected")}})().then(()=>{u()})});i.push(c)}),await Promise.all(i),r}async refreshCacheContent(t,r,i,n=!0){const a=Pe.getInstance(),s=[],d=new Map,c=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(u=>{u.name&&c.set(u.name,u)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(u=>{u.name&&c.set(u.name,u)}),t||this.inclusionModeDefinition?t?t.forEach(u=>{if(this.memberIdTypeLookup.has(u)){const y=this.memberIdTypeLookup.get(u);d.has(y)?d.get(y)?.push(u):d.set(y,[u])}}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((u,y)=>{u.useAllData?d.set(y,null):u.members&&u.members.forEach(b=>{d.has(y)&&d.get(y)!==null?d.get(y)?.push(b.id):d.set(y,[b.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(u=>{u.name&&d.set(u.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(u=>{u.name&&d.set(u.name,null)}));for(const[u,y]of d){const b=new Promise(_=>{(async()=>{const C=new Set,E=[];let g,T="",M=!1;if(r||c.get(u)?.properties?.forEach(m=>{m.name&&C.add(m.name)}),i&&this.geographicLookup.has(u)){const m=this.geographicLookup.get(u)?.name;m&&C.add(m)}if(this.entityTypeNames.has(u))T=`MATCH (n:${u}) ${y?"WHERE id(n) IN $ids ":""}return ID(n)`,C.forEach(m=>{T+=`, n.${m}`,E.push(m)});else{if(!this.relationshipTypeNames.has(u))throw new w("knowledge-graph:layer-data-manager",`The graph type of ${u} could not be determined. Was this type set in the KG data model and inclusion definition?`);M=!0,T=`MATCH ()-[n:${u}]->() ${y?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,C.forEach(m=>{T+=`, n.${m}`,E.push(m)})}g=new ye(y?{openCypherQuery:T,bindParameters:{ids:y}}:{openCypherQuery:T});const S=(await ve(this.knowledgeGraph,g)).resultRowsStream.getReader();for(;;){const{done:m,value:I}=await S.read();if(m)break;const L=[];for(let f=0;f<I.length;f++){const O=I[f];let F=0,q=0;const z={properties:{}};for(z.id=O[F],F++,q++,M&&(z.originId=O[F],F++,q++,z.destinationId=O[F],F++,q++,wt(this.nodeConnectionsLookup,z.originId,()=>new Set).add(z.id),wt(this.nodeConnectionsLookup,z.destinationId,()=>new Set).add(z.id));F<O.length;F++)z.properties[E[F-q]]=O[F];L.push(z)}const p=a.writeToStore(L,x,this.geographicLookup.get(u)?.name);this.sublayerCaches.has(u)||this.sublayerCaches.set(u,new Map),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(u)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(u,{useAllData:!1,members:new Map}),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(u).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(u).members=new Map);const k=this.sublayerCaches.get(u);p.forEach(f=>{k?.set(f.attributes[x],f),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(u).members.has(f.attributes[x])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(u).members.set(f.attributes[x],{id:f.attributes[x]}),this.memberIdTypeLookup.set(f.attributes[x],u))})}})().then(()=>{_(null)})});s.push(b),this._processingCacheUpdatesLookup.get(u)?.push(b)}await Promise.all(s)}removeFromLayer(t){const r=new Set,i=new Set(t.map(n=>n.id));for(const n of t)r.add(n.typeName),this.memberIdTypeLookup.delete(n.id),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(a=>{a.members?.has(n.id)&&a.members.delete(n.id)});r.forEach(n=>{this.sublayerCaches.get(n)?.forEach((a,s)=>{i.has(s)&&this.sublayerCaches.get(n)?.delete(s)})})}async retrieveDataFromService(t,r,i){const n=Pe.getInstance(),a=new Set,s=[];let d,c="",u=[];const y=r.graphType==="relationship",b=this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData,_=r.parentCompositeLayer.sublayerIdsCache.get(r.objectType.name);let h=!b&&_?Array.from(_).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData&&t.objectIds!=null&&(h=t.objectIds);else if(t.objectIds!=null&&h&&h.length>0){const E=t.objectIds;t.objectIds=h.filter(g=>E.includes(g))}else if(t.objectIds!=null)h=t.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(r.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name)?.members?.size<1))return t.objectIds=[],[];t.objectIds=h}if(t.outFields!=null){const E=t.outFields;E.includes("*")?r.fields.forEach(g=>{a.add(g.name)}):E.forEach(g=>{g!==x&&g!==r.geometryFieldName&&a.add(g)})}if(t.geometry!=null){const E=t.geometry;let g;const T=r.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,M=T?.spatialReference,S=T?.serviceCapabilities?.geometryCapabilities;let m=S?.geometryMaxBoundingRectangleSizeX,I=S?.geometryMaxBoundingRectangleSizeY;if(E?.extent?.spatialReference&&!E.spatialReference?.isWGS84?(await Pt(E.extent.spatialReference,fe),g=Be(E.extent,fe)):g=E.extent,m&&I&&M){if(M.wkid!==4326){const L=new we({spatialReference:M,xmax:m,ymax:I}),p=Be(L,fe);m=p.xmax,I=p.ymax}if(g.xmax-g.xmin>m)throw new w("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${m}° latitude, limit exceeded`);if(g.ymax-g.ymin>I)throw new w("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${I}° longitude, limit exceeded`)}if(t.where!=null&&t.where!=="1=1"){const L=await gt(t.where.toUpperCase(),r.fieldsIndex);r.fields.forEach(p=>{L.fieldNames.includes(p.name)&&a.add(p.name)})}c=y?`Match ()-[n:${r.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${r.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n)`,r.geometryFieldName&&a.add(r.geometryFieldName),a.forEach(L=>{c+=`, n.${L}`,s.push(L)}),d=new ye({openCypherQuery:c,bindParameters:{param_filter_geom:new _e({rings:si(g)})}})}else{let E="";if(t.where!=null&&t.where!=="1=1"){const M=await gt(t.where,r.fieldsIndex);r.fields.forEach(p=>{M.fieldNames.includes(p.name)&&a.add(p.name)});const S=new Set(["column-reference","string","number","binary-expression"]),m=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let I=!1;const L=p=>{if(p.type==="column-reference")return`n.${p.column}`;if(p.type==="string")return`'${p.value}'`;if(p.type==="number")return`${p.value}`;if(p.type==="binary-expression"&&S.has(p.left.type)&&S.has(p.right.type)&&m.has(p.operator))return`${L(p.left)} ${p.operator} ${L(p.right)}`;if(p.type==="binary-expression"&&p.operator==="LIKE"){let k="";if(p.left.type==="function"&&p.left.args.value[0].type==="column-reference")k+=`lower(n.${p.left.args.value[0].column})`;else{if(p.left.type!=="column-reference")return I=!0,"";k+=`lower(n.${p.left.column})`}if(k+=" CONTAINS (",p.right.type!=="string")return I=!0,"";{let f=p.right.value;f.charAt(0)==="%"&&(f=f.slice(1)),f.charAt(f.length-1)==="%"&&(f=f.slice(0,-1)),k+=`'${f.toLowerCase()}')`}return k}return I=!0,""};E=L(M.parseTree),I&&(E="")}let g="";g=y?`Match ()-[n:${r.objectType.name}]->()`:`Match (n:${r.objectType.name})`;let T=!1;h&&(T=!0,g+=" WHERE ID(n) IN $ids"),E&&(g+=T?" AND":" WHERE",g+=` ${E}`),g+=" return ID(n)",y&&(g+=", id(startNode(n)), id(endNode(n))"),t.returnGeometry&&r.geometryFieldName&&a.add(r.geometryFieldName),a.forEach(M=>{g+=`, n.${M}`,s.push(M)}),d=new ye(h?{openCypherQuery:g,bindParameters:{ids:h}}:{openCypherQuery:g})}const C=(await ve(r.parentCompositeLayer.dataManager.knowledgeGraph,d,i)).resultRowsStream.getReader();for(;;){const{done:E,value:g}=await C.read();if(E)break;const T=[];for(let M=0;M<g.length;M++){const S=g[M];let m=0,I=0;const L={properties:{}};for(L.id=S[m],m++,I++,y&&(L.originId=S[m],m++,I++,L.destinationId=S[m],m++,I++);m<S.length;m++)L.properties[s[m-I]]=S[m];T.push(L)}u=u.concat(n.writeToStore(T,x,r.parentCompositeLayer.dataManager.geographicLookup.get(r.objectType.name)?.name))}return u}};o([l()],Q.prototype,"knowledgeGraph",void 0),o([l()],Q.prototype,"inclusionModeDefinition",void 0),o([l()],Q.prototype,"entityTypeNames",void 0),o([l()],Q.prototype,"relationshipTypeNames",void 0),o([l()],Q.prototype,"geographicLookup",void 0),o([l()],Q.prototype,"sublayerCaches",void 0),o([l()],Q.prototype,"nodeConnectionsLookup",void 0),o([l()],Q.prototype,"memberIdTypeLookup",void 0),Q=o([v("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],Q);const vt=or(),pi=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return o([l(vt.fields)],t.prototype,"fields",void 0),o([l(vt.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=o([v("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};let D=class extends sr(pi(Ot(jt(lr(At))))){constructor(e){if(super(e),this.capabilities=pr(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=x,this.objectType=null,this.parentCompositeLayer=null,this.popupTemplate=null,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new dr(t.port1,{channel:t,client:{queryFeatures:(r,i={})=>{const n=ne.fromJSON(r);return this.queryFeaturesJSON(n,i)}}}),[t.port2]})},this.type="knowledge-graph-sublayer",e.parentCompositeLayer.type==="link-chart")e.graphType==="relationship"?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=R;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType!=="esriGeometryNull"){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?re.fromJSON(t.geometryType):null;const r=t?.name,i=r?e.objectType.properties?.[r]:null;i?(this.hasM=i.hasM??!1,this.hasZ=i.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach(t=>{let r=null,i=t.fieldType;i==="esriFieldTypeOID"&&(i="esriFieldTypeInteger"),this.fields.push(_t.fromJSON({name:t.name,type:i,alias:t.alias,defaultValue:r,editable:t.editable,nullable:t.nullable}))}),this.fields.push(_t.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),e.parentCompositeLayer.type==="link-chart"?e.graphType==="relationship"?this.renderer=$e(Fe(re.toJSON("polyline")).renderer):this.renderer=$e(Fe(re.toJSON("point")).renderer):this.renderer=$e(Fe(re.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){ur(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return hr(this,e)}createQuery(){return new ne({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];throw new Error("Field not found")}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(e),n=cr.fromJSON(await i.executeQuery(r.toJSON(),t?.signal));return n.features.forEach(a=>{a.sourceLayer=this}),n}async queryFeaturesJSON(e,t){const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(r.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(r.toJSON(),t?.signal)}async queryExtent(e={},t){const r={...e,returnGeometry:!0},{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(r),a=await n.executeQueryForExtent(i.toJSON(),t?.signal);let s;return s=a.extent?.xmin!=null&&a.extent?.xmax!=null&&a.extent?.ymin!=null&&a.extent?.ymax!=null?new we(a.extent):new we,{count:a.count,extent:s}}async queryObjectIds(e,t){const r=ne.from(e);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const n=await this.parentCompositeLayer.dataManager.getData(r,this,t);i=this.loadQueryEngine(n)}return i.executeQueryForIds(r.toJSON(),t?.signal)}loadQueryEngine(e){const t=new gr({geometryType:re.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new wr({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:re.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new ne({where:"1=1",outFields:[x]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const r=ne.from(e),i=r.geometry;let n;if(i&&!i.spatialReference?.isWGS84&&(await Pt(i.spatialReference,fe),r.geometry=Be(i instanceof _e||i instanceof te?i:i.extent,fe)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const a=await this.parentCompositeLayer.dataManager.getData(r,this,t);n=this.loadQueryEngine(a)}return{resolvedQuery:r,queryEngine:n}}};o([l()],D.prototype,"capabilities",void 0),o([l({readOnly:!0})],D.prototype,"defaultPopupTemplate",null),o([l()],D.prototype,"definitionExpression",void 0),o([l()],D.prototype,"displayField",void 0),o([l()],D.prototype,"elevationInfo",void 0),o([l()],D.prototype,"geometryType",void 0),o([l()],D.prototype,"geometryFieldName",void 0),o([l()],D.prototype,"graphType",void 0),o([l()],D.prototype,"hasM",void 0),o([l()],D.prototype,"hasZ",void 0),o([l()],D.prototype,"labelsVisible",void 0),o([l()],D.prototype,"labelingInfo",void 0),o([l()],D.prototype,"objectIdField",void 0),o([l()],D.prototype,"objectType",void 0),o([l()],D.prototype,"parentCompositeLayer",void 0),o([l({type:yr,json:{name:"popupInfo",write:!0}})],D.prototype,"popupTemplate",void 0),o([l({types:mr,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],D.prototype,"renderer",null),o([l()],D.prototype,"source",void 0),o([l({json:{read:!1}})],D.prototype,"type",void 0),D=o([v("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],D);const Ue=D;let qe,P=null;function di(){return qe||(qe=He(()=>import("./chunk-f7ubnbXl.js"),__vite__mapDeps([5,1,2,3])).then(e=>e.l).then(({default:e})=>e({locateFile:t=>Ye(`esri/libs/linkchartlayout/${t}`)})).then(e=>{ui(e)}),qe)}function ui(e){P=e}var U;function ie(e,t,r,i,n,a){const s=r.length,d=n.length,c=Float64Array.BYTES_PER_ELEMENT,u=Uint32Array.BYTES_PER_ELEMENT,y=Uint8Array.BYTES_PER_ELEMENT,b=16,_=b-1+s*(y+2*c)+d*(2*u),h=P._malloc(_);try{const C=h+b-h%b,E=C+s*c,g=E+s*c,T=g+d*u,M=T+d*u,S=()=>[P.HEAPF64.subarray(C>>3,(C>>3)+s),P.HEAPF64.subarray(E>>3,(E>>3)+s),P.HEAPU32.subarray(g>>2,(g>>2)+d),P.HEAPU32.subarray(T>>2,(T>>2)+d),P.HEAPU8.subarray(M,M+s)],[m,I,L,p,k]=S();m.set(r),I.set(i),L.set(n),p.set(a),k.set(t);const f=e(s,M,C,E,d,g,T),[O,F,q,z,rr]=S();return r.set(O),i.set(F),n.set(q),a.set(z),t.set(rr),f}finally{P._free(h)}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(U||(U={}));const Dt=2,Gt=1,Rt=-1;var tt,rt,it,nt,at,ot,St,Nt;(function(e){function t(){return P.getMinIdealEdgeLength()}function r(i,n,a,s,d,c=Dt,u=Gt,y=Rt){return ie((b,_,h,C,E,g,T)=>P.applyForceDirectedLayout(b,_,h,C,E,g,T,c,u,y),i,n,a,s,d)}e.getMinIdealEdgeLength=t,e.apply=r})(tt||(tt={})),function(e){function t(r,i,n,a,s,d=Dt,c=Gt,u=Rt){return ie((y,b,_,h,C,E,g)=>P.applyCommunityLayout(y,b,_,h,C,E,g,d,c,u),r,i,n,a,s)}e.apply=t}(rt||(rt={})),function(e){function t(r,i,n,a,s){return ie(P.applySimpleLayout,r,i,n,a,s)}e.apply=t}(it||(it={})),function(e){function t(r,i,n,a,s){return ie(P.applyHierarchicalLayout,r,i,n,a,s)}e.apply=t}(nt||(nt={})),function(e){function t(r,i,n,a,s){return ie(P.applyRadialTreeLayout,r,i,n,a,s)}e.apply=t}(at||(at={})),function(e){function t(r,i,n,a,s){return ie(P.applySmartTreeLayout,r,i,n,a,s)}e.apply=t}(ot||(ot={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(St||(St={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Nt||(Nt={}));const hi=(e,t,r)=>(e.has(t)||e.set(t,r()),e.get(t));let $=class extends Ot(jt(At)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE",xScaleFactor:1,yScaleFactor:1},this._graphTypeLookup=new Map,this.knowledgeGraph=null,this.layers=new bt,this.linkChartDiagramLookup=new Map,this.linkChartExtent=new we({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new bt,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new w("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const a=this.url.split("/");this.title=a[a.length-2]}const t=new Set;let r=[],i=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new w("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&this._graphTypeLookup.set(a.name,a)}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&this._graphTypeLookup.set(a.name,a)}),e.inclusionModeDefinition?.generateAllSublayers?(r=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((a,s)=>{if(!this._graphTypeLookup.get(s))return pe.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this._graphTypeLookup.get(s)instanceof pt||"strictOrigin"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),i.push(this._graphTypeLookup.get(s))):this._graphTypeLookup.get(s)instanceof lt||"properties"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),r.push(this._graphTypeLookup.get(s))):(pe.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))}):(r=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]);const n=new Q({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=r,this.memberRelationshipTypes=i,this.dataManager=n}load(e){return this.addResolvingPromise(new Promise(t=>{Xr(this.url).then(r=>{if(this._initializeLayerProperties({knowledgeGraph:r,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(i=>{i.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(i.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(i=>{i.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(i.name,{useAllData:!0})})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(i=>{i.useAllData=!1,i.members?.forEach(n=>{let a;a=n.linkChartLocation instanceof Tt?n.linkChartLocation:n.linkChartLocation?W(n.linkChartLocation):null,this.linkChartDiagramLookup.set(n.id,a),a&&a.coords.length===2&&a.lengths.length===0?this.linkChartGeohashLookup.set(n.id,Z(a.coords[1],a.coords[0],ee)):this.linkChartGeohashLookup.set(n.id,"")}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async n=>{await n.refreshCachedQueryEngine()}),this.tables.forEach(async n=>{await n.refreshCachedQueryEngine()})}))});else{const i=this.defaultLinkChartConfig?.layoutMode==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,i,!0).then(async()=>{fr(e);const n=[],a=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(s=>{s.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(s=>{a.push(s.refreshCachedQueryEngine()),n.push(new Promise(d=>{s.on("layerview-create",()=>{d(null)})}))}),this.tables.forEach(s=>{a.push(s.refreshCachedQueryEngine())}),await Promise.all(a)}))}t(null)})})),Promise.resolve(this)}async addRecords(e,t){let r=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(r=await li(e,this.dataManager.knowledgeGraph));const i=e.concat(r).filter(n=>!this.sublayerIdsCache.get(n.typeName)?.has(n.id));await this._handleNewRecords(i)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:r=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let i=[];for(const a of e)this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(a.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(a.typeName)?.members?.has(a.id)&&i.push(a);if(t){const a=new Set,s=[];for(const d of i)if(this.dataManager.nodeConnectionsLookup.has(d.id))for(const c of this.dataManager.nodeConnectionsLookup.get(d.id))a.add(c);for(const d of a)this.dataManager.memberIdTypeLookup.has(d)&&s.push({id:d,typeName:this.dataManager.memberIdTypeLookup.get(d)});i=i.concat(s)}this.dataManager.removeFromLayer(i);for(const a of i)this.sublayerIdsCache.get(a.typeName)?.delete(a.id),this.linkChartDiagramLookup.delete(a.id);r&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor});const n=[];return this.layers.forEach(a=>{n.push(a.refreshCachedQueryEngine())}),await Promise.all(n),this._refreshNamedTypes(),i}async expand(e){const t=await this.dataManager.getConnectedRecordIds(e),r=t.filter(i=>!this.sublayerIdsCache.get(i.typeName)?.has(i.id));return await this._handleNewRecords(t),{records:r}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach(e=>{const t=new Ue({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.memberEntityTypes.forEach(e=>{const t=new Ue({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{const r=hi(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(i=>{if(r.add(i.id),i.linkChartLocation)if(i.linkChartLocation instanceof Tt)this.linkChartDiagramLookup.set(i.id,i.linkChartLocation),i.linkChartLocation.coords.length===2&&i.linkChartLocation.lengths.length===0?this.linkChartGeohashLookup.set(i.id,Z(i.linkChartLocation.coords[1],i.linkChartLocation.coords[0],ee)):this.linkChartGeohashLookup.set(i.id,"");else{const n=W(i.linkChartLocation);this.linkChartDiagramLookup.set(i.id,i.linkChartLocation?n:null),"x"in i.linkChartLocation&&"y"in i.linkChartLocation?this.linkChartGeohashLookup.set(i.id,Z(i.linkChartLocation.x,i.linkChartLocation.y,ee)):this.linkChartGeohashLookup.set(i.id,"")}})})}async calculateLinkChartLayout(e="RADIAL_TREE",t){const r=[],i=[];this.dataManager.sublayerCaches.forEach((p,k)=>{this.dataManager.entityTypeNames.has(k)?p.forEach(f=>{r.push({typeName:k,feature:f})}):this.dataManager.relationshipTypeNames.has(k)&&p.forEach(f=>{i.push({typeName:k,feature:f})})}),this.linkChartDiagramLookup=new Map;const n=new Map,a=new Map,s=new Map,d=new Map,c=new Uint8Array(r.length),u=new Float64Array(r.length),y=new Float64Array(r.length),b=new Uint32Array(i.length),_=new Uint32Array(i.length),h=[],C="FORCE_DIRECTED",E=t?.xScaleFactor??1,g=t?.yScaleFactor??1,T=new we({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let M,S="FORCE_DIRECTED",m=0,I=0;switch(S=e==="GEOGRAPHIC"?C:e,S){case"FORCE_DIRECTED":M=tt.apply;break;case"COMMUNITY":M=rt.apply;break;case"HIERARCHICAL":M=nt.apply;break;case"RADIAL_TREE":M=at.apply;break;case"SMART_TREE":M=ot.apply;break;default:M=it.apply}r.forEach(({typeName:p,feature:k})=>{if(t?.lockedNodeLocations?.has(k.attributes[x])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(p)?c[m]=U.IsGeographic:c[m]=U.None;const f=t.lockedNodeLocations.get(k.attributes[x]);u[m]=f.x,y[m]=f.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(p)){c[m]=U.IsGeographic;let f=null;const O=k.attributes[this.dataManager.geographicLookup.get(p).name];switch(this.dataManager.geographicLookup.get(p)?.geometryType){case"esriGeometryPoint":u[m]=O?.x,y[m]=O?.y;break;case"esriGeometryPolygon":f=O?.centroid,f?.x!=null&&f?.y!=null?(u[m]=f.x,y[m]=f.y):c[m]=U.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":f=O?.extent?.center,f?.x!=null&&f?.y!=null?(u[m]=f.x,y[m]=f.y):c[m]=U.IsMovable;break;default:c[m]=U.IsMovable}(u[m]==null||y[m]==null||Number.isNaN(u[m])||Number.isNaN(y[m]))&&(c[m]=U.IsMovable,u[m]=0,y[m]=0)}else c[m]=U.IsMovable,u[m]=0,y[m]=0;d.set(k.attributes[x],m),h[m]={feature:k,typeName:p},m++});let L=!1;if(i.forEach(p=>{const k=d.get(p.feature.attributes[he]),f=d.get(p.feature.attributes[Qe]);k!==void 0&&f!==void 0?(b[I]=k,_[I]=f,I++):(L=!0,this.linkChartDiagramLookup.set(p.feature.attributes[he],null),this.linkChartGeohashLookup.set(p.feature.attributes[he],null))}),L&&pe.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await di(),!M(c,u,y,b,_))throw new w("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let p=0;p<h.length;p++){if(c[p]===U.IsMovable&&(u[p]=u[p]*E,y[p]=y[p]*g),y[p]>84.9999&&(y[p]=84.9999),y[p]<-84.9999&&(y[p]=-84.9999),u[p]>179.9999&&(u[p]=179.9999),u[p]<-179.9999&&(u[p]=-179.9999),h[p].feature.attributes[R]=new ge(u[p],y[p]),n.has(h[p].typeName))n.get(h[p].typeName)?.set(h[p].feature.attributes[x],h[p].feature);else{const f=new Map;f.set(h[p].feature.attributes[x],h[p].feature),n.set(h[p].typeName,f)}s.set(h[p].feature.attributes[x],h[p].feature);const k=W(h[p].feature.attributes[R]);this.linkChartDiagramLookup.set(h[p].feature.attributes[x],h[p].feature.attributes[R]?k:null),this.linkChartGeohashLookup.set(h[p].feature.attributes[x],Z(h[p].feature.attributes[R].y,h[p].feature.attributes[R].x,ee)),h[p].feature.attributes[R].x<T.xmin&&(T.xmin=h[p].feature.attributes[R].x),h[p].feature.attributes[R].x>T.xmax&&(T.xmax=h[p].feature.attributes[R].x),h[p].feature.attributes[R].y<T.ymin&&(T.ymin=h[p].feature.attributes[R].y),h[p].feature.attributes[R].y>T.ymax&&(T.ymax=h[p].feature.attributes[R].y)}return this.linkChartExtent.xmin=T.xmin,this.linkChartExtent.xmax=T.xmax,this.linkChartExtent.ymin=T.ymin,this.linkChartExtent.ymax=T.ymax,i.forEach(p=>{const k=h[d.get(p.feature.attributes[he])]?.feature.attributes[R],f=h[d.get(p.feature.attributes[Qe])]?.feature.attributes[R];if(!k||!f)return;const O=new te({paths:[[k.x,k.y],[f.x,f.y]]});if(p.feature.attributes[R]=O,a.has(p.typeName))a.get(p.typeName)?.set(p.feature.attributes[x],p.feature);else{const q=new Map;q.set(p.feature.attributes[x],p.feature),a.set(p.typeName,q)}s.set(p.feature.attributes[x],p.feature);const F=W(p.feature.attributes[R]);this.linkChartDiagramLookup.set(p.feature.attributes[x],p.feature.attributes[R]?F:null),this.linkChartGeohashLookup.set(p.feature.attributes[x],"")}),this._currentLinkChartConfig={layoutMode:e,xScaleFactor:E,yScaleFactor:g},{nodes:n,links:a,idMap:s}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const r=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach(i=>{r.push(i.refreshCachedQueryEngine())}),await Promise.all(r),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(t=>{t?.members?.forEach(r=>{const i=r.linkChartLocation;let n;const a=r.id;i&&(n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(a,new ge({x:n.x,y:n.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((t,r)=>{if(t.useAllData=!1,t.members&&t.members.size>0){if(!this.dataManager.sublayerCaches.get(r))return;const i=new Set(Array.from(this.dataManager.sublayerCaches.get(r).keys()));Array.from(t.members.keys()).filter(n=>!i.has(n)).forEach(n=>{t.members?.delete(n)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach(r=>{t.push(r.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const r of e)this.sublayerIdsCache.has(r.typeName)||(this.sublayerIdsCache.set(r.typeName,new Set),t.push(r.typeName)),this.sublayerIdsCache.get(r.typeName).add(r.id);for(const r of t)if(this._graphTypeLookup.has(r)){const i=this._graphTypeLookup.get(r),n="endPoints"in i?"relationship":"entity",a=new Ue({objectType:i,parentCompositeLayer:this,graphType:n,title:r});n==="entity"?this.dataManager.entityTypeNames.add(r):this.dataManager.relationshipTypeNames.add(r),a.geometryType?this.layers.push(a):this.tables.push(a),this.dataManager.sublayerCaches.set(r,new Map)}await this.dataManager.refreshCacheContent(e.map(r=>r.id)),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor})}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(e=>{e?.members?.forEach(t=>{const r=t.linkChartLocation;let i;const n=t.id;if(!r)return;i="x"in r?{x:r.x,y:r.y}:{x:r.coords[0],y:r.coords[1]};const a=W(i);this.linkChartDiagramLookup.set(n,a),this.linkChartGeohashLookup.set(n,Z(i.x,i.y,ee)),this.linkChartExtent.xmin>i.x&&(this.linkChartExtent.xmin=i.x),this.linkChartExtent.xmax<i.x&&(this.linkChartExtent.xmax=i.x),this.linkChartExtent.ymin>i.y&&(this.linkChartExtent.ymin=i.y),this.linkChartExtent.ymax<i.y&&(this.linkChartExtent.ymax=i.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(t=>{const r=this.linkChartDiagramLookup.get(t.attributes[he]),i=this.linkChartDiagramLookup.get(t.attributes[Qe]);if(r&&i){const n=W(new te({paths:[[r.coords[0],r.coords[1]],[i.coords[0],i.coords[1]]]}));this.linkChartDiagramLookup.set(t.attributes[x],n)}else this.linkChartDiagramLookup.set(t.attributes[x],null);this.linkChartGeohashLookup.set(t.attributes[x],"")})})):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};o([l()],$.prototype,"dataPreloadedInLocalCache",void 0),o([l()],$.prototype,"defaultLinkChartConfig",void 0),o([l()],$.prototype,"dataManager",void 0),o([l()],$.prototype,"knowledgeGraph",void 0),o([l()],$.prototype,"layers",void 0),o([l()],$.prototype,"linkChartDiagramLookup",void 0),o([l()],$.prototype,"linkChartExtent",void 0),o([l()],$.prototype,"linkChartGeohashLookup",void 0),o([l()],$.prototype,"memberEntityTypes",void 0),o([l()],$.prototype,"memberRelationshipTypes",void 0),o([l()],$.prototype,"sublayerIdsCache",void 0),o([l()],$.prototype,"tables",void 0),o([l({json:{read:!1}})],$.prototype,"type",void 0),$=o([v("esri.layers.LinkChartLayer")],$);const Hi=$;export{Hi as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/chunks/chunk-WFXsWejX.js","assets/chunks/chunk-AGUgPSYp.js","assets/chunks/chunk-oVLQlo07.js","assets/static/EdgeShader.1pVPqqV3.css","assets/chunks/chunk-z2P5Qf-e.js","assets/chunks/chunk-f7ubnbXl.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
